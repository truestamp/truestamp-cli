import { colors, decode, sleep, validate } from "./deps.ts";
import { deleteConfigKeyForEnv, getConfigKeyForEnv, setConfigKeyForEnv, } from "./config.ts";
const AUTH0_SCOPES = "openid profile email offline_access";
const AUTH0_DOMAIN_DEVELOPMENT = "truestamp-dev.auth0.com";
const AUTH0_AUDIENCE_DEVELOPMENT = "https://db.fauna.com/db/ytijhfregydfy";
const AUTH0_CLIENT_ID_DEVELOPMENT = "8djbT1Ys078OZImR1uRr4jhu2Wb6d05B";
const AUTH0_DOMAIN_STAGING = "truestamp-staging.auth0.com";
const AUTH0_AUDIENCE_STAGING = "https://db.fauna.com/db/ytijhdrceybfy";
const AUTH0_CLIENT_ID_STAGING = "T0dzxGnnIj3TU0HpzCQRTZ5fx9N5Hb5m";
const AUTH0_DOMAIN_PRODUCTION = "login.truestamp.com";
const AUTH0_AUDIENCE_PRODUCTION = "https://db.fauna.com/db/ytij595b6yffy";
const AUTH0_CLIENT_ID_PRODUCTION = "pS5kRvqeuz4XLoxNPd6VX2LlUyNyU7Xj";
function getAuth0DomainForEnv(env) {
    switch (env) {
        case "development":
            return AUTH0_DOMAIN_DEVELOPMENT;
        case "staging":
            return AUTH0_DOMAIN_STAGING;
        case "production":
            return AUTH0_DOMAIN_PRODUCTION;
        default:
            throw new Error(`invalid environment : '${env}'`);
    }
}
function getAuth0AudienceForEnv(env) {
    switch (env) {
        case "development":
            return AUTH0_AUDIENCE_DEVELOPMENT;
        case "staging":
            return AUTH0_AUDIENCE_STAGING;
        case "production":
            return AUTH0_AUDIENCE_PRODUCTION;
        default:
            throw new Error(`invalid environment : '${env}'`);
    }
}
function getAuth0ClientIdForEnv(env) {
    switch (env) {
        case "development":
            return AUTH0_CLIENT_ID_DEVELOPMENT;
        case "staging":
            return AUTH0_CLIENT_ID_STAGING;
        case "production":
            return AUTH0_CLIENT_ID_PRODUCTION;
        default:
            throw new Error(`invalid environment : '${env}'`);
    }
}
async function getDeviceCode(env) {
    const resp = await fetch(`https://${getAuth0DomainForEnv(env)}/oauth/device/code`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            client_id: getAuth0ClientIdForEnv(env),
            audience: getAuth0AudienceForEnv(env),
            scope: AUTH0_SCOPES,
        }),
    });
    return resp.json();
}
async function callTokenEndpoint(env, deviceCode) {
    const resp = await fetch(`https://${getAuth0DomainForEnv(env)}/oauth/token`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            client_id: getAuth0ClientIdForEnv(env),
            device_code: deviceCode,
            grant_type: "urn:ietf:params:oauth:grant-type:device_code",
        }),
    });
    return resp;
}
async function getTokens(env, deviceCode, interval) {
    let adjustedInterval = interval;
    while (true) {
        await sleep(adjustedInterval);
        const resp = await callTokenEndpoint(env, deviceCode);
        if (resp.ok) {
            return await resp.json();
        }
        if (!resp.ok) {
            const respJson = await resp.json();
            switch (respJson.error) {
                case "authorization_pending":
                    break;
                case "slow_down":
                    adjustedInterval += 1;
                    break;
                case "expired_token":
                    throw new Error(`expired token`);
                case "access_denied":
                    throw new Error(`access denied`);
                default:
                    throw new Error(`unknown error response : ${JSON.stringify(respJson)}`);
            }
        }
    }
}
async function getNewTokensWithRefreshToken(env) {
    const refreshToken = getConfigRefreshToken(env);
    if (refreshToken) {
        const resp = await fetch(`https://${getAuth0DomainForEnv(env)}/oauth/token`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                grant_type: "refresh_token",
                client_id: getAuth0ClientIdForEnv(env),
                refresh_token: refreshToken,
            }),
        });
        return await resp.json();
    }
}
export function getConfigAccessToken(env) {
    const t = getConfigKeyForEnv(env, "auth0_access_token");
    return t ? t : undefined;
}
export function getConfigRefreshToken(env) {
    const t = getConfigKeyForEnv(env, "auth0_refresh_token");
    return t ? t : undefined;
}
export function getConfigIdTokenPayload(env) {
    let idToken;
    try {
        idToken = getConfigKeyForEnv(env, "auth0_id_token");
    }
    catch (error) {
        throw new Error(`no id token found in config : ${error.message}`);
    }
    if (!idToken) {
        throw new Error(`missing id token`);
    }
    try {
        const { payload } = validate(decode(idToken));
        return payload;
    }
    catch (error) {
        throw new Error(`invalid id token : ${error.message}`);
    }
}
function setTokensInConfig(env, tokens) {
    try {
        if (tokens.refresh_token)
            setConfigKeyForEnv(env, "auth0_refresh_token", tokens.refresh_token);
        setConfigKeyForEnv(env, "auth0_access_token", tokens.access_token);
        setConfigKeyForEnv(env, "auth0_expires_in", tokens.expires_in);
        setConfigKeyForEnv(env, "auth0_scope", tokens.scope);
        setConfigKeyForEnv(env, "auth0_token_type", tokens.token_type);
        if (tokens.id_token) {
            setConfigKeyForEnv(env, "auth0_id_token", tokens.id_token);
        }
    }
    catch (error) {
        throw new Error(`unable to write tokens to config : ${error.message}`);
    }
}
export function deleteTokensInConfig(env) {
    deleteConfigKeyForEnv(env, "auth0_refresh_token");
    deleteConfigKeyForEnv(env, "auth0_access_token");
    deleteConfigKeyForEnv(env, "auth0_expires_in");
    deleteConfigKeyForEnv(env, "auth0_scope");
    deleteConfigKeyForEnv(env, "auth0_token_type");
    deleteConfigKeyForEnv(env, "auth0_id_token");
}
export async function getAccessTokenWithPrompts(env) {
    let deviceCodeResp;
    try {
        const accessToken = getConfigAccessToken(env);
        if (accessToken) {
            try {
                const { header, payload, signature } = validate(decode(accessToken));
                if (header && payload && signature) {
                    return new Promise((resolve) => {
                        resolve(accessToken);
                    });
                }
            }
            catch {
                const tokens = await getNewTokensWithRefreshToken(env);
                if (tokens) {
                    setTokensInConfig(env, tokens);
                    if (tokens.access_token) {
                        return new Promise((resolve) => {
                            resolve(tokens.access_token);
                        });
                    }
                }
                else {
                    deleteTokensInConfig(env);
                }
            }
        }
    }
    catch (error) {
        console.error(colors.bold.red(`${error.message} error : exiting`));
        Deno.exit(1);
    }
    try {
        deviceCodeResp = await getDeviceCode(env);
    }
    catch (error) {
        console.error(colors.bold.red(`${error.message} error : exiting`));
        Deno.exit(1);
    }
    if (deviceCodeResp && deviceCodeResp.verification_uri_complete) {
        console.log(colors.bold.yellow.underline(`\nAUTHENTICATION\n`));
        console.log(colors.bold.yellow(`Please authenticate yourself by visiting\nthe following URL in a browser:\n`));
        console.log(colors.bold.underline.blue(deviceCodeResp.verification_uri_complete));
        console.log("");
    }
    else {
        console.error(colors.bold.red(`no verification URI error : exiting`));
        Deno.exit(1);
    }
    try {
        const tokens = await getTokens(env, deviceCodeResp.device_code, deviceCodeResp.interval);
        if (!tokens || !tokens.access_token) {
            throw new Error("retrieval of access tokens failed");
        }
        setTokensInConfig(env, tokens);
        return new Promise((resolve) => {
            resolve(tokens.access_token);
        });
    }
    catch (error) {
        console.error(colors.bold.red(`${error.message} error : exiting`));
        Deno.exit(1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImF1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQVcsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVyRSxPQUFPLEVBQ0wscUJBQXFCLEVBQ3JCLGtCQUFrQixFQUNsQixrQkFBa0IsR0FDbkIsTUFBTSxhQUFhLENBQUM7QUFFckIsTUFBTSxZQUFZLEdBQUcscUNBQXFDLENBQUM7QUFFM0QsTUFBTSx3QkFBd0IsR0FBRyx5QkFBeUIsQ0FBQztBQUMzRCxNQUFNLDBCQUEwQixHQUFHLHVDQUF1QyxDQUFDO0FBQzNFLE1BQU0sMkJBQTJCLEdBQUcsa0NBQWtDLENBQUM7QUFFdkUsTUFBTSxvQkFBb0IsR0FBRyw2QkFBNkIsQ0FBQztBQUMzRCxNQUFNLHNCQUFzQixHQUFHLHVDQUF1QyxDQUFDO0FBQ3ZFLE1BQU0sdUJBQXVCLEdBQUcsa0NBQWtDLENBQUM7QUFFbkUsTUFBTSx1QkFBdUIsR0FBRyxxQkFBcUIsQ0FBQztBQUN0RCxNQUFNLHlCQUF5QixHQUFHLHVDQUF1QyxDQUFDO0FBQzFFLE1BQU0sMEJBQTBCLEdBQUcsa0NBQWtDLENBQUM7QUFFdEUsU0FBUyxvQkFBb0IsQ0FBQyxHQUFXO0lBQ3ZDLFFBQVEsR0FBRyxFQUFFO1FBQ1gsS0FBSyxhQUFhO1lBQ2hCLE9BQU8sd0JBQXdCLENBQUM7UUFFbEMsS0FBSyxTQUFTO1lBQ1osT0FBTyxvQkFBb0IsQ0FBQztRQUU5QixLQUFLLFlBQVk7WUFDZixPQUFPLHVCQUF1QixDQUFDO1FBRWpDO1lBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsR0FBRyxHQUFHLENBQUMsQ0FBQztLQUNyRDtBQUNILENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLEdBQVc7SUFDekMsUUFBUSxHQUFHLEVBQUU7UUFDWCxLQUFLLGFBQWE7WUFDaEIsT0FBTywwQkFBMEIsQ0FB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QyxjQUFjLENBQUMseUJBQXlCLENBQUMsQ0FDckUsQ0FBQztRQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDakI7U0FBTTtRQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMscUNBQXFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDZDtJQUVELElBQUk7UUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FDNUIsR0FBRyxFQUNILGNBQWMsQ0FBQyxXQUFXLEVBQzFCLGNBQWMsQ0FBQyxRQUFRLENBQ3hCLENBQUM7UUFFRixJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRTtZQUNuQyxNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7U0FDdEQ7UUFFRCxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFL0IsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQzdCLE9BQU8sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7S0FDSjtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxPQUFPLGtCQUFrQixDQUFDLENBQUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2Q7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IMKpIDIwMjAtMjAyMiBUcnVlc3RhbXAgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuXG4vLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS90cnVlc3RhbXAvZGV2aWNlZmxvd1xuLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vamF0aW52YWlkeWEvY2xpLWF1dGh6LWRldmljZS1mbG93L2Jsb2IvbWFzdGVyL2RldmljZS9kZXZpY2UuanNcblxuLy8gT24gTWFjT1MgdGhlIGNvbmZpZyBmaWxlcyBjYW4gYmUgZm91bmQgaW4gYSBsb2NhdGlvbiBsaWtlOlxuLy8gY2F0IH4vTGlicmFyeS9QcmVmZXJlbmNlcy9jb20udHJ1ZXN0YW1wLmNsaS5kZXZlbG9wbWVudC9jb25maWcuanNvblxuXG5pbXBvcnQgeyBjb2xvcnMsIGRlY29kZSwgUGF5bG9hZCwgc2xlZXAsIHZhbGlkYXRlIH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuXG5pbXBvcnQge1xuICBkZWxldGVDb25maWdLZXlGb3JFbnYsXG4gIGdldENvbmZpZ0tleUZvckVudixcbiAgc2V0Q29uZmlnS2V5Rm9yRW52LFxufSBmcm9tIFwiLi9jb25maWcudHNcIjtcblxuY29uc3QgQVVUSDBfU0NPUEVTID0gXCJvcGVuaWQgcHJvZmlsZSBlbWFpbCBvZmZsaW5lX2FjY2Vzc1wiO1xuXG5jb25zdCBBVVRIMF9ET01BSU5fREVWRUxPUE1FTlQgPSBcInRydWVzdGFtcC1kZXYuYXV0aDAuY29tXCI7XG5jb25zdCBBVVRIMF9BVURJRU5DRV9ERVZFTE9QTUVOVCA9IFwiaHR0cHM6Ly9kYi5mYXVuYS5jb20vZGIveXRpamhmcmVneWRmeVwiO1xuY29uc3QgQVVUSDBfQ0xJRU5UX0lEX0RFVkVMT1BNRU5UID0gXCI4ZGpiVDFZczA3OE9aSW1SMXVScjRqaHUyV2I2ZDA1QlwiO1xuXG5jb25zdCBBVVRIMF9ET01BSU5fU1RBR0lORyA9IFwidHJ1ZXN0YW1wLXN0YWdpbmcuYXV0aDAuY29tXCI7XG5jb25zdCBBVVRIMF9BVURJRU5DRV9TVEFHSU5HID0gXCJodHRwczovL2RiLmZhdW5hLmNvbS9kYi95dGlqaGRyY2V5YmZ5XCI7XG5jb25zdCBBVVRIMF9DTElFTlRfSURfU1RBR0lORyA9IFwiVDBkenhHbm5JajNUVTBIcHpDUVJUWjVmeDlONUhiNW1cIjtcblxuY29uc3QgQVVUSDBfRE9NQUlOX1BST0RVQ1RJT04gPSBcImxvZ2luLnRydWVzdGFtcC5jb21cIjtcbmNvbnN0IEFVVEgwX0FVRElFTkNFX1BST0RVQ1RJT04gPSBcImh0dHBzOi8vZGIuZmF1bmEuY29tL2RiL3l0aWo1OTViNnlmZnlcIjtcbmNvbnN0IEFVVEgwX0NMSUVOVF9JRF9QUk9EVUNUSU9OID0gXCJwUzVrUnZxZXV6NFhMb3hOUGQ2VlgyTGxVeU55VTdYalwiO1xuXG5mdW5jdGlvbiBnZXRBdXRoMERvbWFpbkZvckVudihlbnY6IHN0cmluZyk6IHN0cmluZyB7XG4gIHN3aXRjaCAoZW52KSB7XG4gICAgY2FzZSBcImRldmVsb3BtZW50XCI6XG4gICAgICByZXR1cm4gQVVUSDBfRE9NQUlOX0RFVkVMT1BNRU5UO1xuXG4gICAgY2FzZSBcInN0YWdpbmdcIjpcbiAgICAgIHJldHVybiBBVVRIMF9ET01BSU5fU1RBR0lORztcblxuICAgIGNhc2UgXCJwcm9kdWN0aW9uXCI6XG4gICAgICByZXR1cm4gQVVUSDBfRE9NQUlOX1BST0RVQ1RJT047XG5cbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGVudmlyb25tZW50IDogJyR7ZW52fSdgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRBdXRoMEF1ZGllbmNlRm9yRW52KGVudjogc3RyaW5nKTogc3RyaW5nIHtcbiAgc3dpdGNoIChlbnYpIHtcbiAgICBjYXNlIFwiZGV2ZWxvcG1lbnRcIjpcbiAgICAgIHJldHVybiBBVVRIMF9BVURJRU5DRV9ERVZFTE9QTUVOVDtcblxuICAgIGNhc2UgXCJzdGFnaW5nXCI6XG4gICAgICByZXR1cm4gQVVUSDBfQVVESUVOQ0VfU1RBR0lORztcblxuICAgIGNhc2UgXCJwcm9kdWN0aW9uXCI6XG4gICAgICByZXR1cm4gQVVUSDBfQVVESUVOQ0VfUFJPRFVDVElPTjtcblxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgZW52aXJvbm1lbnQgOiAnJHtlbnZ9J2ApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEF1dGgwQ2xpZW50SWRGb3JFbnYoZW52OiBzdHJpbmcpOiBzdHJpbmcge1xuICBzd2l0Y2ggKGVudikge1xuICAgIGNhc2UgXCJkZXZlbG9wbWVudFwiOlxuICAgICAgcmV0dXJuIEFVVEgwX0NMSUVOVF9JRF9ERVZFTE9QTUVOVDtcblxuICAgIGNhc2UgXCJzdGFnaW5nXCI6XG4gICAgICByZXR1cm4gQVVUSDBfQ0xJRU5UX0lEX1NUQUdJTkc7XG5cbiAgICBjYXNlIFwicHJvZHVjdGlvblwiOlxuICAgICAgcmV0dXJuIEFVVEgwX0NMSUVOVF9JRF9QUk9EVUNUSU9OO1xuXG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBlbnZpcm9ubWVudCA6ICcke2Vudn0nYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlQ29kZShlbnY6IHN0cmluZykge1xuICBjb25zdCByZXNwID0gYXdhaXQgZmV0Y2goXG4gICAgYGh0dHBzOi8vJHtnZXRBdXRoMERvbWFpbkZvckVudihlbnYpfS9vYXV0aC9kZXZpY2UvY29kZWAsXG4gICAge1xuICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBjbGllbnRfaWQ6IGdldEF1dGgwQ2xpZW50SWRGb3JFbnYoZW52KSxcbiAgICAgICAgYXVkaWVuY2U6IGdldEF1dGgwQXVkaWVuY2VGb3JFbnYoZW52KSxcbiAgICAgICAgc2NvcGU6IEFVVEgwX1NDT1BFUyxcbiAgICAgIH0pLFxuICAgIH0sXG4gICk7XG4gIHJldHVybiByZXNwLmpzb24oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2FsbFRva2VuRW5kcG9pbnQoXG4gIGVudjogc3RyaW5nLFxuICBkZXZpY2VDb2RlOiBzdHJpbmcsXG4pOiBQcm9taXNlPFJlc3BvbnNlPiB7XG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly8ke2dldEF1dGgwRG9tYWluRm9yRW52KGVudil9L29hdXRoL3Rva2VuYCwge1xuICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgaGVhZGVyczoge1xuICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgfSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBjbGllbnRfaWQ6IGdldEF1dGgwQ2xpZW50SWRGb3JFbnYoZW52KSxcbiAgICAgIGRldmljZV9jb2RlOiBkZXZpY2VDb2RlLFxuICAgICAgZ3JhbnRfdHlwZTogXCJ1cm46aWV0ZjpwYXJhbXM6b2F1dGg6Z3JhbnQtdHlwZTpkZXZpY2VfY29kZVwiLFxuICAgIH0pLFxuICB9KTtcbiAgcmV0dXJuIHJlc3A7XG59XG5cbi8vIEdldCB0aGUgd2hvbGUgdG9rZW4gcmVzcG9uc2Ugb2JqZWN0IGJ5IHBvbGxpbmcgdW50aWwgdGhlXG4vLyB1c2VyIGF1dGhlbnRpY2F0ZXMgb3IgZmFpbHMgYXQgZG9pbmcgc28uXG5hc3luYyBmdW5jdGlvbiBnZXRUb2tlbnMoZW52OiBzdHJpbmcsIGRldmljZUNvZGU6IHN0cmluZywgaW50ZXJ2YWw6IG51bWJlcikge1xuICBsZXQgYWRqdXN0ZWRJbnRlcnZhbCA9IGludGVydmFsO1xuXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgYXdhaXQgc2xlZXAoYWRqdXN0ZWRJbnRlcnZhbCk7XG4gICAgY29uc3QgcmVzcCA9IGF3YWl0IGNhbGxUb2tlbkVuZHBvaW50KGVudiwgZGV2aWNlQ29kZSk7XG5cbiAgICBpZiAocmVzcC5vaykge1xuICAgICAgcmV0dXJuIGF3YWl0IHJlc3AuanNvbigpO1xuICAgIH1cblxuICAgIGlmICghcmVzcC5vaykge1xuICAgICAgY29uc3QgcmVzcEpzb24gPSBhd2FpdCByZXNwLmpzb24oKTtcblxuICAgICAgc3dpdGNoIChyZXNwSnNvbi5lcnJvcikge1xuICAgICAgICBjYXNlIFwiYXV0aG9yaXphdGlvbl9wZW5kaW5nXCI6XG4gICAgICAgICAgLy8gY29uc29sZS5sb2coY29sb3JzLmJvbGQuZ3JheShcImF1dGhvcml6YXRpb24gcGVuZGluZy4uLlwiKSk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBcInNsb3dfZG93blwiOlxuICAgICAgICAgIC8vIGFkZCBhIHNlY29uZCB0byB0aGUgcG9sbGluZyBpbnRlcnZhbCBlYWNoIHRpbWUgcmVjZWl2ZWRcbiAgICAgICAgICBhZGp1c3RlZEludGVydmFsICs9IDE7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBcImV4cGlyZWRfdG9rZW5cIjpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGV4cGlyZWQgdG9rZW5gKTtcblxuICAgICAgICBjYXNlIFwiYWNjZXNzX2RlbmllZFwiOlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgYWNjZXNzIGRlbmllZGApO1xuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYHVua25vd24gZXJyb3IgcmVzcG9uc2UgOiAke0pTT04uc3RyaW5naWZ5KHJlc3BKc29uKX1gLFxuICAgICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5ld1Rva2Vuc1dpdGhSZWZyZXNoVG9rZW4oZW52OiBzdHJpbmcpIHtcbiAgY29uc3QgcmVmcmVzaFRva2VuID0gZ2V0Q29uZmlnUmVmcmVzaFRva2VuKGVudik7XG4gIGlmIChyZWZyZXNoVG9rZW4pIHtcbiAgICBjb25zdCByZXNwID0gYXdhaXQgZmV0Y2goXG4gICAgICBgaHR0cHM6Ly8ke2dldEF1dGgwRG9tYWluRm9yRW52KGVudil9L29hdXRoL3Rva2VuYCxcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZ3JhbnRfdHlwZTogXCJyZWZyZXNoX3Rva2VuXCIsXG4gICAgICAgICAgY2xpZW50X2lkOiBnZXRBdXRoMENsaWVudElkRm9yRW52KGVudiksXG4gICAgICAgICAgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuLFxuICAgICAgICB9KSxcbiAgICAgIH0sXG4gICAgKTtcbiAgICByZXR1cm4gYXdhaXQgcmVzcC5qc29uKCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbmZpZ0FjY2Vzc1Rva2VuKGVudjogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgdCA9IGdldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfYWNjZXNzX3Rva2VuXCIpIGFzIHN0cmluZztcbiAgcmV0dXJuIHQgPyB0IDogdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29uZmlnUmVmcmVzaFRva2VuKGVudjogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgdCA9IGdldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfcmVmcmVzaF90b2tlblwiKSBhcyBzdHJpbmc7XG4gIHJldHVybiB0ID8gdCA6IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbmZpZ0lkVG9rZW5QYXlsb2FkKGVudjogc3RyaW5nKTogUGF5bG9hZCB7XG4gIGxldCBpZFRva2VuXG4gIHRyeSB7XG4gICAgaWRUb2tlbiA9IGdldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfaWRfdG9rZW5cIikgYXMgc3RyaW5nO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgbm8gaWQgdG9rZW4gZm91bmQgaW4gY29uZmlnIDogJHtlcnJvci5tZXNzYWdlfWApXG4gIH1cblxuICBpZiAoIWlkVG9rZW4pIHsgdGhyb3cgbmV3IEVycm9yKGBtaXNzaW5nIGlkIHRva2VuYCk7IH1cblxuICB0cnkge1xuICAgIGNvbnN0IHsgcGF5bG9hZCB9ID0gdmFsaWRhdGUoZGVjb2RlKGlkVG9rZW4pKTtcbiAgICByZXR1cm4gcGF5bG9hZDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgaWQgdG9rZW4gOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2V0VG9rZW5zSW5Db25maWcoXG4gIGVudjogc3RyaW5nLFxuICB0b2tlbnM6IHtcbiAgICBhY2Nlc3NfdG9rZW46IHN0cmluZztcbiAgICBpZF90b2tlbj86IHN0cmluZztcbiAgICByZWZyZXNoX3Rva2VuPzogc3RyaW5nO1xuICAgIHNjb3BlOiBzdHJpbmc7XG4gICAgZXhwaXJlc19pbjogbnVtYmVyO1xuICAgIHRva2VuX3R5cGU6IHN0cmluZztcbiAgfSxcbik6IHZvaWQge1xuICB0cnkge1xuICAgIGlmICh0b2tlbnMucmVmcmVzaF90b2tlbikgc2V0Q29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9yZWZyZXNoX3Rva2VuXCIsIHRva2Vucy5yZWZyZXNoX3Rva2VuKTtcbiAgICBzZXRDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX2FjY2Vzc190b2tlblwiLCB0b2tlbnMuYWNjZXNzX3Rva2VuKTtcbiAgICBzZXRDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX2V4cGlyZXNfaW5cIiwgdG9rZW5zLmV4cGlyZXNfaW4pO1xuICAgIHNldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfc2NvcGVcIiwgdG9rZW5zLnNjb3BlKTtcbiAgICBzZXRDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX3Rva2VuX3R5cGVcIiwgdG9rZW5zLnRva2VuX3R5cGUpO1xuXG4gICAgaWYgKHRva2Vucy5pZF90b2tlbikge1xuICAgICAgc2V0Q29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9pZF90b2tlblwiLCB0b2tlbnMuaWRfdG9rZW4pO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYHVuYWJsZSB0byB3cml0ZSB0b2tlbnMgdG8gY29uZmlnIDogJHtlcnJvci5tZXNzYWdlfWApO1xuICB9XG59XG5cbi8vIHRoaXMgaXMgaG93IHdlIFwibG9nb3V0XCJcbmV4cG9ydCBmdW5jdGlvbiBkZWxldGVUb2tlbnNJbkNvbmZpZyhlbnY6IHN0cmluZyk6IHZvaWQge1xuICBkZWxldGVDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX3JlZnJlc2hfdG9rZW5cIik7XG4gIGRlbGV0ZUNvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfYWNjZXNzX3Rva2VuXCIpO1xuICBkZWxldGVDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX2V4cGlyZXNfaW5cIik7XG4gIGRlbGV0ZUNvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfc2NvcGVcIik7XG4gIGRlbGV0ZUNvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfdG9rZW5fdHlwZVwiKTtcbiAgZGVsZXRlQ29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9pZF90b2tlblwiKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEFjY2Vzc1Rva2VuV2l0aFByb21wdHMoZW52OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBsZXQgZGV2aWNlQ29kZVJlc3A7XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGdldENvbmZpZ0FjY2Vzc1Rva2VuKGVudik7XG4gICAgaWYgKGFjY2Vzc1Rva2VuKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyB2YWxpZGF0ZSAoYnV0IG5vdCBzaWduYXR1cmUgY2hlY2shKSB0aGUgc2F2ZWQgSldUXG4gICAgICAgIC8vIHRoaXMgaXMgcHJpbWFyaWx5IHRvIGF2b2lkIHNlbmRpbmcgQVBJIHJlcSB3aXRoXG4gICAgICAgIC8vIGV4cGlyZWQgdG9rZW4uXG4gICAgICAgIGNvbnN0IHsgaGVhZGVyLCBwYXlsb2FkLCBzaWduYXR1cmUgfSA9IHZhbGlkYXRlKFxuICAgICAgICAgIGRlY29kZShhY2Nlc3NUb2tlbiksXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gY29uc29sZS5sb2coaGVhZGVyKVxuICAgICAgICAvLyBjb25zb2xlLmxvZyhwYXlsb2FkKVxuICAgICAgICAvLyBjb25zb2xlLmxvZyhzaWduYXR1cmUpXG4gICAgICAgIGlmIChoZWFkZXIgJiYgcGF5bG9hZCAmJiBzaWduYXR1cmUpIHtcbiAgICAgICAgICAvLyBzdHJ1Y3R1cmFsbHkgdmFsaWQgYW5kIHVuZXhwaXJlZCBKV1RcbiAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHJlc29sdmUoYWNjZXNzVG9rZW4pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgY29uc3QgdG9rZW5zID0gYXdhaXQgZ2V0TmV3VG9rZW5zV2l0aFJlZnJlc2hUb2tlbihlbnYpO1xuICAgICAgICBpZiAodG9rZW5zKSB7XG4gICAgICAgICAgc2V0VG9rZW5zSW5Db25maWcoZW52LCB0b2tlbnMpO1xuICAgICAgICAgIGlmICh0b2tlbnMuYWNjZXNzX3Rva2VuKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSh0b2tlbnMuYWNjZXNzX3Rva2VuKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB1bmFibGUgdG8gcmV0cmlldmUgbmV3IGFjY2VzcyB0b2tlbnMgdXNpbmcgcmVmcmVzaCB0b2tlbiwgY2xlYW51cCBzYXZlZCB0b2tlbnNcbiAgICAgICAgICBkZWxldGVUb2tlbnNJbkNvbmZpZyhlbnYpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoY29sb3JzLmJvbGQucmVkKGAke2Vycm9yLm1lc3NhZ2V9IGVycm9yIDogZXhpdGluZ2ApKTtcbiAgICBEZW5vLmV4aXQoMSk7XG4gIH1cblxuICAvLyBObyBzYXZlZCB0b2tlbnMgZm91bmQuIFByb21wdCB0aGUgdXNlciB0byBhdXRoLlxuICB0cnkge1xuICAgIGRldmljZUNvZGVSZXNwID0gYXdhaXQgZ2V0RGV2aWNlQ29kZShlbnYpO1xuICAgIC8vIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGRldmljZUNvZGVSZXNwKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihjb2xvcnMuYm9sZC5yZWQoYCR7ZXJyb3IubWVzc2FnZX0gZXJyb3IgOiBleGl0aW5nYCkpO1xuICAgIERlbm8uZXhpdCgxKTtcbiAgfVxuXG4gIGlmIChkZXZpY2VDb2RlUmVzcCAmJiBkZXZpY2VDb2RlUmVzcC52ZXJpZmljYXRpb25fdXJpX2NvbXBsZXRlKSB7XG4gICAgY29uc29sZS5sb2coY29sb3JzLmJvbGQueWVsbG93LnVuZGVybGluZShgXFxuQVVUSEVOVElDQVRJT05cXG5gKSk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBjb2xvcnMuYm9sZC55ZWxsb3coXG4gICAgICAgIGBQbGVhc2UgYXV0aGVudGljYXRlIHlvdXJzZWxmIGJ5IHZpc2l0aW5nXFxudGhlIGZvbGxvd2luZyBVUkwgaW4gYSBicm93c2VyOlxcbmAsXG4gICAgICApLFxuICAgICk7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBjb2xvcnMuYm9sZC51bmRlcmxpbmUuYmx1ZShkZXZpY2VDb2RlUmVzcC52ZXJpZmljYXRpb25fdXJpX2NvbXBsZXRlKSxcbiAgICApO1xuICAgIGNvbnNvbGUubG9nKFwiXCIpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZXJyb3IoY29sb3JzLmJvbGQucmVkKGBubyB2ZXJpZmljYXRpb24gVVJJIGVycm9yIDogZXhpdGluZ2ApKTtcbiAgICBEZW5vLmV4aXQoMSk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHRva2VucyA9IGF3YWl0IGdldFRva2VucyhcbiAgICAgIGVudixcbiAgICAgIGRldmljZUNvZGVSZXNwLmRldmljZV9jb2RlLFxuICAgICAgZGV2aWNlQ29kZVJlc3AuaW50ZXJ2YWwsXG4gICAgKTtcblxuICAgIGlmICghdG9rZW5zIHx8ICF0b2tlbnMuYWNjZXNzX3Rva2VuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJyZXRyaWV2YWwgb2YgYWNjZXNzIHRva2VucyBmYWlsZWRcIik7XG4gICAgfVxuXG4gICAgc2V0VG9rZW5zSW5Db25maWcoZW52LCB0b2tlbnMpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICByZXNvbHZlKHRva2Vucy5hY2Nlc3NfdG9rZW4pO1xuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoY29sb3JzLmJvbGQucmVkKGAke2Vycm9yLm1lc3NhZ2V9IGVycm9yIDogZXhpdGluZ2ApKTtcbiAgICBEZW5vLmV4aXQoMSk7XG4gIH1cbn1cbiJdfQ==