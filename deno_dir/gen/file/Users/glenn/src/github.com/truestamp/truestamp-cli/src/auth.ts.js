import { colors, decode, sleep, validate } from "./deps.ts";
import { deleteConfigKeyForEnv, getConfigKeyForEnv, setConfigKeyForEnv, } from "./config.ts";
const AUTH0_SCOPES = "openid profile email offline_access";
const AUTH0_DOMAIN_DEVELOPMENT = "truestamp-dev.auth0.com";
const AUTH0_AUDIENCE_DEVELOPMENT = "https://db.fauna.com/db/ytijhfregydfy";
const AUTH0_CLIENT_ID_DEVELOPMENT = "8djbT1Ys078OZImR1uRr4jhu2Wb6d05B";
const AUTH0_DOMAIN_STAGING = "truestamp-staging.auth0.com";
const AUTH0_AUDIENCE_STAGING = "https://db.fauna.com/db/ytijhdrceybfy";
const AUTH0_CLIENT_ID_STAGING = "T0dzxGnnIj3TU0HpzCQRTZ5fx9N5Hb5m";
const AUTH0_DOMAIN_PRODUCTION = "login.truestamp.com";
const AUTH0_AUDIENCE_PRODUCTION = "https://db.fauna.com/db/ytij595b6yffy";
const AUTH0_CLIENT_ID_PRODUCTION = "pS5kRvqeuz4XLoxNPd6VX2LlUyNyU7Xj";
function getAuth0DomainForEnv(env) {
    switch (env) {
        case "development":
            return AUTH0_DOMAIN_DEVELOPMENT;
        case "staging":
            return AUTH0_DOMAIN_STAGING;
        case "production":
            return AUTH0_DOMAIN_PRODUCTION;
        default:
            throw new Error(`invalid environment : '${env}'`);
    }
}
function getAuth0AudienceForEnv(env) {
    switch (env) {
        case "development":
            return AUTH0_AUDIENCE_DEVELOPMENT;
        case "staging":
            return AUTH0_AUDIENCE_STAGING;
        case "production":
            return AUTH0_AUDIENCE_PRODUCTION;
        default:
            throw new Error(`invalid environment : '${env}'`);
    }
}
function getAuth0ClientIdForEnv(env) {
    switch (env) {
        case "development":
            return AUTH0_CLIENT_ID_DEVELOPMENT;
        case "staging":
            return AUTH0_CLIENT_ID_STAGING;
        case "production":
            return AUTH0_CLIENT_ID_PRODUCTION;
        default:
            throw new Error(`invalid environment : '${env}'`);
    }
}
async function getDeviceCode(env) {
    const resp = await fetch(`https://${getAuth0DomainForEnv(env)}/oauth/device/code`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            client_id: getAuth0ClientIdForEnv(env),
            audience: getAuth0AudienceForEnv(env),
            scope: AUTH0_SCOPES,
        }),
    });
    return resp.json();
}
async function callTokenEndpoint(env, deviceCode) {
    const resp = await fetch(`https://${getAuth0DomainForEnv(env)}/oauth/token`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            client_id: getAuth0ClientIdForEnv(env),
            device_code: deviceCode,
            grant_type: "urn:ietf:params:oauth:grant-type:device_code",
        }),
    });
    return resp;
}
async function getTokens(env, deviceCode, interval) {
    let adjustedInterval = interval;
    while (true) {
        await sleep(adjustedInterval);
        const resp = await callTokenEndpoint(env, deviceCode);
        if (resp.ok) {
            return await resp.json();
        }
        if (!resp.ok) {
            const respJson = await resp.json();
            switch (respJson.error) {
                case "authorization_pending":
                    break;
                case "slow_down":
                    adjustedInterval += 1;
                    break;
                case "expired_token":
                    throw new Error(`expired token`);
                case "access_denied":
                    throw new Error(`access denied`);
                default:
                    throw new Error(`unknown error response : ${JSON.stringify(respJson)}`);
            }
        }
    }
}
async function getNewTokensWithRefreshToken(env) {
    const refreshToken = getConfigRefreshToken(env);
    if (refreshToken) {
        const resp = await fetch(`https://${getAuth0DomainForEnv(env)}/oauth/token`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                grant_type: "refresh_token",
                client_id: getAuth0ClientIdForEnv(env),
                refresh_token: refreshToken,
            }),
        });
        return await resp.json();
    }
}
export function getConfigAccessToken(env = "production") {
    const t = getConfigKeyForEnv(env, "auth0_access_token");
    return t ? t : undefined;
}
export function getConfigRefreshToken(env = "production") {
    const t = getConfigKeyForEnv(env, "auth0_refresh_token");
    return t ? t : undefined;
}
export function getConfigIdTokenPayload(env = "production") {
    let idToken;
    try {
        idToken = getConfigKeyForEnv(env, "auth0_id_token");
    }
    catch (error) {
        throw new Error(`no id token found in config : ${error.message}`);
    }
    if (!idToken) {
        throw new Error(`missing id token`);
    }
    try {
        const { payload } = validate(decode(idToken));
        return payload;
    }
    catch (error) {
        throw new Error(`invalid id token : ${error.message}`);
    }
}
function setTokensInConfig(env, tokens) {
    try {
        if (tokens.refresh_token)
            setConfigKeyForEnv(env, "auth0_refresh_token", tokens.refresh_token);
        setConfigKeyForEnv(env, "auth0_access_token", tokens.access_token);
        setConfigKeyForEnv(env, "auth0_expires_in", tokens.expires_in);
        setConfigKeyForEnv(env, "auth0_scope", tokens.scope);
        setConfigKeyForEnv(env, "auth0_token_type", tokens.token_type);
        if (tokens.id_token) {
            setConfigKeyForEnv(env, "auth0_id_token", tokens.id_token);
        }
    }
    catch (error) {
        throw new Error(`unable to write tokens to config : ${error.message}`);
    }
}
export function deleteTokensInConfig(env = "production") {
    deleteConfigKeyForEnv(env, "auth0_refresh_token");
    deleteConfigKeyForEnv(env, "auth0_access_token");
    deleteConfigKeyForEnv(env, "auth0_expires_in");
    deleteConfigKeyForEnv(env, "auth0_scope");
    deleteConfigKeyForEnv(env, "auth0_token_type");
    deleteConfigKeyForEnv(env, "auth0_id_token");
}
export async function getAccessTokenWithPrompts(env = "production") {
    let deviceCodeResp;
    try {
        const accessToken = getConfigAccessToken(env);
        if (accessToken) {
            try {
                const { header, payload, signature } = validate(decode(accessToken));
                if (header && payload && signature) {
                    return new Promise((resolve) => {
                        resolve(accessToken);
                    });
                }
            }
            catch {
                const tokens = await getNewTokensWithRefreshToken(env);
                if (tokens) {
                    setTokensInConfig(env, tokens);
                    if (tokens.access_token) {
                        return new Promise((resolve) => {
                            resolve(tokens.access_token);
                        });
                    }
                }
                else {
                    deleteTokensInConfig(env);
                }
            }
        }
    }
    catch (error) {
        console.error(colors.bold.red(`${error.message} error : exiting`));
        Deno.exit(1);
    }
    try {
        deviceCodeResp = await getDeviceCode(env);
    }
    catch (error) {
        console.error(colors.bold.red(`${error.message} error : exiting`));
        Deno.exit(1);
    }
    if (deviceCodeResp && deviceCodeResp.verification_uri_complete) {
        console.log(colors.bold.yellow.underline(`\nAUTHENTICATION\n`));
        console.log(colors.bold.yellow(`Please authenticate yourself by visiting\nthe following URL in a browser:\n`));
        console.log(colors.bold.underline.blue(deviceCodeResp.verification_uri_complete));
        console.log("");
    }
    else {
        console.error(colors.bold.red(`no verification URI error : exiting`));
        Deno.exit(1);
    }
    try {
        const tokens = await getTokens(env, deviceCodeResp.device_code, deviceCodeResp.interval);
        if (!tokens || !tokens.access_token) {
            throw new Error("retrieval of access tokens failed");
        }
        setTokensInConfig(env, tokens);
        return new Promise((resolve) => {
            resolve(tokens.access_token);
        });
    }
    catch (error) {
        console.error(colors.bold.red(`${error.message} error : exiting`));
        Deno.exit(1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImF1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQVcsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVyRSxPQUFPLEVBQ0wscUJBQXFCLEVBQ3JCLGtCQUFrQixFQUNsQixrQkFBa0IsR0FDbkIsTUFBTSxhQUFhLENBQUM7QUFFckIsTUFBTSxZQUFZLEdBQUcscUNBQXFDLENBQUM7QUFFM0QsTUFBTSx3QkFBd0IsR0FBRyx5QkFBeUIsQ0FBQztBQUMzRCxNQUFNLDBCQUEwQixHQUFHLHVDQUF1QyxDQUFDO0FBQzNFLE1BQU0sMkJBQTJCLEdBQUcsa0NBQWtDLENBQUM7QUFFdkUsTUFBTSxvQkFBb0IsR0FBRyw2QkFBNkIsQ0FBQztBQUMzRCxNQUFNLHNCQUFzQixHQUFHLHVDQUF1QyxDQUFDO0FBQ3ZFLE1BQU0sdUJBQXVCLEdBQUcsa0NBQWtDLENBQUM7QUFFbkUsTUFBTSx1QkFBdUIsR0FBRyxxQkFBcUIsQ0FBQztBQUN0RCxNQUFNLHlCQUF5QixHQUFHLHVDQUF1QyxDQUFDO0FBQzFFLE1BQU0sMEJBQTBCLEdBQUcsa0NBQWtDLENBQUM7QUFFdEUsU0FBUyxvQkFBb0IsQ0FBQyxHQUFXO0lBQ3ZDLFFBQVEsR0FBRyxFQUFFO1FBQ1gsS0FBSyxhQUFhO1lBQ2hCLE9BQU8sd0JBQXdCLENBQUM7UUFFbEMsS0FBSyxTQUFTO1lBQ1osT0FBTyxvQkFBb0IsQ0FBQztRQUU5QixLQUFLLFlBQVk7WUFDZixPQUFPLHVCQUF1QixDQUFDO1FBRWpDO1lBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsR0FBRyxHQUFHLENBQUMsQ0FBQztLQUNyRDtBQUNILENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLEdBQVc7SUFDekMsUUFBUSxHQUFHLEVBQUU7UUFDWCxLQUFLLGFBQWE7WUFDaEIsT0FBTywwQkFBMEIsQ0FB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QyxHQUFHLENBQ1QsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUNyRSxDQUFDO1FBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNqQjtTQUFNO1FBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDLENBQUM7UUFDdEUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNkO0lBRUQsSUFBSTtRQUNGLE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUM1QixHQUFHLEVBQ0gsY0FBYyxDQUFDLFdBQVcsRUFDMUIsY0FBYyxDQUFDLFFBQVEsQ0FDeEIsQ0FBQztRQUVGLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztTQUN0RDtRQUVELGlCQUFpQixDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUUvQixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDN0IsT0FBTyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUMsQ0FBQztLQUNKO0lBQUMsT0FBTyxLQUFLLEVBQUU7UUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU8sa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDZDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgwqkgMjAyMC0yMDIyIFRydWVzdGFtcCBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG5cbi8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL3RydWVzdGFtcC9kZXZpY2VmbG93XG4vLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qYXRpbnZhaWR5YS9jbGktYXV0aHotZGV2aWNlLWZsb3cvYmxvYi9tYXN0ZXIvZGV2aWNlL2RldmljZS5qc1xuXG4vLyBPbiBNYWNPUyB0aGUgY29uZmlnIGZpbGVzIGNhbiBiZSBmb3VuZCBpbiBhIGxvY2F0aW9uIGxpa2U6XG4vLyBjYXQgfi9MaWJyYXJ5L1ByZWZlcmVuY2VzL2NvbS50cnVlc3RhbXAuY2xpLmRldmVsb3BtZW50L2NvbmZpZy5qc29uXG5cbmltcG9ydCB7IGNvbG9ycywgZGVjb2RlLCBQYXlsb2FkLCBzbGVlcCwgdmFsaWRhdGUgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5cbmltcG9ydCB7XG4gIGRlbGV0ZUNvbmZpZ0tleUZvckVudixcbiAgZ2V0Q29uZmlnS2V5Rm9yRW52LFxuICBzZXRDb25maWdLZXlGb3JFbnYsXG59IGZyb20gXCIuL2NvbmZpZy50c1wiO1xuXG5jb25zdCBBVVRIMF9TQ09QRVMgPSBcIm9wZW5pZCBwcm9maWxlIGVtYWlsIG9mZmxpbmVfYWNjZXNzXCI7XG5cbmNvbnN0IEFVVEgwX0RPTUFJTl9ERVZFTE9QTUVOVCA9IFwidHJ1ZXN0YW1wLWRldi5hdXRoMC5jb21cIjtcbmNvbnN0IEFVVEgwX0FVRElFTkNFX0RFVkVMT1BNRU5UID0gXCJodHRwczovL2RiLmZhdW5hLmNvbS9kYi95dGlqaGZyZWd5ZGZ5XCI7XG5jb25zdCBBVVRIMF9DTElFTlRfSURfREVWRUxPUE1FTlQgPSBcIjhkamJUMVlzMDc4T1pJbVIxdVJyNGpodTJXYjZkMDVCXCI7XG5cbmNvbnN0IEFVVEgwX0RPTUFJTl9TVEFHSU5HID0gXCJ0cnVlc3RhbXAtc3RhZ2luZy5hdXRoMC5jb21cIjtcbmNvbnN0IEFVVEgwX0FVRElFTkNFX1NUQUdJTkcgPSBcImh0dHBzOi8vZGIuZmF1bmEuY29tL2RiL3l0aWpoZHJjZXliZnlcIjtcbmNvbnN0IEFVVEgwX0NMSUVOVF9JRF9TVEFHSU5HID0gXCJUMGR6eEdubklqM1RVMEhwekNRUlRaNWZ4OU41SGI1bVwiO1xuXG5jb25zdCBBVVRIMF9ET01BSU5fUFJPRFVDVElPTiA9IFwibG9naW4udHJ1ZXN0YW1wLmNvbVwiO1xuY29uc3QgQVVUSDBfQVVESUVOQ0VfUFJPRFVDVElPTiA9IFwiaHR0cHM6Ly9kYi5mYXVuYS5jb20vZGIveXRpajU5NWI2eWZmeVwiO1xuY29uc3QgQVVUSDBfQ0xJRU5UX0lEX1BST0RVQ1RJT04gPSBcInBTNWtSdnFldXo0WExveE5QZDZWWDJMbFV5TnlVN1hqXCI7XG5cbmZ1bmN0aW9uIGdldEF1dGgwRG9tYWluRm9yRW52KGVudjogc3RyaW5nKTogc3RyaW5nIHtcbiAgc3dpdGNoIChlbnYpIHtcbiAgICBjYXNlIFwiZGV2ZWxvcG1lbnRcIjpcbiAgICAgIHJldHVybiBBVVRIMF9ET01BSU5fREVWRUxPUE1FTlQ7XG5cbiAgICBjYXNlIFwic3RhZ2luZ1wiOlxuICAgICAgcmV0dXJuIEFVVEgwX0RPTUFJTl9TVEFHSU5HO1xuXG4gICAgY2FzZSBcInByb2R1Y3Rpb25cIjpcbiAgICAgIHJldHVybiBBVVRIMF9ET01BSU5fUFJPRFVDVElPTjtcblxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgZW52aXJvbm1lbnQgOiAnJHtlbnZ9J2ApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEF1dGgwQXVkaWVuY2VGb3JFbnYoZW52OiBzdHJpbmcpOiBzdHJpbmcge1xuICBzd2l0Y2ggKGVudikge1xuICAgIGNhc2UgXCJkZXZlbG9wbWVudFwiOlxuICAgICAgcmV0dXJuIEFVVEgwX0FVRElFTkNFX0RFVkVMT1BNRU5UO1xuXG4gICAgY2FzZSBcInN0YWdpbmdcIjpcbiAgICAgIHJldHVybiBBVVRIMF9BVURJRU5DRV9TVEFHSU5HO1xuXG4gICAgY2FzZSBcInByb2R1Y3Rpb25cIjpcbiAgICAgIHJldHVybiBBVVRIMF9BVURJRU5DRV9QUk9EVUNUSU9OO1xuXG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBlbnZpcm9ubWVudCA6ICcke2Vudn0nYCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0QXV0aDBDbGllbnRJZEZvckVudihlbnY6IHN0cmluZyk6IHN0cmluZyB7XG4gIHN3aXRjaCAoZW52KSB7XG4gICAgY2FzZSBcImRldmVsb3BtZW50XCI6XG4gICAgICByZXR1cm4gQVVUSDBfQ0xJRU5UX0lEX0RFVkVMT1BNRU5UO1xuXG4gICAgY2FzZSBcInN0YWdpbmdcIjpcbiAgICAgIHJldHVybiBBVVRIMF9DTElFTlRfSURfU1RBR0lORztcblxuICAgIGNhc2UgXCJwcm9kdWN0aW9uXCI6XG4gICAgICByZXR1cm4gQVVUSDBfQ0xJRU5UX0lEX1BST0RVQ1RJT047XG5cbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGVudmlyb25tZW50IDogJyR7ZW52fSdgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXZpY2VDb2RlKGVudjogc3RyaW5nKSB7XG4gIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaChcbiAgICBgaHR0cHM6Ly8ke2dldEF1dGgwRG9tYWluRm9yRW52KGVudil9L29hdXRoL2RldmljZS9jb2RlYCxcbiAgICB7XG4gICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGNsaWVudF9pZDogZ2V0QXV0aDBDbGllbnRJZEZvckVudihlbnYpLFxuICAgICAgICBhdWRpZW5jZTogZ2V0QXV0aDBBdWRpZW5jZUZvckVudihlbnYpLFxuICAgICAgICBzY29wZTogQVVUSDBfU0NPUEVTLFxuICAgICAgfSksXG4gICAgfSxcbiAgKTtcbiAgcmV0dXJuIHJlc3AuanNvbigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjYWxsVG9rZW5FbmRwb2ludChcbiAgZW52OiBzdHJpbmcsXG4gIGRldmljZUNvZGU6IHN0cmluZyxcbik6IFByb21pc2U8UmVzcG9uc2U+IHtcbiAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKGBodHRwczovLyR7Z2V0QXV0aDBEb21haW5Gb3JFbnYoZW52KX0vb2F1dGgvdG9rZW5gLCB7XG4gICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICBoZWFkZXJzOiB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICB9LFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGNsaWVudF9pZDogZ2V0QXV0aDBDbGllbnRJZEZvckVudihlbnYpLFxuICAgICAgZGV2aWNlX2NvZGU6IGRldmljZUNvZGUsXG4gICAgICBncmFudF90eXBlOiBcInVybjppZXRmOnBhcmFtczpvYXV0aDpncmFudC10eXBlOmRldmljZV9jb2RlXCIsXG4gICAgfSksXG4gIH0pO1xuICByZXR1cm4gcmVzcDtcbn1cblxuLy8gR2V0IHRoZSB3aG9sZSB0b2tlbiByZXNwb25zZSBvYmplY3QgYnkgcG9sbGluZyB1bnRpbCB0aGVcbi8vIHVzZXIgYXV0aGVudGljYXRlcyBvciBmYWlscyBhdCBkb2luZyBzby5cbmFzeW5jIGZ1bmN0aW9uIGdldFRva2VucyhlbnY6IHN0cmluZywgZGV2aWNlQ29kZTogc3RyaW5nLCBpbnRlcnZhbDogbnVtYmVyKSB7XG4gIGxldCBhZGp1c3RlZEludGVydmFsID0gaW50ZXJ2YWw7XG5cbiAgd2hpbGUgKHRydWUpIHtcbiAgICBhd2FpdCBzbGVlcChhZGp1c3RlZEludGVydmFsKTtcbiAgICBjb25zdCByZXNwID0gYXdhaXQgY2FsbFRva2VuRW5kcG9pbnQoZW52LCBkZXZpY2VDb2RlKTtcblxuICAgIGlmIChyZXNwLm9rKSB7XG4gICAgICByZXR1cm4gYXdhaXQgcmVzcC5qc29uKCk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXNwLm9rKSB7XG4gICAgICBjb25zdCByZXNwSnNvbiA9IGF3YWl0IHJlc3AuanNvbigpO1xuXG4gICAgICBzd2l0Y2ggKHJlc3BKc29uLmVycm9yKSB7XG4gICAgICAgIGNhc2UgXCJhdXRob3JpemF0aW9uX3BlbmRpbmdcIjpcbiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhjb2xvcnMuYm9sZC5ncmF5KFwiYXV0aG9yaXphdGlvbiBwZW5kaW5nLi4uXCIpKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwic2xvd19kb3duXCI6XG4gICAgICAgICAgLy8gYWRkIGEgc2Vjb25kIHRvIHRoZSBwb2xsaW5nIGludGVydmFsIGVhY2ggdGltZSByZWNlaXZlZFxuICAgICAgICAgIGFkanVzdGVkSW50ZXJ2YWwgKz0gMTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFwiZXhwaXJlZF90b2tlblwiOlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZXhwaXJlZCB0b2tlbmApO1xuXG4gICAgICAgIGNhc2UgXCJhY2Nlc3NfZGVuaWVkXCI6XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhY2Nlc3MgZGVuaWVkYCk7XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgdW5rbm93biBlcnJvciByZXNwb25zZSA6ICR7SlNPTi5zdHJpbmdpZnkocmVzcEpzb24pfWAsXG4gICAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TmV3VG9rZW5zV2l0aFJlZnJlc2hUb2tlbihlbnY6IHN0cmluZykge1xuICBjb25zdCByZWZyZXNoVG9rZW4gPSBnZXRDb25maWdSZWZyZXNoVG9rZW4oZW52KTtcbiAgaWYgKHJlZnJlc2hUb2tlbikge1xuICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaChcbiAgICAgIGBodHRwczovLyR7Z2V0QXV0aDBEb21haW5Gb3JFbnYoZW52KX0vb2F1dGgvdG9rZW5gLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBncmFudF90eXBlOiBcInJlZnJlc2hfdG9rZW5cIixcbiAgICAgICAgICBjbGllbnRfaWQ6IGdldEF1dGgwQ2xpZW50SWRGb3JFbnYoZW52KSxcbiAgICAgICAgICByZWZyZXNoX3Rva2VuOiByZWZyZXNoVG9rZW4sXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICApO1xuICAgIHJldHVybiBhd2FpdCByZXNwLmpzb24oKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29uZmlnQWNjZXNzVG9rZW4oZW52ID0gXCJwcm9kdWN0aW9uXCIpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBjb25zdCB0ID0gZ2V0Q29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9hY2Nlc3NfdG9rZW5cIikgYXMgc3RyaW5nO1xuICByZXR1cm4gdCA/IHQgOiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25maWdSZWZyZXNoVG9rZW4oZW52ID0gXCJwcm9kdWN0aW9uXCIpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBjb25zdCB0ID0gZ2V0Q29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9yZWZyZXNoX3Rva2VuXCIpIGFzIHN0cmluZztcbiAgcmV0dXJuIHQgPyB0IDogdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q29uZmlnSWRUb2tlblBheWxvYWQoZW52ID0gXCJwcm9kdWN0aW9uXCIpOiBQYXlsb2FkIHtcbiAgbGV0IGlkVG9rZW5cbiAgdHJ5IHtcbiAgICBpZFRva2VuID0gZ2V0Q29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9pZF90b2tlblwiKSBhcyBzdHJpbmc7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBubyBpZCB0b2tlbiBmb3VuZCBpbiBjb25maWcgOiAke2Vycm9yLm1lc3NhZ2V9YClcbiAgfVxuXG4gIGlmICghaWRUb2tlbikgeyB0aHJvdyBuZXcgRXJyb3IoYG1pc3NpbmcgaWQgdG9rZW5gKTsgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgeyBwYXlsb2FkIH0gPSB2YWxpZGF0ZShkZWNvZGUoaWRUb2tlbikpO1xuICAgIHJldHVybiBwYXlsb2FkO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBpZCB0b2tlbiA6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzZXRUb2tlbnNJbkNvbmZpZyhcbiAgZW52OiBzdHJpbmcsXG4gIHRva2Vuczoge1xuICAgIGFjY2Vzc190b2tlbjogc3RyaW5nO1xuICAgIGlkX3Rva2VuPzogc3RyaW5nO1xuICAgIHJlZnJlc2hfdG9rZW4/OiBzdHJpbmc7XG4gICAgc2NvcGU6IHN0cmluZztcbiAgICBleHBpcmVzX2luOiBudW1iZXI7XG4gICAgdG9rZW5fdHlwZTogc3RyaW5nO1xuICB9LFxuKTogdm9pZCB7XG4gIHRyeSB7XG4gICAgaWYgKHRva2Vucy5yZWZyZXNoX3Rva2VuKSBzZXRDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX3JlZnJlc2hfdG9rZW5cIiwgdG9rZW5zLnJlZnJlc2hfdG9rZW4pO1xuICAgIHNldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfYWNjZXNzX3Rva2VuXCIsIHRva2Vucy5hY2Nlc3NfdG9rZW4pO1xuICAgIHNldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfZXhwaXJlc19pblwiLCB0b2tlbnMuZXhwaXJlc19pbik7XG4gICAgc2V0Q29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9zY29wZVwiLCB0b2tlbnMuc2NvcGUpO1xuICAgIHNldENvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfdG9rZW5fdHlwZVwiLCB0b2tlbnMudG9rZW5fdHlwZSk7XG5cbiAgICBpZiAodG9rZW5zLmlkX3Rva2VuKSB7XG4gICAgICBzZXRDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX2lkX3Rva2VuXCIsIHRva2Vucy5pZF90b2tlbik7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHRocm93IG5ldyBFcnJvcihgdW5hYmxlIHRvIHdyaXRlIHRva2VucyB0byBjb25maWcgOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuLy8gdGhpcyBpcyBob3cgd2UgXCJsb2dvdXRcIlxuZXhwb3J0IGZ1bmN0aW9uIGRlbGV0ZVRva2Vuc0luQ29uZmlnKGVudiA9IFwicHJvZHVjdGlvblwiKSB7XG4gIGRlbGV0ZUNvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfcmVmcmVzaF90b2tlblwiKTtcbiAgZGVsZXRlQ29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9hY2Nlc3NfdG9rZW5cIik7XG4gIGRlbGV0ZUNvbmZpZ0tleUZvckVudihlbnYsIFwiYXV0aDBfZXhwaXJlc19pblwiKTtcbiAgZGVsZXRlQ29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF9zY29wZVwiKTtcbiAgZGVsZXRlQ29uZmlnS2V5Rm9yRW52KGVudiwgXCJhdXRoMF90b2tlbl90eXBlXCIpO1xuICBkZWxldGVDb25maWdLZXlGb3JFbnYoZW52LCBcImF1dGgwX2lkX3Rva2VuXCIpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QWNjZXNzVG9rZW5XaXRoUHJvbXB0cyhlbnYgPSBcInByb2R1Y3Rpb25cIik6IFByb21pc2U8c3RyaW5nPiB7XG4gIGxldCBkZXZpY2VDb2RlUmVzcDtcblxuICB0cnkge1xuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gZ2V0Q29uZmlnQWNjZXNzVG9rZW4oZW52KTtcbiAgICBpZiAoYWNjZXNzVG9rZW4pIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIHZhbGlkYXRlIChidXQgbm90IHNpZ25hdHVyZSBjaGVjayEpIHRoZSBzYXZlZCBKV1RcbiAgICAgICAgLy8gdGhpcyBpcyBwcmltYXJpbHkgdG8gYXZvaWQgc2VuZGluZyBBUEkgcmVxIHdpdGhcbiAgICAgICAgLy8gZXhwaXJlZCB0b2tlbi5cbiAgICAgICAgY29uc3QgeyBoZWFkZXIsIHBheWxvYWQsIHNpZ25hdHVyZSB9ID0gdmFsaWRhdGUoXG4gICAgICAgICAgZGVjb2RlKGFjY2Vzc1Rva2VuKSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhoZWFkZXIpXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHBheWxvYWQpXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHNpZ25hdHVyZSlcbiAgICAgICAgaWYgKGhlYWRlciAmJiBwYXlsb2FkICYmIHNpZ25hdHVyZSkge1xuICAgICAgICAgIC8vIHN0cnVjdHVyYWxseSB2YWxpZCBhbmQgdW5leHBpcmVkIEpXVFxuICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZShhY2Nlc3NUb2tlbik7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICBjb25zdCB0b2tlbnMgPSBhd2FpdCBnZXROZXdUb2tlbnNXaXRoUmVmcmVzaFRva2VuKGVudik7XG4gICAgICAgIGlmICh0b2tlbnMpIHtcbiAgICAgICAgICBzZXRUb2tlbnNJbkNvbmZpZyhlbnYsIHRva2Vucyk7XG4gICAgICAgICAgaWYgKHRva2Vucy5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKHRva2Vucy5hY2Nlc3NfdG9rZW4pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIHVuYWJsZSB0byByZXRyaWV2ZSBuZXcgYWNjZXNzIHRva2VucyB1c2luZyByZWZyZXNoIHRva2VuLCBjbGVhbnVwIHNhdmVkIHRva2Vuc1xuICAgICAgICAgIGRlbGV0ZVRva2Vuc0luQ29uZmlnKGVudik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihjb2xvcnMuYm9sZC5yZWQoYCR7ZXJyb3IubWVzc2FnZX0gZXJyb3IgOiBleGl0aW5nYCkpO1xuICAgIERlbm8uZXhpdCgxKTtcbiAgfVxuXG4gIC8vIE5vIHNhdmVkIHRva2VucyBmb3VuZC4gUHJvbXB0IHRoZSB1c2VyIHRvIGF1dGguXG4gIHRyeSB7XG4gICAgZGV2aWNlQ29kZVJlc3AgPSBhd2FpdCBnZXREZXZpY2VDb2RlKGVudik7XG4gICAgLy8gY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZGV2aWNlQ29kZVJlc3ApKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGNvbG9ycy5ib2xkLnJlZChgJHtlcnJvci5tZXNzYWdlfSBlcnJvciA6IGV4aXRpbmdgKSk7XG4gICAgRGVuby5leGl0KDEpO1xuICB9XG5cbiAgaWYgKGRldmljZUNvZGVSZXNwICYmIGRldmljZUNvZGVSZXNwLnZlcmlmaWNhdGlvbl91cmlfY29tcGxldGUpIHtcbiAgICBjb25zb2xlLmxvZyhjb2xvcnMuYm9sZC55ZWxsb3cudW5kZXJsaW5lKGBcXG5BVVRIRU5USUNBVElPTlxcbmApKTtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIGNvbG9ycy5ib2xkLnllbGxvdyhcbiAgICAgICAgYFBsZWFzZSBhdXRoZW50aWNhdGUgeW91cnNlbGYgYnkgdmlzaXRpbmdcXG50aGUgZm9sbG93aW5nIFVSTCBpbiBhIGJyb3dzZXI6XFxuYCxcbiAgICAgICksXG4gICAgKTtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIGNvbG9ycy5ib2xkLnVuZGVybGluZS5ibHVlKGRldmljZUNvZGVSZXNwLnZlcmlmaWNhdGlvbl91cmlfY29tcGxldGUpLFxuICAgICk7XG4gICAgY29uc29sZS5sb2coXCJcIik7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5lcnJvcihjb2xvcnMuYm9sZC5yZWQoYG5vIHZlcmlmaWNhdGlvbiBVUkkgZXJyb3IgOiBleGl0aW5nYCkpO1xuICAgIERlbm8uZXhpdCgxKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgdG9rZW5zID0gYXdhaXQgZ2V0VG9rZW5zKFxuICAgICAgZW52LFxuICAgICAgZGV2aWNlQ29kZVJlc3AuZGV2aWNlX2NvZGUsXG4gICAgICBkZXZpY2VDb2RlUmVzcC5pbnRlcnZhbCxcbiAgICApO1xuXG4gICAgaWYgKCF0b2tlbnMgfHwgIXRva2Vucy5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInJldHJpZXZhbCBvZiBhY2Nlc3MgdG9rZW5zIGZhaWxlZFwiKTtcbiAgICB9XG5cbiAgICBzZXRUb2tlbnNJbkNvbmZpZyhlbnYsIHRva2Vucyk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHJlc29sdmUodG9rZW5zLmFjY2Vzc190b2tlbik7XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihjb2xvcnMuYm9sZC5yZWQoYCR7ZXJyb3IubWVzc2FnZX0gZXJyb3IgOiBleGl0aW5nYCkpO1xuICAgIERlbm8uZXhpdCgxKTtcbiAgfVxufVxuIl19