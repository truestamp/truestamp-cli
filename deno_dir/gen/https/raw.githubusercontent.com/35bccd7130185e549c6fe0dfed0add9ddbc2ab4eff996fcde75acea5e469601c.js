import { dirname as pathDirname, resolve as pathResolve, } from "https://deno.land/std@0.97.0/path/mod.ts";
import { existsSync } from "https://deno.land/std@0.97.0/fs/exists.ts";
import envPaths from "https://raw.githubusercontent.com/truestamp/deno-app-paths/main/mod.ts";
const plainObject = () => Object.create(null);
export default class Config {
    _options = {
        projectName: "",
        configName: "config",
        resetInvalidConfig: false,
        defaults: null,
    };
    defaultValues = plainObject();
    path;
    constructor(options) {
        this._options = {
            ...this._options,
            ...options,
        };
        this.defaultValues = this._options.defaults
            ? this._options.defaults
            : plainObject();
        if (!this._options.projectName || this._options.projectName.trim() === "") {
            throw new Error("the projectName option must be provided and non-empty");
        }
        this._options.projectName = this._options.projectName.trim();
        this.path = pathResolve(envPaths(this._options.projectName).config, `${this._options.configName}.json`);
    }
    get size() {
        return Object.keys(this.store).length;
    }
    get dir() {
        return pathDirname(this.path);
    }
    get store() {
        try {
            return {
                ...this.defaultValues,
                ...JSON.parse(Deno.readTextFileSync(this.path)),
            };
        }
        catch (error) {
            switch (error.name) {
                case "SyntaxError":
                    if (this._options.resetInvalidConfig) {
                        this.reset();
                        return { ...this.defaultValues };
                    }
                    break;
                case "NotFound":
                    return { ...this.defaultValues, ...plainObject() };
            }
            throw error;
        }
    }
    set store(data) {
        if (!existsSync(pathDirname(this.path))) {
            Deno.mkdirSync(pathDirname(this.path), { recursive: true });
        }
        Deno.writeTextFileSync(this.path, JSON.stringify(data, null, 2));
    }
    get options() {
        return this._options;
    }
    has(key) {
        return key in this.store;
    }
    reset() {
        if (this.path && existsSync(this.path)) {
            Deno.removeSync(this.path, { recursive: true });
        }
        if (Object.keys(this.defaultValues).length === 0) {
            return;
        }
        Object.entries(this.defaultValues).forEach(([key, value]) => {
            this.set(key, value);
        });
        return;
    }
    resetKeys(keys) {
        if (Object.keys(this.defaultValues).length === 0) {
            return;
        }
        for (const key of keys) {
            if (this.defaultValues && key in this.defaultValues) {
                this.set(key, this.defaultValues[key]);
            }
        }
    }
    delete(key) {
        const { store } = this;
        if (store && key in store) {
            delete store[key];
            this.store = store;
        }
    }
    get(key) {
        if (this.store && key in this.store) {
            return this.store[key];
        }
        else if (this.defaultValues && key in this.defaultValues) {
            return this.defaultValues[key];
        }
        else {
            return null;
        }
    }
    set(key, value) {
        const { store } = this;
        const innerSet = (key, value) => {
            store[key] = value;
        };
        innerSet(key, value);
        this.store = store;
    }
    setObject(data) {
        for (const [key, value] of Object.entries(data)) {
            this.set(key, value);
        }
    }
    *[Symbol.iterator]() {
        for (const [key, value] of Object.entries(this.store)) {
            yield [key, value];
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxPQUFPLElBQUksV0FBVyxFQUN0QixPQUFPLElBQUksV0FBVyxHQUN2QixNQUFNLDBDQUEwQyxDQUFDO0FBRWxELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUV2RSxPQUFPLFFBQVEsTUFBTSx3RUFBd0UsQ0FBQztBQUU5RixNQUFNLFdBQVcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBd0Q5QyxNQUFNLENBQUMsT0FBTyxPQUFPLE1BQU07SUFDakIsUUFBUSxHQUFxQjtRQUNuQyxXQUFXLEVBQUUsRUFBRTtRQUNmLFVBQVUsRUFBRSxRQUFRO1FBQ3BCLGtCQUFrQixFQUFFLEtBQUs7UUFDekIsUUFBUSxFQUFFLElBQUk7S0FDZixDQUFDO0lBRUYsYUFBYSxHQUFjLFdBQVcsRUFBRSxDQUFDO0lBRXpDLElBQUksQ0FBUztJQUViLFlBQVksT0FBeUI7UUFDbkMsSUFBSSxDQUFDLFFBQVEsR0FBRztZQUNkLEdBQUcsSUFBSSxDQUFDLFFBQVE7WUFDaEIsR0FBRyxPQUFPO1NBQ1gsQ0FBQztRQUdGLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRO1lBQ3pDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVE7WUFDeEIsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWxCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDekUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1NBQzFFO1FBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEdBQUcs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RyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFRRCxTQUFTLENBQ1AsSUFBZTtRQUVmLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQy9DLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUdELENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2hCLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNyRCxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZGlybmFtZSBhcyBwYXRoRGlybmFtZSxcbiAgcmVzb2x2ZSBhcyBwYXRoUmVzb2x2ZSxcbn0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3N0ZEAwLjk3LjAvcGF0aC9tb2QudHNcIjtcblxuaW1wb3J0IHsgZXhpc3RzU3luYyB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC9zdGRAMC45Ny4wL2ZzL2V4aXN0cy50c1wiO1xuXG5pbXBvcnQgZW52UGF0aHMgZnJvbSBcImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS90cnVlc3RhbXAvZGVuby1hcHAtcGF0aHMvbWFpbi9tb2QudHNcIjtcblxuY29uc3QgcGxhaW5PYmplY3QgPSAoKSA9PiBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4vLyBXZSBkb24ndCBrbm93IHdoYXQga2V5IG5hbWVzIHRoZSB1c2VyIHdpbGwgd2FudCxcbi8vIGJ1dCB3ZSBkbyBrbm93IHdoYXQgdHlwZXMgYXJlIHNhZmUgZm9yIGNvbnZlcnNpb24gdG8gSlNPTi5cbi8vIFRoZSBoYXJkZXN0IHBhcnQgaXMgZGVmaW5pbmcgdGhlIG5lc3RlZCBvYmplY3RzIHdoZXJlXG4vLyB0aGUgdmFsdWUgY2FuIGJlIG9mIG1hbnkgdHlwZXMsIGluY2x1ZGluZyBhbm90aGVyXG4vLyBuZXN0ZWQgb2JqZWN0LiBUaGlzIHdvcmthcm91bmQgcGVybWl0cyBzZXZlcmFsIGxldmVsc1xuLy8gb2Ygb2JqZWN0IG5lc3RpbmcuIFRoaXMgaXMgYSBoYWNrIHRoYXQgY2FuIHByb2JhYmx5IGJlIGZpeGVkXG4vLyB3aXRoIHNvbWUgYmV0dGVyIFR5cGVzY3JpcHQgdHlwZSBkZWZpbml0aW9uIGtub3dsZWdlLlxuXG50eXBlIERlZXBOZXN0ZWRPYmplY3RUeXBlID0gUmVjb3JkPFxuICBzdHJpbmcsXG4gIHwgKGJvb2xlYW4gfCBudWxsIHwgbnVtYmVyIHwgT2JqZWN0VHlwZSB8IHN0cmluZylbXVxuICB8IGJvb2xlYW5cbiAgfCBudWxsXG4gIHwgbnVtYmVyXG4gIHwgc3RyaW5nXG4+O1xuXG50eXBlIE5lc3RlZE9iamVjdFR5cGUgPSBSZWNvcmQ8XG4gIHN0cmluZyxcbiAgfCAoYm9vbGVhbiB8IG51bGwgfCBudW1iZXIgfCBPYmplY3RUeXBlIHwgc3RyaW5nKVtdXG4gIHwgYm9vbGVhblxuICB8IERlZXBOZXN0ZWRPYmplY3RUeXBlXG4gIHwgbnVsbFxuICB8IG51bWJlclxuICB8IHN0cmluZ1xuPjtcblxudHlwZSBPYmplY3RUeXBlID0gUmVjb3JkPFxuICBzdHJpbmcsXG4gIHwgKGJvb2xlYW4gfCBudWxsIHwgbnVtYmVyIHwgT2JqZWN0VHlwZSB8IHN0cmluZylbXVxuICB8IGJvb2xlYW5cbiAgfCBOZXN0ZWRPYmplY3RUeXBlXG4gIHwgbnVsbFxuICB8IG51bWJlclxuICB8IHN0cmluZ1xuPjtcblxuZXhwb3J0IHR5cGUgSXRlbVR5cGUgPVxuICB8IChib29sZWFuIHwgbnVsbCB8IG51bWJlciB8IE9iamVjdFR5cGUgfCBzdHJpbmcpW11cbiAgfCBib29sZWFuXG4gIHwgbnVsbFxuICB8IG51bWJlclxuICB8IE9iamVjdFR5cGVcbiAgfCBzdHJpbmc7XG5cbmV4cG9ydCB0eXBlIFN0b3JlVHlwZSA9IFJlY29yZDxzdHJpbmcsIEl0ZW1UeXBlPjtcblxuZXhwb3J0IGludGVyZmFjZSBDb25maWdQYXJhbWV0ZXJzIHtcbiAgcHJvamVjdE5hbWU6IHN0cmluZztcbiAgY29uZmlnTmFtZT86IHN0cmluZztcbiAgcmVzZXRJbnZhbGlkQ29uZmlnPzogYm9vbGVhbjtcbiAgZGVmYXVsdHM/OiBTdG9yZVR5cGUgfCBudWxsO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb25maWcge1xuICBwcml2YXRlIF9vcHRpb25zOiBDb25maWdQYXJhbWV0ZXJzID0ge1xuICAgIHByb2plY3ROYW1lOiBcIlwiLFxuICAgIGNvbmZpZ05hbWU6IFwiY29uZmlnXCIsXG4gICAgcmVzZXRJbnZhbGlkQ29uZmlnOiBmYWxzZSxcbiAgICBkZWZhdWx0czogbnVsbCxcbiAgfTtcblxuICBkZWZhdWx0VmFsdWVzOiBTdG9yZVR5cGUgPSBwbGFpbk9iamVjdCgpO1xuXG4gIHBhdGg6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBDb25maWdQYXJhbWV0ZXJzKSB7XG4gICAgdGhpcy5fb3B0aW9ucyA9IHtcbiAgICAgIC4uLnRoaXMuX29wdGlvbnMsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH07XG5cbiAgICAvLyBXZXJlIGBkZWZhdWx0c2AgcHJvdmlkZWQ/XG4gICAgdGhpcy5kZWZhdWx0VmFsdWVzID0gdGhpcy5fb3B0aW9ucy5kZWZhdWx0c1xuICAgICAgPyB0aGlzLl9vcHRpb25zLmRlZmF1bHRzXG4gICAgICA6IHBsYWluT2JqZWN0KCk7XG5cbiAgICBpZiAoIXRoaXMuX29wdGlvbnMucHJvamVjdE5hbWUgfHwgdGhpcy5fb3B0aW9ucy5wcm9qZWN0TmFtZS50cmltKCkgPT09IFwiXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInRoZSBwcm9qZWN0TmFtZSBvcHRpb24gbXVzdCBiZSBwcm92aWRlZCBhbmQgbm9uLWVtcHR5XCIpO1xuICAgIH1cblxuICAgIHRoaXMuX29wdGlvbnMucHJvamVjdE5hbWUgPSB0aGlzLl9vcHRpb25zLnByb2plY3ROYW1lLnRyaW0oKTtcblxuICAgIHRoaXMucGF0aCA9IHBhdGhSZXNvbHZlKFxuICAgICAgZW52UGF0aHModGhpcy5fb3B0aW9ucy5wcm9qZWN0TmFtZSkuY29uZmlnLFxuICAgICAgYCR7dGhpcy5fb3B0aW9ucy5jb25maWdOYW1lfS5qc29uYCxcbiAgICApO1xuICB9XG5cbiAgLy8gYWNjZXNzb3IgcHJvcGVydGllcyAoZ2V0dGVyL3NldHRlcilcblxuICAvKipcbiAgICogR2V0IHRoZSBudW1iZXIgb2YgY29uZmlnIGl0ZW1zIHN0b3JlZC5cbiAgICogQHJldHVybnMge251bWJlcn0gVGhlIGNvdW50IG9mIGNvbmZpZyBpdGVtc1xuICAgKi9cbiAgZ2V0IHNpemUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5zdG9yZSkubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgcGF0aCBvZiB0aGUgY29uZmlnIGRpcmVjdG9yeS5cbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGRpcmVjdG9yeSBwb3J0aW9uIG9mIHRoZSBjb25maWcgcGF0aFxuICAgKi9cbiAgZ2V0IGRpcigpOiBzdHJpbmcge1xuICAgIHJldHVybiBwYXRoRGlybmFtZSh0aGlzLnBhdGgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgY29udGVudHMgb2YgdGhlIGNvbmZpZyBzdG9yZSwgaW5jbHVkaW5nIGRlZmF1bHRzIGlmIHByZXNlbnQuXG4gICAqIEByZXR1cm5zIHtTdG9yZVR5cGV9IFRoZSBjb25maWcgc3RvcmVcbiAgICovXG4gIGdldCBzdG9yZSgpOiBTdG9yZVR5cGUge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi50aGlzLmRlZmF1bHRWYWx1ZXMsXG4gICAgICAgIC4uLkpTT04ucGFyc2UoRGVuby5yZWFkVGV4dEZpbGVTeW5jKHRoaXMucGF0aCkpLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgc3dpdGNoIChlcnJvci5uYW1lKSB7XG4gICAgICAgIGNhc2UgXCJTeW50YXhFcnJvclwiOlxuICAgICAgICAgIC8vIFVuYWJsZSB0byByZWFkIHRoZSBKU09OIGZpbGUuIFJlc2V0IGl0IHRvIGRlZmF1bHRzIGlmIHRoYXQgaXMgdGhlXG4gICAgICAgICAgLy8gZGVzaXJlZCBiZWhhdmlvci5cbiAgICAgICAgICBpZiAodGhpcy5fb3B0aW9ucy5yZXNldEludmFsaWRDb25maWcpIHtcbiAgICAgICAgICAgIHRoaXMucmVzZXQoKTtcbiAgICAgICAgICAgIHJldHVybiB7IC4uLnRoaXMuZGVmYXVsdFZhbHVlcyB9O1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcIk5vdEZvdW5kXCI6XG4gICAgICAgICAgcmV0dXJuIHsgLi4udGhpcy5kZWZhdWx0VmFsdWVzLCAuLi5wbGFpbk9iamVjdCgpIH07XG4gICAgICB9XG5cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb25maWcgc3RvcmUgdG8gYW4gT2JqZWN0LlxuICAgKlxuICAgKiBAcGFyYW0ge1N0b3JlVHlwZX0gZGF0YVxuICAgKiBAcmV0dXJucyB7dm9pZH1cbiAgICovXG4gIHNldCBzdG9yZShkYXRhOiBTdG9yZVR5cGUpIHtcbiAgICBpZiAoIWV4aXN0c1N5bmMocGF0aERpcm5hbWUodGhpcy5wYXRoKSkpIHtcbiAgICAgIERlbm8ubWtkaXJTeW5jKHBhdGhEaXJuYW1lKHRoaXMucGF0aCksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cblxuICAgIERlbm8ud3JpdGVUZXh0RmlsZVN5bmModGhpcy5wYXRoLCBKU09OLnN0cmluZ2lmeShkYXRhLCBudWxsLCAyKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBjb25maWcgc3RvcmUgcGFyYW1ldGVycy5cbiAgICpcbiAgICogQHJldHVybnMge0NvbmZpZ1BhcmFtZXRlcnN9XG4gICAqL1xuICBnZXQgb3B0aW9ucygpOiBDb25maWdQYXJhbWV0ZXJzIHtcbiAgICByZXR1cm4gdGhpcy5fb3B0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGJvb2xlYW4gd2hldGhlciBga2V5YCBpcyBwcmVzZW50IGluIHRoZSBjb25maWcgc3RvcmUuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSB0byBzZWFyY2ggZm9yLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gS2V5IGV4aXN0cyBpbiBjb25maWcgc3RvcmU/XG4gICAqL1xuICBoYXMoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4ga2V5IGluIHRoaXMuc3RvcmU7XG4gIH1cblxuICAvL1xuXG4gIC8qKlxuICAgKiBEZXN0cnVjdGl2ZWx5IHJlbW92ZXMgYW55IGV4aXN0aW5nIGNvbmZpZyBmaWxlIGFuZCByZXNldHMgYWxsXG4gICAqIGtleXMgdG8gZGVmYXVsdHMgaWYgcHJlc2VudCwgd3JpdGluZyB0aGVtIHRvIGEgbmV3IGNvbmZpZy5cbiAgICpcbiAgICogSWYgbm8gZGVmYXVsdHMgYXJlIHByZXNlbnQgbm8gbmV3IGNvbmZpZyBmaWxlIHdpbGwgYmUgY3JlYXRlZC5cbiAgICpcbiAgICogQHJldHVybnMge3ZvaWR9XG4gICAqL1xuICByZXNldCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wYXRoICYmIGV4aXN0c1N5bmModGhpcy5wYXRoKSkge1xuICAgICAgRGVuby5yZW1vdmVTeW5jKHRoaXMucGF0aCwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgLy8gVGhlcmUgYXJlIG5vIGRlZmF1bHQgdmFsdWVzLiBKdXN0IGV4aXQuXG4gICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuZGVmYXVsdFZhbHVlcykubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVGhlcmUgYXJlIGRlZmF1bHQgdmFsdWVzLCBpdGVyYXRlIGFuZCBzYXZlIGVhY2guXG4gICAgT2JqZWN0LmVudHJpZXModGhpcy5kZWZhdWx0VmFsdWVzKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGBzZXR0aW5nICR7a2V5fToke3ZhbHVlfWApO1xuICAgICAgdGhpcy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogRGVzdHJ1Y3RpdmVseSByZXNldCBvbmUgb3IgbW9yZSBrZXlzIHRvIGRlZmF1bHRzIGlmIHRoZXkgZXhpc3QuXG4gICAqXG4gICAqIElmIG5vIGRlZmF1bHRzIGFyZSBwcmVzZW50IHRoZW4gdGhpcyB3aWxsIGJlIGEgbm8tb3AgZm9yIGFsbFxuICAgKiBwcm92aWRlZCBrZXlzLlxuICAgKlxuICAgKiBJZiBkZWZhdWx0cyBhcmUgcHJlc2VudCB0aGVuIGVhY2gga2V5IHRoYXQgbWF0Y2hlcyBvbmUgaW4gZGVmYXVsdHNcbiAgICogd2lsbCBiZSBvdmVyd3JpdHRlbiB3aXRoIHRoZSBkZWZhdWx0IHZhbHVlLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBrZXlzIEFuIEFycmF5IG9mIHN0cmluZyBrZXlzIHRvIHJlc2V0IHRvIGRlZmF1bHRzLlxuICAgKiBAcmV0dXJucyB7dm9pZH1cbiAgICovXG4gIHJlc2V0S2V5cyhrZXlzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLmRlZmF1bHRWYWx1ZXMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgIGlmICh0aGlzLmRlZmF1bHRWYWx1ZXMgJiYga2V5IGluIHRoaXMuZGVmYXVsdFZhbHVlcykge1xuICAgICAgICB0aGlzLnNldChrZXksIHRoaXMuZGVmYXVsdFZhbHVlc1trZXldKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVzdHJ1Y3RpdmVseSByZW1vdmUgYSBzaW5nbGUgaXRlbSBmcm9tIHRoZSBjb25maWcgc3RvcmUuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSB0byBkZWxldGUgZnJvbSB0aGUgY29uZmlnIHN0b3JlLlxuICAgKiBAcmV0dXJucyB7dm9pZH1cbiAgICovXG4gIGRlbGV0ZShrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHsgc3RvcmUgfSA9IHRoaXM7XG4gICAgaWYgKHN0b3JlICYmIGtleSBpbiBzdG9yZSkge1xuICAgICAgZGVsZXRlIHN0b3JlW2tleV07XG4gICAgICB0aGlzLnN0b3JlID0gc3RvcmU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHNpbmdsZSBpdGVtIGZyb20gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IHRvIGdldCBmcm9tIHRoZSBjb25maWcgc3RvcmUuXG4gICAqIEByZXR1cm5zIHtJdGVtVHlwZX0gQSBzaW5nbGUgSXRlbVR5cGUgaXRlbS5cbiAgICovXG4gIGdldChrZXk6IHN0cmluZyk6IEl0ZW1UeXBlIHtcbiAgICBpZiAodGhpcy5zdG9yZSAmJiBrZXkgaW4gdGhpcy5zdG9yZSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmVba2V5XTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgdGhpcy5kZWZhdWx0VmFsdWVzICYmIGtleSBpbiB0aGlzLmRlZmF1bHRWYWx1ZXNcbiAgICApIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRWYWx1ZXNba2V5XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCBhIHNpbmdsZSBpdGVtIGludG8gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IHRvIHdyaXRlIHRvIHRoZSBjb25maWcgc3RvcmUuXG4gICAqIEBwYXJhbSB7SXRlbVR5cGV9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cml0ZSB0byB0aGUgY29uZmlnIHN0b3JlLlxuICAgKiBAcmV0dXJucyB7dm9pZH0gdm9pZC5cbiAgICovXG4gIHNldChcbiAgICBrZXk6IHN0cmluZyxcbiAgICB2YWx1ZTogSXRlbVR5cGUsXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IHsgc3RvcmUgfSA9IHRoaXM7XG5cbiAgICBjb25zdCBpbm5lclNldCA9IChcbiAgICAgIGtleTogc3RyaW5nLFxuICAgICAgdmFsdWU6IEl0ZW1UeXBlLFxuICAgICkgPT4ge1xuICAgICAgc3RvcmVba2V5XSA9IHZhbHVlO1xuICAgIH07XG5cbiAgICBpbm5lclNldChrZXksIHZhbHVlKTtcbiAgICB0aGlzLnN0b3JlID0gc3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IG11bHRpcGxlIGl0ZW1zIGludG8gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICpcbiAgICogQHBhcmFtIHtTdG9yZVR5cGV9IGRhdGEgVGhlIE9iamVjdCB0byB3cml0ZSB0byB0aGUgY29uZmlnIHN0b3JlLlxuICAgKiBAcmV0dXJucyB7dm9pZH0gdm9pZC5cbiAgICovXG4gIHNldE9iamVjdChcbiAgICBkYXRhOiBTdG9yZVR5cGUsXG4gICk6IHZvaWQge1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XG4gICAgICB0aGlzLnNldChrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICAvLyBBbGxvdyBDb25mIGluc3RhbmNlIHRvIGJlIGl0ZXJhYmxlXG4gICpbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnN0b3JlKSkge1xuICAgICAgeWllbGQgW2tleSwgdmFsdWVdO1xuICAgIH1cbiAgfVxufVxuIl19