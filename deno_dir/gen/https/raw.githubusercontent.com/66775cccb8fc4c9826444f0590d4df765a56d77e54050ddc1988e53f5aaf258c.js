import { dirname, resolve, } from "https://deno.land/std@0.133.0/path/mod.ts";
import appPaths from "https://raw.githubusercontent.com/truestamp/deno-app-paths/v1.0.1/mod.ts";
const plainObject = () => Object.create(null);
export default class Config {
    _options = {
        projectName: "",
        configName: "config",
        resetInvalidConfig: false,
        defaults: null,
    };
    defaultValues = plainObject();
    path;
    constructor(options) {
        this._options = {
            ...this._options,
            ...options,
        };
        this.defaultValues = this._options.defaults
            ? this._options.defaults
            : plainObject();
        if (!this._options.projectName || this._options.projectName.trim() === "") {
            throw new Error("the projectName option must be provided and non-empty");
        }
        this._options.projectName = this._options.projectName.trim();
        this.path = resolve(appPaths(this._options.projectName).config, `${this._options.configName}.json`);
    }
    get size() {
        return Object.keys(this.store).length;
    }
    get dir() {
        return dirname(this.path);
    }
    get store() {
        try {
            return {
                ...this.defaultValues,
                ...JSON.parse(Deno.readTextFileSync(this.path)),
            };
        }
        catch (error) {
            switch (error.name) {
                case "SyntaxError":
                    if (this._options.resetInvalidConfig) {
                        this.reset();
                        return { ...this.defaultValues };
                    }
                    break;
                case "NotFound":
                    return { ...this.defaultValues, ...plainObject() };
            }
            throw error;
        }
    }
    set store(data) {
        Deno.mkdirSync(dirname(this.path), { recursive: true });
        Deno.writeTextFileSync(this.path, JSON.stringify(data, null, 2));
    }
    get options() {
        return this._options;
    }
    has(key) {
        return key in this.store;
    }
    reset() {
        Deno.removeSync(this.path, { recursive: true });
        if (Object.keys(this.defaultValues).length === 0) {
            return;
        }
        Object.entries(this.defaultValues).forEach(([key, value]) => {
            this.set(key, value);
        });
        return;
    }
    resetKeys(keys) {
        if (Object.keys(this.defaultValues).length === 0) {
            return;
        }
        for (const key of keys) {
            if (this.defaultValues && key in this.defaultValues) {
                this.set(key, this.defaultValues[key]);
            }
        }
    }
    delete(key) {
        const { store } = this;
        if (store && key in store) {
            delete store[key];
            this.store = store;
        }
    }
    get(key) {
        if (this.store && key in this.store) {
            return this.store[key];
        }
        else if (this.defaultValues && key in this.defaultValues) {
            return this.defaultValues[key];
        }
        else {
            return null;
        }
    }
    set(key, value) {
        const { store } = this;
        const innerSet = (key, value) => {
            store[key] = value;
        };
        innerSet(key, value);
        this.store = store;
    }
    setObject(data) {
        for (const [key, value] of Object.entries(data)) {
            this.set(key, value);
        }
    }
    *[Symbol.iterator]() {
        for (const [key, value] of Object.entries(this.store)) {
            yield [key, value];
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxPQUFPLEVBQ1AsT0FBTyxHQUNSLE1BQU0sMkNBQTJDLENBQUM7QUFFbkQsT0FBTyxRQUFRLE1BQU0sMEVBQTBFLENBQUM7QUFFaEcsTUFBTSxXQUFXLEdBQUcsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQW9COUMsTUFBTSxDQUFDLE9BQU8sT0FBTyxNQUFNO0lBQ2pCLFFBQVEsR0FBcUI7UUFDbkMsV0FBVyxFQUFFLEVBQUU7UUFDZixVQUFVLEVBQUUsUUFBUTtRQUNwQixrQkFBa0IsRUFBRSxLQUFLO1FBQ3pCLFFBQVEsRUFBRSxJQUFJO0tBQ2YsQ0FBQztJQUVGLGFBQWEsR0FBYyxXQUFXLEVBQUUsQ0FBQztJQUV6QyxJQUFJLENBQVM7SUFFYixZQUFhLE9BQXlCO1FBQ3BDLElBQUksQ0FBQyxRQUFRLEdBQUc7WUFDZCxHQUFHLElBQUksQ0FBQyxRQUFRO1lBQ2hCLEdBQUcsT0FBTztTQUNYLENBQUM7UUFHRixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUTtZQUN6QyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRO1lBQ3hCLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVsQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQ3pFLE1BQU0sSUFBSSxLQUFLLENBQUMsdURBQXVELENBQUMsQ0FBQztTQUMxRTtRQUVELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRTdELElBQUksQ0FBQyxJQUFJ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QUssQ0FBQyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUdELENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2hCLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNyRCxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZGlybmFtZSxcbiAgcmVzb2x2ZSxcbn0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3N0ZEAwLjEzMy4wL3BhdGgvbW9kLnRzXCI7XG5cbmltcG9ydCBhcHBQYXRocyBmcm9tIFwiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3RydWVzdGFtcC9kZW5vLWFwcC1wYXRocy92MS4wLjEvbW9kLnRzXCI7XG5cbmNvbnN0IHBsYWluT2JqZWN0ID0gKCkgPT4gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuLy8gUmVjdXJzaXZlIEpTT04gdHlwZTogaHR0cHM6Ly9kZXZibG9ncy5taWNyb3NvZnQuY29tL3R5cGVzY3JpcHQvYW5ub3VuY2luZy10eXBlc2NyaXB0LTMtNy8jbW9yZS1yZWN1cnNpdmUtdHlwZS1hbGlhc2VzXG5leHBvcnQgdHlwZSBKc29uID1cbiAgfCBzdHJpbmdcbiAgfCBudW1iZXJcbiAgfCBib29sZWFuXG4gIHwgbnVsbFxuICB8IEpzb25bXVxuICB8IHsgW2tleTogc3RyaW5nXTogSnNvbiB9XG5cbmV4cG9ydCB0eXBlIFN0b3JlVHlwZSA9IFJlY29yZDxzdHJpbmcsIEpzb24+O1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbmZpZ1BhcmFtZXRlcnMge1xuICBwcm9qZWN0TmFtZTogc3RyaW5nO1xuICBjb25maWdOYW1lPzogc3RyaW5nO1xuICByZXNldEludmFsaWRDb25maWc/OiBib29sZWFuO1xuICBkZWZhdWx0cz86IFN0b3JlVHlwZSB8IG51bGw7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbmZpZyB7XG4gIHByaXZhdGUgX29wdGlvbnM6IENvbmZpZ1BhcmFtZXRlcnMgPSB7XG4gICAgcHJvamVjdE5hbWU6IFwiXCIsXG4gICAgY29uZmlnTmFtZTogXCJjb25maWdcIixcbiAgICByZXNldEludmFsaWRDb25maWc6IGZhbHNlLFxuICAgIGRlZmF1bHRzOiBudWxsLFxuICB9O1xuXG4gIGRlZmF1bHRWYWx1ZXM6IFN0b3JlVHlwZSA9IHBsYWluT2JqZWN0KCk7XG5cbiAgcGF0aDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yIChvcHRpb25zOiBDb25maWdQYXJhbWV0ZXJzKSB7XG4gICAgdGhpcy5fb3B0aW9ucyA9IHtcbiAgICAgIC4uLnRoaXMuX29wdGlvbnMsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH07XG5cbiAgICAvLyBXZXJlIGBkZWZhdWx0c2AgcHJvdmlkZWQ/XG4gICAgdGhpcy5kZWZhdWx0VmFsdWVzID0gdGhpcy5fb3B0aW9ucy5kZWZhdWx0c1xuICAgICAgPyB0aGlzLl9vcHRpb25zLmRlZmF1bHRzXG4gICAgICA6IHBsYWluT2JqZWN0KCk7XG5cbiAgICBpZiAoIXRoaXMuX29wdGlvbnMucHJvamVjdE5hbWUgfHwgdGhpcy5fb3B0aW9ucy5wcm9qZWN0TmFtZS50cmltKCkgPT09IFwiXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInRoZSBwcm9qZWN0TmFtZSBvcHRpb24gbXVzdCBiZSBwcm92aWRlZCBhbmQgbm9uLWVtcHR5XCIpO1xuICAgIH1cblxuICAgIHRoaXMuX29wdGlvbnMucHJvamVjdE5hbWUgPSB0aGlzLl9vcHRpb25zLnByb2plY3ROYW1lLnRyaW0oKTtcblxuICAgIHRoaXMucGF0aCA9IHJlc29sdmUoXG4gICAgICBhcHBQYXRocyh0aGlzLl9vcHRpb25zLnByb2plY3ROYW1lKS5jb25maWcsXG4gICAgICBgJHt0aGlzLl9vcHRpb25zLmNvbmZpZ05hbWV9Lmpzb25gLFxuICAgICk7XG4gIH1cblxuICAvLyBhY2Nlc3NvciBwcm9wZXJ0aWVzIChnZXR0ZXIvc2V0dGVyKVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIG51bWJlciBvZiBjb25maWcgaXRlbXMgc3RvcmVkLlxuICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgY291bnQgb2YgY29uZmlnIGl0ZW1zXG4gICAqL1xuICBnZXQgc2l6ZSgpOiBudW1iZXIge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnN0b3JlKS5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBwYXRoIG9mIHRoZSBjb25maWcgZGlyZWN0b3J5LlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZGlyZWN0b3J5IHBvcnRpb24gb2YgdGhlIGNvbmZpZyBwYXRoXG4gICAqL1xuICBnZXQgZGlyKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGRpcm5hbWUodGhpcy5wYXRoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGNvbnRlbnRzIG9mIHRoZSBjb25maWcgc3RvcmUsIGluY2x1ZGluZyBkZWZhdWx0cyBpZiBwcmVzZW50LlxuICAgKiBAcmV0dXJucyB7U3RvcmVUeXBlfSBUaGUgY29uZmlnIHN0b3JlXG4gICAqL1xuICBnZXQgc3RvcmUoKTogU3RvcmVUeXBlIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4udGhpcy5kZWZhdWx0VmFsdWVzLFxuICAgICAgICAuLi5KU09OLnBhcnNlKERlbm8ucmVhZFRleHRGaWxlU3luYyh0aGlzLnBhdGgpKSxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHN3aXRjaCAoZXJyb3IubmFtZSkge1xuICAgICAgICBjYXNlIFwiU3ludGF4RXJyb3JcIjpcbiAgICAgICAgICAvLyBVbmFibGUgdG8gcmVhZCB0aGUgSlNPTiBmaWxlLiBSZXNldCBpdCB0byBkZWZhdWx0cyBpZiB0aGF0IGlzIHRoZVxuICAgICAgICAgIC8vIGRlc2lyZWQgYmVoYXZpb3IuXG4gICAgICAgICAgaWYgKHRoaXMuX29wdGlvbnMucmVzZXRJbnZhbGlkQ29uZmlnKSB7XG4gICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICByZXR1cm4geyAuLi50aGlzLmRlZmF1bHRWYWx1ZXMgfTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJOb3RGb3VuZFwiOlxuICAgICAgICAgIHJldHVybiB7IC4uLnRoaXMuZGVmYXVsdFZhbHVlcywgLi4ucGxhaW5PYmplY3QoKSB9O1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBjb250ZW50cyBvZiB0aGUgY29uZmlnIHN0b3JlIHRvIGFuIE9iamVjdC5cbiAgICpcbiAgICogQHBhcmFtIHtTdG9yZVR5cGV9IGRhdGFcbiAgICogQHJldHVybnMge3ZvaWR9XG4gICAqL1xuICBzZXQgc3RvcmUoZGF0YTogU3RvcmVUeXBlKSB7XG4gICAgRGVuby5ta2RpclN5bmMoZGlybmFtZSh0aGlzLnBhdGgpLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICBEZW5vLndyaXRlVGV4dEZpbGVTeW5jKHRoaXMucGF0aCwgSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMikpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgY29uZmlnIHN0b3JlIHBhcmFtZXRlcnMuXG4gICAqXG4gICAqIEByZXR1cm5zIHtDb25maWdQYXJhbWV0ZXJzfVxuICAgKi9cbiAgZ2V0IG9wdGlvbnMoKTogQ29uZmlnUGFyYW1ldGVycyB7XG4gICAgcmV0dXJuIHRoaXMuX29wdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBib29sZWFuIHdoZXRoZXIgYGtleWAgaXMgcHJlc2VudCBpbiB0aGUgY29uZmlnIHN0b3JlLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgdG8gc2VhcmNoIGZvci5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IEtleSBleGlzdHMgaW4gY29uZmlnIHN0b3JlP1xuICAgKi9cbiAgaGFzKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGtleSBpbiB0aGlzLnN0b3JlO1xuICB9XG5cbiAgLy9cblxuICAvKipcbiAgICogRGVzdHJ1Y3RpdmVseSByZW1vdmVzIGFueSBleGlzdGluZyBjb25maWcgZmlsZSBhbmQgcmVzZXRzIGFsbFxuICAgKiBrZXlzIHRvIGRlZmF1bHRzIGlmIHByZXNlbnQsIHdyaXRpbmcgdGhlbSB0byBhIG5ldyBjb25maWcuXG4gICAqXG4gICAqIElmIG5vIGRlZmF1bHRzIGFyZSBwcmVzZW50IG5vIG5ldyBjb25maWcgZmlsZSB3aWxsIGJlIGNyZWF0ZWQuXG4gICAqXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgcmVzZXQoKTogdm9pZCB7XG4gICAgRGVuby5yZW1vdmVTeW5jKHRoaXMucGF0aCwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cbiAgICAvLyBUaGVyZSBhcmUgbm8gZGVmYXVsdCB2YWx1ZXMuIEp1c3QgZXhpdC5cbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5kZWZhdWx0VmFsdWVzKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBUaGVyZSBhcmUgZGVmYXVsdCB2YWx1ZXMsIGl0ZXJhdGUgYW5kIHNhdmUgZWFjaC5cbiAgICBPYmplY3QuZW50cmllcyh0aGlzLmRlZmF1bHRWYWx1ZXMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgLy8gY29uc29sZS5sb2coYHNldHRpbmcgJHtrZXl9OiR7dmFsdWV9YCk7XG4gICAgICB0aGlzLnNldChrZXksIHZhbHVlKTtcbiAgICB9KTtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXN0cnVjdGl2ZWx5IHJlc2V0IG9uZSBvciBtb3JlIGtleXMgdG8gZGVmYXVsdHMgaWYgdGhleSBleGlzdC5cbiAgICpcbiAgICogSWYgbm8gZGVmYXVsdHMgYXJlIHByZXNlbnQgdGhlbiB0aGlzIHdpbGwgYmUgYSBuby1vcCBmb3IgYWxsXG4gICAqIHByb3ZpZGVkIGtleXMuXG4gICAqXG4gICAqIElmIGRlZmF1bHRzIGFyZSBwcmVzZW50IHRoZW4gZWFjaCBrZXkgdGhhdCBtYXRjaGVzIG9uZSBpbiBkZWZhdWx0c1xuICAgKiB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIGRlZmF1bHQgdmFsdWUuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nW119IGtleXMgQW4gQXJyYXkgb2Ygc3RyaW5nIGtleXMgdG8gcmVzZXQgdG8gZGVmYXVsdHMuXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgcmVzZXRLZXlzKGtleXM6IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuZGVmYXVsdFZhbHVlcykubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgaWYgKHRoaXMuZGVmYXVsdFZhbHVlcyAmJiBrZXkgaW4gdGhpcy5kZWZhdWx0VmFsdWVzKSB7XG4gICAgICAgIHRoaXMuc2V0KGtleSwgdGhpcy5kZWZhdWx0VmFsdWVzW2tleV0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZXN0cnVjdGl2ZWx5IHJlbW92ZSBhIHNpbmdsZSBpdGVtIGZyb20gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IHRvIGRlbGV0ZSBmcm9tIHRoZSBjb25maWcgc3RvcmUuXG4gICAqIEByZXR1cm5zIHt2b2lkfVxuICAgKi9cbiAgZGVsZXRlKGtleTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgeyBzdG9yZSB9ID0gdGhpcztcbiAgICBpZiAoc3RvcmUgJiYga2V5IGluIHN0b3JlKSB7XG4gICAgICBkZWxldGUgc3RvcmVba2V5XTtcbiAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgc2luZ2xlIGl0ZW0gZnJvbSB0aGUgY29uZmlnIHN0b3JlLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBrZXkgdG8gZ2V0IGZyb20gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICogQHJldHVybnMge0pzb259IEpzb24uXG4gICAqL1xuICBnZXQoa2V5OiBzdHJpbmcpOiBKc29uIHtcbiAgICBpZiAodGhpcy5zdG9yZSAmJiBrZXkgaW4gdGhpcy5zdG9yZSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmVba2V5XTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgdGhpcy5kZWZhdWx0VmFsdWVzICYmIGtleSBpbiB0aGlzLmRlZmF1bHRWYWx1ZXNcbiAgICApIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRWYWx1ZXNba2V5XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCBhIHNpbmdsZSBpdGVtIGludG8gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IHRvIHdyaXRlIHRvIHRoZSBjb25maWcgc3RvcmUuXG4gICAqIEBwYXJhbSB7SnNvbn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyaXRlIHRvIHRoZSBjb25maWcgc3RvcmUuXG4gICAqIEByZXR1cm5zIHt2b2lkfSB2b2lkLlxuICAgKi9cbiAgc2V0KFxuICAgIGtleTogc3RyaW5nLFxuICAgIHZhbHVlOiBKc29uLFxuICApOiB2b2lkIHtcbiAgICBjb25zdCB7IHN0b3JlIH0gPSB0aGlzO1xuXG4gICAgY29uc3QgaW5uZXJTZXQgPSAoXG4gICAgICBrZXk6IHN0cmluZyxcbiAgICAgIHZhbHVlOiBKc29uLFxuICAgICkgPT4ge1xuICAgICAgc3RvcmVba2V5XSA9IHZhbHVlO1xuICAgIH07XG5cbiAgICBpbm5lclNldChrZXksIHZhbHVlKTtcbiAgICB0aGlzLnN0b3JlID0gc3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogU2V0IG11bHRpcGxlIGl0ZW1zIGludG8gdGhlIGNvbmZpZyBzdG9yZS5cbiAgICpcbiAgICogQHBhcmFtIHtTdG9yZVR5cGV9IGRhdGEgVGhlIE9iamVjdCB0byB3cml0ZSB0byB0aGUgY29uZmlnIHN0b3JlLlxuICAgKiBAcmV0dXJucyB7dm9pZH0gdm9pZC5cbiAgICovXG4gIHNldE9iamVjdChcbiAgICBkYXRhOiBTdG9yZVR5cGUsXG4gICk6IHZvaWQge1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XG4gICAgICB0aGlzLnNldChrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICAvLyBBbGxvdyBDb25mIGluc3RhbmNlIHRvIGJlIGl0ZXJhYmxlXG4gICpbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0aGlzLnN0b3JlKSkge1xuICAgICAgeWllbGQgW2tleSwgdmFsdWVdO1xuICAgIH1cbiAgfVxufVxuIl19