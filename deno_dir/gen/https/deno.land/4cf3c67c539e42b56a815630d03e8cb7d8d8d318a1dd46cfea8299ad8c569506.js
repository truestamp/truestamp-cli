import { base64url } from "./deps.ts";
import { create as createSignature, verify as verifySignature } from "./signature.ts";
import { verify as verifyAlgorithm } from "./algorithm.ts";
export const encoder = new TextEncoder();
export const decoder = new TextDecoder();
/**
 * JWT ยง4.1.4: Implementers MAY provide for some small leeway to account for
 * clock skew.
 */ function isExpired(exp, leeway) {
    return exp + leeway < Date.now() / 1000;
}
function isTooEarly(nbf, leeway) {
    return nbf - leeway > Date.now() / 1000;
}
function isObject(obj) {
    return obj !== null && typeof obj === "object" && Array.isArray(obj) === false;
}
// deno-lint-ignore no-explicit-any
function is3Tuple(arr) {
    return arr.length === 3;
}
function hasInvalidTimingClaims(...claimValues) {
    return claimValues.some((claimValue)=>claimValue !== undefined ? typeof claimValue !== "number" : false);
}
/**
 * Takes a `jwt` and returns a 3-tuple `[unknown, unknown, Uint8Array]` if the
 * jwt has a valid _serialization_. Otherwise it throws an `Error`. This function
 * does **not** verify the digital signature.
 */ export function decode(jwt) {
    try {
        const arr = jwt.split(".").map(base64url.decode).map((uint8Array, index)=>index === 0 || index === 1 ? JSON.parse(decoder.decode(uint8Array)) : uint8Array);
        if (is3Tuple(arr)) return arr;
        else throw new Error();
    } catch  {
        throw Error("The serialization of the jwt is invalid.");
    }
}
/** It does **not** verify the digital signature. */ export function validate(// deno-lint-ignore no-explicit-any
[header, payload, signature], { expLeeway =1 , nbfLeeway =1  } = {}) {
    if (typeof header?.alg !== "string") {
        throw new Error(`The jwt's 'alg' header parameter value must be a string.`);
    }
    /*
   * JWT ยง7.2: Verify that the resulting octet sequence is a UTF-8-encoded
   * representation of a completely valid JSON object conforming to RFC 7159;
   * let the JWT Claims Set be this JSON object.
   */ if (isObject(payload)) {
        if (hasInvalidTimingClaims(payload.exp, payload.nbf)) {
            throw new Error(`The jwt has an invalid 'exp' or 'nbf' claim.`);
        }
        if (typeof payload.exp === "number" && isExpired(payload.exp, expLeeway)) {
            throw RangeError("The jwt is expired.");
        }
        if (typeof payload.nbf === "number" && isTooEarly(payload.nbf, nbfLeeway)) {
            throw RangeError("The jwt is used too early.");
        }
        return {
            header,
            payload,
            signature
        };
    } else {
        throw new Error(`The jwt claims set is not a JSON object.`);
    }
}
/**
 * Takes jwt, `CryptoKey` and `VerifyOptions` and returns the `Payload` of the
 * jwt if the jwt is valid. Otherwise it throws an `Error`.
 */ export async function verify(jwt, key, options) {
    const { header , payload , signature  } = validate(decode(jwt), options);
    if (verifyAlgorithm(header.alg, key)) {
        if (!await verifySignature(signature, key, header.alg, jwt.slice(0, jwt.lastIndexOf(".")))) {
            throw new Error("The jwt's signature does not match the verification signature.");
        }
        return payload;
    } else {
        throw new Error(`The jwt's alg '${header.alg}' does not match the key's algorithm.`);
    }
}
/**
 * JWT ยง3: JWTs represent a set of claims as a JSON object that is encoded in
 * a JWS and/or JWE structure. This JSON object is the JWT Claims Set.
 * JSW ยง7.1: The JWS Compact Serialization represents digitally signed or MACed
 * content as a compact, URL-safe string. This string is:
 *       BASE64URL(UTF8(JWS Protected Header)) || '.' ||
 *       BASE64URL(JWS Payload) || '.' ||
 *       BASE64URL(JWS Signature)
 */ function createSigningInput(header, payload) {
    return `${base64url.encode(encoder.encode(JSON.stringify(header)))}.${base64url.encode(encoder.encode(JSON.stringify(payload)))}`;
}
/**
 * Takes `Header`, `Payload` and `CryptoKey` and returns the url-safe encoded
 * jwt.
 */ export async function create(header, payload, key) {
    if (verifyAlgorithm(header.alg, key)) {
        const signingInput = createSigningInput(header, payload);
        const signature = await createSignature(header.alg, key, signingInput);
        return `${signingInput}.${signature}`;
    } else {
        throw new Error(`The jwt's alg '${header.alg}' does not match the key's algorithm.`);
    }
}
/**
 * This helper function simplifies setting a `NumericDate`. It takes either a
 * `Date` object or a `number` (in seconds) and returns the `number` of seconds
 * from 1970-01-01T00:00:00Z UTC until the specified UTC date/time.
 */ export function getNumericDate(exp) {
    return Math.round((exp instanceof Date ? exp.getTime() : Date.now() + exp * 1000) / 1000);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvZGp3dEB2Mi43L21vZC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBiYXNlNjR1cmwgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQge1xuICBjcmVhdGUgYXMgY3JlYXRlU2lnbmF0dXJlLFxuICB2ZXJpZnkgYXMgdmVyaWZ5U2lnbmF0dXJlLFxufSBmcm9tIFwiLi9zaWduYXR1cmUudHNcIjtcbmltcG9ydCB7IHZlcmlmeSBhcyB2ZXJpZnlBbGdvcml0aG0gfSBmcm9tIFwiLi9hbGdvcml0aG0udHNcIjtcblxuaW1wb3J0IHR5cGUgeyBBbGdvcml0aG0gfSBmcm9tIFwiLi9hbGdvcml0aG0udHNcIjtcblxuLyoqXG4gKiBKV1QgwqcxOiBKV1RzIGVuY29kZSBjbGFpbXMgdG8gYmUgdHJhbnNtaXR0ZWQgYXMgYSBKU09OIFtSRkM3MTU5XSBvYmplY3QgWy4uLl0uXG4gKiBKV1Qgwqc0LjE6IFRoZSBmb2xsb3dpbmcgQ2xhaW0gTmFtZXMgYXJlIHJlZ2lzdGVyZWQgaW4gdGhlIElBTkFcbiAqIFwiSlNPTiBXZWIgVG9rZW4gQ2xhaW1zXCIgcmVnaXN0cnkgZXN0YWJsaXNoZWQgYnkgU2VjdGlvbiAxMC4xLiBOb25lIG9mIHRoZVxuICogY2xhaW1zIGRlZmluZWQgYmVsb3cgYXJlIGludGVuZGVkIHRvIGJlIG1hbmRhdG9yeSB0byB1c2Ugb3IgaW1wbGVtZW50IGluIGFsbFxuICogY2FzZXMsIGJ1dCByYXRoZXIgdGhleSBwcm92aWRlIGEgc3RhcnRpbmcgcG9pbnQgZm9yIGEgc2V0IG9mIHVzZWZ1bCxcbiAqIGludGVyb3BlcmFibGUgY2xhaW1zLlxuICogQXBwbGljYXRpb25zIHVzaW5nIEpXVHMgc2hvdWxkIGRlZmluZSB3aGljaCBzcGVjaWZpYyBjbGFpbXMgdGhleSB1c2UgYW5kIHdoZW5cbiAqIHRoZXkgYXJlIHJlcXVpcmVkIG9yIG9wdGlvbmFsLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFBheWxvYWQge1xuICBpc3M/OiBzdHJpbmc7XG4gIHN1Yj86IHN0cmluZztcbiAgYXVkPzogc3RyaW5nW10gfCBzdHJpbmc7XG4gIGV4cD86IG51bWJlcjtcbiAgbmJmPzogbnVtYmVyO1xuICBpYXQ/OiBudW1iZXI7XG4gIGp0aT86IHN0cmluZztcbiAgW2tleTogc3RyaW5nXTogdW5rbm93bjtcbn1cblxuLyoqXG4gKiBKV1Mgwqc0LjEuMTogVGhlIFwiYWxnXCIgdmFsdWUgaXMgYSBjYXNlLXNlbnNpdGl2ZSBBU0NJSSBzdHJpbmcgY29udGFpbmluZyBhXG4gKiBTdHJpbmdPclVSSSB2YWx1ZS4gVGhpcyBIZWFkZXIgUGFyYW1ldGVyIE1VU1QgYmUgcHJlc2VudCBhbmQgTVVTVCBiZVxuICogdW5kZXJzdG9vZCBhbmQgcHJvY2Vzc2VkIGJ5IGltcGxlbWVudGF0aW9ucy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWFkZXIge1xuICBhbGc6IEFsZ29yaXRobTtcbiAgW2tleTogc3RyaW5nXTogdW5rbm93bjtcbn1cblxudHlwZSBWZXJpZnlPcHRpb25zID0geyBleHBMZWV3YXk/OiBudW1iZXI7IG5iZkxlZXdheT86IG51bWJlciB9O1xuXG5leHBvcnQgY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xuZXhwb3J0IGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTtcblxuLyoqXG4gKiBKV1Qgwqc0LjEuNDogSW1wbGVtZW50ZXJzIE1BWSBwcm92aWRlIGZvciBzb21lIHNtYWxsIGxlZXdheSB0byBhY2NvdW50IGZvclxuICogY2xvY2sgc2tldy5cbiAqL1xuZnVuY3Rpb24gaXNFeHBpcmVkKGV4cDogbnVtYmVyLCBsZWV3YXk6IG51bWJlcik6IGJvb2xlYW4ge1xuICByZXR1cm4gZXhwICsgbGVld2F5IDwgRGF0ZS5ub3coKSAvIDEwMDA7XG59XG5cbmZ1bmN0aW9uIGlzVG9vRWFybHkobmJmOiBudW1iZXIsIGxlZXdheTogbnVtYmVyKTogYm9vbGVhbiB7XG4gIHJldHVybiBuYmYgLSBsZWV3YXkgPiBEYXRlLm5vdygpIC8gMTAwMDtcbn1cblxuZnVuY3Rpb24gaXNPYmplY3Qob2JqOiB1bmtub3duKTogb2JqIGlzIFJlY29yZDxzdHJpbmcsIHVua25vd24+IHtcbiAgcmV0dXJuIChcbiAgICBvYmogIT09IG51bGwgJiYgdHlwZW9mIG9iaiA9PT0gXCJvYmplY3RcIiAmJiBBcnJheS5pc0FycmF5KG9iaikgPT09IGZhbHNlXG4gICk7XG59XG5cbi8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG5mdW5jdGlvbiBpczNUdXBsZShhcnI6IGFueVtdKTogYXJyIGlzIFt1bmtub3duLCB1bmtub3duLCBVaW50OEFycmF5XSB7XG4gIHJldHVybiBhcnIubGVuZ3RoID09PSAzO1xufVxuXG5mdW5jdGlvbiBoYXNJbnZhbGlkVGltaW5nQ2xhaW1zKC4uLmNsYWltVmFsdWVzOiB1bmtub3duW10pOiBib29sZWFuIHtcbiAgcmV0dXJuIGNsYWltVmFsdWVzLnNvbWUoKGNsYWltVmFsdWUpID0+XG4gICAgY2xhaW1WYWx1ZSAhPT0gdW5kZWZpbmVkID8gdHlwZW9mIGNsYWltVmFsdWUgIT09IFwibnVtYmVyXCIgOiBmYWxzZVxuICApO1xufVxuXG4vKipcbiAqIFRha2VzIGEgYGp3dGAgYW5kIHJldHVybnMgYSAzLXR1cGxlIGBbdW5rbm93biwgdW5rbm93biwgVWludDhBcnJheV1gIGlmIHRoZVxuICogand0IGhhcyBhIHZhbGlkIF9zZXJpYWxpemF0aW9uXy4gT3RoZXJ3aXNlIGl0IHRocm93cyBhbiBgRXJyb3JgLiBUaGlzIGZ1bmN0aW9uXG4gKiBkb2VzICoqbm90KiogdmVyaWZ5IHRoZSBkaWdpdGFsIHNpZ25hdHVyZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZShcbiAgand0OiBzdHJpbmcsXG4pOiBbaGVhZGVyOiB1bmtub3duLCBwYXlsb2FkOiB1bmtub3duLCBzaWduYXR1cmU6IFVpbnQ4QXJyYXldIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcnIgPSBqd3RcbiAgICAgIC5zcGxpdChcIi5cIilcbiAgICAgIC5tYXAoYmFzZTY0dXJsLmRlY29kZSlcbiAgICAgIC5tYXAoKHVpbnQ4QXJyYXksIGluZGV4KSA9PlxuICAgICAgICBpbmRleCA9PT0gMCB8fCBpbmRleCA9PT0gMVxuICAgICAgICAgID8gSlNPTi5wYXJzZShkZWNvZGVyLmRlY29kZSh1aW50OEFycmF5KSlcbiAgICAgICAgICA6IHVpbnQ4QXJyYXlcbiAgICAgICk7XG4gICAgaWYgKGlzM1R1cGxlKGFycikpIHJldHVybiBhcnI7XG4gICAgZWxzZSB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgfSBjYXRjaCB7XG4gICAgdGhyb3cgRXJyb3IoXCJUaGUgc2VyaWFsaXphdGlvbiBvZiB0aGUgand0IGlzIGludmFsaWQuXCIpO1xuICB9XG59XG5cbi8qKiBJdCBkb2VzICoqbm90KiogdmVyaWZ5IHRoZSBkaWdpdGFsIHNpZ25hdHVyZS4gKi9cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZShcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgW2hlYWRlciwgcGF5bG9hZCwgc2lnbmF0dXJlXTogW2FueSwgYW55LCBVaW50OEFycmF5XSxcbiAgeyBleHBMZWV3YXkgPSAxLCBuYmZMZWV3YXkgPSAxIH06IFZlcmlmeU9wdGlvbnMgPSB7fSxcbik6IHtcbiAgaGVhZGVyOiBIZWFkZXI7XG4gIHBheWxvYWQ6IFBheWxvYWQ7XG4gIHNpZ25hdHVyZTogVWludDhBcnJheTtcbn0ge1xuICBpZiAodHlwZW9mIGhlYWRlcj8uYWxnICE9PSBcInN0cmluZ1wiKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgand0J3MgJ2FsZycgaGVhZGVyIHBhcmFtZXRlciB2YWx1ZSBtdXN0IGJlIGEgc3RyaW5nLmApO1xuICB9XG5cbiAgLypcbiAgICogSldUIMKnNy4yOiBWZXJpZnkgdGhhdCB0aGUgcmVzdWx0aW5nIG9jdGV0IHNlcXVlbmNlIGlzIGEgVVRGLTgtZW5jb2RlZFxuICAgKiByZXByZXNlbnRhdGlvbiBvZiBhIGNvbXBsZXRlbHkgdmFsaWQgSlNPTiBvYmplY3QgY29uZm9ybWluZyB0byBSRkMgNzE1OTtcbiAgICogbGV0IHRoZSBKV1QgQ2xhaW1zIFNldCBiZSB0aGlzIEpTT04gb2JqZWN0LlxuICAgKi9cbiAgaWYgKGlzT2JqZWN0KHBheWxvYWQpKSB7XG4gICAgaWYgKGhhc0ludmFsaWRUaW1pbmdDbGFpbXMocGF5bG9hZC5leHAsIHBheWxvYWQubmJmKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgand0IGhhcyBhbiBpbnZhbGlkICdleHAnIG9yICduYmYnIGNsYWltLmApO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgcGF5bG9hZC5leHAgPT09IFwibnVtYmVyXCIgJiYgaXNFeHBpcmVkKHBheWxvYWQuZXhwLCBleHBMZWV3YXkpKSB7XG4gICAgICB0aHJvdyBSYW5nZUVycm9yKFwiVGhlIGp3dCBpcyBleHBpcmVkLlwiKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHBheWxvYWQubmJmID09PSBcIm51bWJlclwiICYmIGlzVG9vRWFybHkocGF5bG9hZC5uYmYsIG5iZkxlZXdheSkpIHtcbiAgICAgIHRocm93IFJhbmdlRXJyb3IoXCJUaGUgand0IGlzIHVzZWQgdG9vIGVhcmx5LlwiKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaGVhZGVyLFxuICAgICAgcGF5bG9hZCxcbiAgICAgIHNpZ25hdHVyZSxcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGp3dCBjbGFpbXMgc2V0IGlzIG5vdCBhIEpTT04gb2JqZWN0LmApO1xuICB9XG59XG5cbi8qKlxuICogVGFrZXMgand0LCBgQ3J5cHRvS2V5YCBhbmQgYFZlcmlmeU9wdGlvbnNgIGFuZCByZXR1cm5zIHRoZSBgUGF5bG9hZGAgb2YgdGhlXG4gKiBqd3QgaWYgdGhlIGp3dCBpcyB2YWxpZC4gT3RoZXJ3aXNlIGl0IHRocm93cyBhbiBgRXJyb3JgLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5KFxuICBqd3Q6IHN0cmluZyxcbiAga2V5OiBDcnlwdG9LZXkgfCBudWxsLFxuICBvcHRpb25zPzogVmVyaWZ5T3B0aW9ucyxcbik6IFByb21pc2U8UGF5bG9hZD4ge1xuICBjb25zdCB7IGhlYWRlciwgcGF5bG9hZCwgc2lnbmF0dXJlIH0gPSB2YWxpZGF0ZShkZWNvZGUoand0KSwgb3B0aW9ucyk7XG4gIGlmICh2ZXJpZnlBbGdvcml0aG0oaGVhZGVyLmFsZywga2V5KSkge1xuICAgIGlmIChcbiAgICAgICEoYXdhaXQgdmVyaWZ5U2lnbmF0dXJlKFxuICAgICAgICBzaWduYXR1cmUsXG4gICAgICAgIGtleSxcbiAgICAgICAgaGVhZGVyLmFsZyxcbiAgICAgICAgand0LnNsaWNlKDAsIGp3dC5sYXN0SW5kZXhPZihcIi5cIikpLFxuICAgICAgKSlcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJUaGUgand0J3Mgc2lnbmF0dXJlIGRvZXMgbm90IG1hdGNoIHRoZSB2ZXJpZmljYXRpb24gc2lnbmF0dXJlLlwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF5bG9hZDtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIGp3dCdzIGFsZyAnJHtoZWFkZXIuYWxnfScgZG9lcyBub3QgbWF0Y2ggdGhlIGtleSdzIGFsZ29yaXRobS5gLFxuICAgICk7XG4gIH1cbn1cblxuLyoqXG4gKiBKV1QgwqczOiBKV1RzIHJlcHJlc2VudCBhIHNldCBvZiBjbGFpbXMgYXMgYSBKU09OIG9iamVjdCB0aGF0IGlzIGVuY29kZWQgaW5cbiAqIGEgSldTIGFuZC9vciBKV0Ugc3RydWN0dXJlLiBUaGlzIEpTT04gb2JqZWN0IGlzIHRoZSBKV1QgQ2xhaW1zIFNldC5cbiAqIEpTVyDCpzcuMTogVGhlIEpXUyBDb21wYWN0IFNlcmlhbGl6YXRpb24gcmVwcmVzZW50cyBkaWdpdGFsbHkgc2lnbmVkIG9yIE1BQ2VkXG4gKiBjb250ZW50IGFzIGEgY29tcGFjdCwgVVJMLXNhZmUgc3RyaW5nLiBUaGlzIHN0cmluZyBpczpcbiAqICAgICAgIEJBU0U2NFVSTChVVEY4KEpXUyBQcm90ZWN0ZWQgSGVhZGVyKSkgfHwgJy4nIHx8XG4gKiAgICAgICBCQVNFNjRVUkwoSldTIFBheWxvYWQpIHx8ICcuJyB8fFxuICogICAgICAgQkFTRTY0VVJMKEpXUyBTaWduYXR1cmUpXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVNpZ25pbmdJbnB1dChoZWFkZXI6IEhlYWRlciwgcGF5bG9hZDogUGF5bG9hZCk6IHN0cmluZyB7XG4gIHJldHVybiBgJHtiYXNlNjR1cmwuZW5jb2RlKGVuY29kZXIuZW5jb2RlKEpTT04uc3RyaW5naWZ5KGhlYWRlcikpKX0uJHtcbiAgICBiYXNlNjR1cmwuZW5jb2RlKGVuY29kZXIuZW5jb2RlKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKSlcbiAgfWA7XG59XG5cbi8qKlxuICogVGFrZXMgYEhlYWRlcmAsIGBQYXlsb2FkYCBhbmQgYENyeXB0b0tleWAgYW5kIHJldHVybnMgdGhlIHVybC1zYWZlIGVuY29kZWRcbiAqIGp3dC5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZShcbiAgaGVhZGVyOiBIZWFkZXIsXG4gIHBheWxvYWQ6IFBheWxvYWQsXG4gIGtleTogQ3J5cHRvS2V5IHwgbnVsbCxcbik6IFByb21pc2U8c3RyaW5nPiB7XG4gIGlmICh2ZXJpZnlBbGdvcml0aG0oaGVhZGVyLmFsZywga2V5KSkge1xuICAgIGNvbnN0IHNpZ25pbmdJbnB1dCA9IGNyZWF0ZVNpZ25pbmdJbnB1dChoZWFkZXIsIHBheWxvYWQpO1xuICAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IGNyZWF0ZVNpZ25hdHVyZShoZWFkZXIuYWxnLCBrZXksIHNpZ25pbmdJbnB1dCk7XG5cbiAgICByZXR1cm4gYCR7c2lnbmluZ0lucHV0fS4ke3NpZ25hdHVyZX1gO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBUaGUgand0J3MgYWxnICcke2hlYWRlci5hbGd9JyBkb2VzIG5vdCBtYXRjaCB0aGUga2V5J3MgYWxnb3JpdGhtLmAsXG4gICAgKTtcbiAgfVxufVxuXG4vKipcbiAqIFRoaXMgaGVscGVyIGZ1bmN0aW9uIHNpbXBsaWZpZXMgc2V0dGluZyBhIGBOdW1lcmljRGF0ZWAuIEl0IHRha2VzIGVpdGhlciBhXG4gKiBgRGF0ZWAgb2JqZWN0IG9yIGEgYG51bWJlcmAgKGluIHNlY29uZHMpIGFuZCByZXR1cm5zIHRoZSBgbnVtYmVyYCBvZiBzZWNvbmRzXG4gKiBmcm9tIDE5NzAtMDEtMDFUMDA6MDA6MDBaIFVUQyB1bnRpbCB0aGUgc3BlY2lmaWVkIFVUQyBkYXRlL3RpbWUuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXROdW1lcmljRGF0ZShleHA6IG51bWJlciB8IERhdGUpOiBudW1iZXIge1xuICByZXR1cm4gTWF0aC5yb3VuZChcbiAgICAoZXhwIGluc3RhbmNlb2YgRGF0ZSA/IGV4cC5nZXRUaW1lKCkgOiBEYXRlLm5vdygpICsgZXhwICogMTAwMCkgLyAxMDAwLFxuICApO1xufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsU0FBUyxRQUFRLFdBQVcsQ0FBQztBQUN0QyxTQUNFLE1BQU0sSUFBSSxlQUFlLEVBQ3pCLE1BQU0sSUFBSSxlQUFlLFFBQ3BCLGdCQUFnQixDQUFDO0FBQ3hCLFNBQVMsTUFBTSxJQUFJLGVBQWUsUUFBUSxnQkFBZ0IsQ0FBQztBQXFDM0QsT0FBTyxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBQ3pDLE9BQU8sTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUV6Qzs7O0NBR0MsR0FDRCxTQUFTLFNBQVMsQ0FBQyxHQUFXLEVBQUUsTUFBYyxFQUFXO0lBQ3ZELE9BQU8sR0FBRyxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQzFD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