import { base64url } from "./deps.ts";
import { create as createSignature, verify as verifySignature, } from "./signature.ts";
import { verify as verifyAlgorithm } from "./algorithm.ts";
export const encoder = new TextEncoder();
export const decoder = new TextDecoder();
function isExpired(exp, leeway = 0) {
    return exp + leeway < Date.now() / 1000;
}
function isTooEarly(nbf, leeway = 0) {
    return nbf - leeway > Date.now() / 1000;
}
function isObject(obj) {
    return (obj !== null && typeof obj === "object" && Array.isArray(obj) === false);
}
function is3Tuple(arr) {
    return arr.length === 3;
}
function hasInvalidTimingClaims(...claimValues) {
    return claimValues.some((claimValue) => claimValue !== undefined ? typeof claimValue !== "number" : false);
}
export function decode(jwt) {
    try {
        const arr = jwt
            .split(".")
            .map(base64url.decode)
            .map((uint8Array, index) => index === 0 || index === 1
            ? JSON.parse(decoder.decode(uint8Array))
            : uint8Array);
        if (is3Tuple(arr))
            return arr;
        else
            throw new Error();
    }
    catch {
        throw Error("The serialization of the jwt is invalid.");
    }
}
export function validate([header, payload, signature]) {
    if (typeof header?.alg !== "string") {
        throw new Error(`The jwt's alg header parameter value must be a string.`);
    }
    if (isObject(payload)) {
        if (hasInvalidTimingClaims(payload.exp, payload.nbf)) {
            throw new Error(`The jwt has an invalid 'exp' or 'nbf' claim.`);
        }
        if (typeof payload.exp === "number" && isExpired(payload.exp, 1)) {
            throw RangeError("The jwt is expired.");
        }
        if (typeof payload.nbf === "number" && isTooEarly(payload.nbf, 1)) {
            throw RangeError("The jwt is used too early.");
        }
        return {
            header,
            payload,
            signature,
        };
    }
    else {
        throw new Error(`The jwt claims set is not a JSON object.`);
    }
}
export async function verify(jwt, key) {
    const { header, payload, signature } = validate(decode(jwt));
    if (verifyAlgorithm(header.alg, key)) {
        if (!(await verifySignature(signature, key, header.alg, jwt.slice(0, jwt.lastIndexOf("."))))) {
            throw new Error("The jwt's signature does not match the verification signature.");
        }
        return payload;
    }
    else {
        throw new Error(`The jwt's alg '${header.alg}' does not match the key's algorithm.`);
    }
}
function createSigningInput(header, payload) {
    return `${base64url.encode(encoder.encode(JSON.stringify(header)))}.${base64url.encode(encoder.encode(JSON.stringify(payload)))}`;
}
export async function create(header, payload, key) {
    if (verifyAlgorithm(header.alg, key)) {
        const signingInput = createSigningInput(header, payload);
        const signature = await createSignature(header.alg, key, signingInput);
        return `${signingInput}.${signature}`;
    }
    else {
        throw new Error(`The jwt's alg '${header.alg}' does not match the key's algorithm.`);
    }
}
export function getNumericDate(exp) {
    return Math.round((exp instanceof Date ? exp.getTime() : Date.now() + exp * 1000) / 1000);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUNMLE1BQU0sSUFBSSxlQUFlLEVBQ3pCLE1BQU0sSUFBSSxlQUFlLEdBQzFCLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLE1BQU0sSUFBSSxlQUFlLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQWtDM0QsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFDekMsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFNekMsU0FBUyxTQUFTLENBQUMsR0FBVyxFQUFFLE1BQU0sR0FBRyxDQUFDO0lBQ3hDLE9BQU8sR0FBRyxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQzFDLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxHQUFXLEVBQUUsTUFBTSxHQUFHLENBQUM7SUFDekMsT0FBTyxHQUFHLEdBQUcsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDMUMsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLEdBQVk7SUFDNUIsT0FBTyxDQUNMLEdBQUcsS0FBSyxJQUFJLElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxDQUN4RSxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLEdBQVU7SUFDMUIsT0FBTyxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztBQUMxQixDQUFDO0FBRUQsU0FBUyxzQkFBc0IsQ0FBQyxHQUFHLFdBQXNCO0lBQ3ZELE9BQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLFVB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QWtCLENBQUMsTUFBYyxFQUFFLE9BQWdCO0lBQzFELE9BQU8sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQ2hFLFNBQVMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQzFELEVBQUUsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLE1BQU0sQ0FDMUIsTUFBYyxFQUNkLE9BQWdCLEVBQ2hCLEdBQXFCO0lBRXJCLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUU7UUFDcEMsTUFBTSxZQUFZLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3pELE1BQU0sU0FBUyxHQUFHLE1BQU0sZUFBZSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBRXZFLE9BQU8sR0FBRyxZQUFZLElBQUksU0FBUyxFQUFFLENBQUM7S0FDdkM7U0FBTTtRQUNMLE1BQU0sSUFBSSxLQUFLLENBQ2Isa0JBQWtCLE1BQU0sQ0FBQyxHQUFHLHVDQUF1QyxDQUNwRSxDQUFDO0tBQ0g7QUFDSCxDQUFDO0FBTUQsTUFBTSxVQUFVLGNBQWMsQ0FBQyxHQUFrQjtJQUMvQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQ2YsQ0FBQyxHQUFHLFlBQVksSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUN2RSxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJhc2U2NHVybCB9IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7XG4gIGNyZWF0ZSBhcyBjcmVhdGVTaWduYXR1cmUsXG4gIHZlcmlmeSBhcyB2ZXJpZnlTaWduYXR1cmUsXG59IGZyb20gXCIuL3NpZ25hdHVyZS50c1wiO1xuaW1wb3J0IHsgdmVyaWZ5IGFzIHZlcmlmeUFsZ29yaXRobSB9IGZyb20gXCIuL2FsZ29yaXRobS50c1wiO1xuXG5pbXBvcnQgdHlwZSB7IEFsZ29yaXRobSB9IGZyb20gXCIuL2FsZ29yaXRobS50c1wiO1xuXG4vKlxuICogSldUIMKnNC4xOiBUaGUgZm9sbG93aW5nIENsYWltIE5hbWVzIGFyZSByZWdpc3RlcmVkIGluIHRoZSBJQU5BXG4gKiBcIkpTT04gV2ViIFRva2VuIENsYWltc1wiIHJlZ2lzdHJ5IGVzdGFibGlzaGVkIGJ5IFNlY3Rpb24gMTAuMS4gTm9uZSBvZiB0aGVcbiAqIGNsYWltcyBkZWZpbmVkIGJlbG93IGFyZSBpbnRlbmRlZCB0byBiZSBtYW5kYXRvcnkgdG8gdXNlIG9yIGltcGxlbWVudCBpbiBhbGxcbiAqIGNhc2VzLCBidXQgcmF0aGVyIHRoZXkgcHJvdmlkZSBhIHN0YXJ0aW5nIHBvaW50IGZvciBhIHNldCBvZiB1c2VmdWwsXG4gKiBpbnRlcm9wZXJhYmxlIGNsYWltcy5cbiAqIEFwcGxpY2F0aW9ucyB1c2luZyBKV1RzIHNob3VsZCBkZWZpbmUgd2hpY2ggc3BlY2lmaWMgY2xhaW1zIHRoZXkgdXNlIGFuZCB3aGVuXG4gKiB0aGV5IGFyZSByZXF1aXJlZCBvciBvcHRpb25hbC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBQYXlsb2FkIHtcbiAgaXNzPzogc3RyaW5nO1xuICBzdWI/OiBzdHJpbmc7XG4gIGF1ZD86IHN0cmluZ1tdIHwgc3RyaW5nO1xuICBleHA/OiBudW1iZXI7XG4gIG5iZj86IG51bWJlcjtcbiAgaWF0PzogbnVtYmVyO1xuICBqdGk/OiBzdHJpbmc7XG4gIFtrZXk6IHN0cmluZ106IHVua25vd247XG59XG5cbi8qXG4gKiBKV1Mgwqc0LjEuMTogVGhlIFwiYWxnXCIgdmFsdWUgaXMgYSBjYXNlLXNlbnNpdGl2ZSBBU0NJSSBzdHJpbmcgY29udGFpbmluZyBhXG4gKiBTdHJpbmdPclVSSSB2YWx1ZS4gVGhpcyBIZWFkZXIgUGFyYW1ldGVyIE1VU1QgYmUgcHJlc2VudCBhbmQgTVVTVCBiZVxuICogdW5kZXJzdG9vZCBhbmQgcHJvY2Vzc2VkIGJ5IGltcGxlbWVudGF0aW9ucy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWFkZXIge1xuICBhbGc6IEFsZ29yaXRobTtcbiAgW2tleTogc3RyaW5nXTogdW5rbm93bjtcbn1cblxuZXhwb3J0IGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcbmV4cG9ydCBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG5cbi8qXG4gKiBKV1Qgwqc0LjEuNDogSW1wbGVtZW50ZXJzIE1BWSBwcm92aWRlIGZvciBzb21lIHNtYWxsIGxlZXdheSB0byBhY2NvdW50IGZvclxuICogY2xvY2sgc2tldy5cbiAqL1xuZnVuY3Rpb24gaXNFeHBpcmVkKGV4cDogbnVtYmVyLCBsZWV3YXkgPSAwKTogYm9vbGVhbiB7XG4gIHJldHVybiBleHAgKyBsZWV3YXkgPCBEYXRlLm5vdygpIC8gMTAwMDtcbn1cblxuZnVuY3Rpb24gaXNUb29FYXJseShuYmY6IG51bWJlciwgbGVld2F5ID0gMCk6IGJvb2xlYW4ge1xuICByZXR1cm4gbmJmIC0gbGVld2F5ID4gRGF0ZS5ub3coKSAvIDEwMDA7XG59XG5cbmZ1bmN0aW9uIGlzT2JqZWN0KG9iajogdW5rbm93bik6IG9iaiBpcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB7XG4gIHJldHVybiAoXG4gICAgb2JqICE9PSBudWxsICYmIHR5cGVvZiBvYmogPT09IFwib2JqZWN0XCIgJiYgQXJyYXkuaXNBcnJheShvYmopID09PSBmYWxzZVxuICApO1xufVxuXG5mdW5jdGlvbiBpczNUdXBsZShhcnI6IGFueVtdKTogYXJyIGlzIFt1bmtub3duLCB1bmtub3duLCBVaW50OEFycmF5XSB7XG4gIHJldHVybiBhcnIubGVuZ3RoID09PSAzO1xufVxuXG5mdW5jdGlvbiBoYXNJbnZhbGlkVGltaW5nQ2xhaW1zKC4uLmNsYWltVmFsdWVzOiB1bmtub3duW10pOiBib29sZWFuIHtcbiAgcmV0dXJuIGNsYWltVmFsdWVzLnNvbWUoKGNsYWltVmFsdWUpID0+XG4gICAgY2xhaW1WYWx1ZSAhPT0gdW5kZWZpbmVkID8gdHlwZW9mIGNsYWltVmFsdWUgIT09IFwibnVtYmVyXCIgOiBmYWxzZVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlKFxuICBqd3Q6IHN0cmluZyxcbik6IFtoZWFkZXI6IHVua25vd24sIHBheWxvYWQ6IHVua25vd24sIHNpZ25hdHVyZTogVWludDhBcnJheV0ge1xuICB0cnkge1xuICAgIGNvbnN0IGFyciA9IGp3dFxuICAgICAgLnNwbGl0KFwiLlwiKVxuICAgICAgLm1hcChiYXNlNjR1cmwuZGVjb2RlKVxuICAgICAgLm1hcCgodWludDhBcnJheSwgaW5kZXgpID0+XG4gICAgICAgIGluZGV4ID09PSAwIHx8IGluZGV4ID09PSAxXG4gICAgICAgICAgPyBKU09OLnBhcnNlKGRlY29kZXIuZGVjb2RlKHVpbnQ4QXJyYXkpKVxuICAgICAgICAgIDogdWludDhBcnJheVxuICAgICAgKTtcbiAgICBpZiAoaXMzVHVwbGUoYXJyKSkgcmV0dXJuIGFycjtcbiAgICBlbHNlIHRocm93IG5ldyBFcnJvcigpO1xuICB9IGNhdGNoIHtcbiAgICB0aHJvdyBFcnJvcihcIlRoZSBzZXJpYWxpemF0aW9uIG9mIHRoZSBqd3QgaXMgaW52YWxpZC5cIik7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlKFxuICBbaGVhZGVyLCBwYXlsb2FkLCBzaWduYXR1cmVdOiBbYW55LCBhbnksIFVpbnQ4QXJyYXldLFxuKToge1xuICBoZWFkZXI6IEhlYWRlcjtcbiAgcGF5bG9hZDogUGF5bG9hZDtcbiAgc2lnbmF0dXJlOiBVaW50OEFycmF5O1xufSB7XG4gIGlmICh0eXBlb2YgaGVhZGVyPy5hbGcgIT09IFwic3RyaW5nXCIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBqd3QncyBhbGcgaGVhZGVyIHBhcmFtZXRlciB2YWx1ZSBtdXN0IGJlIGEgc3RyaW5nLmApO1xuICB9XG5cbiAgLypcbiAgICogSldUIMKnNy4yOiBWZXJpZnkgdGhhdCB0aGUgcmVzdWx0aW5nIG9jdGV0IHNlcXVlbmNlIGlzIGEgVVRGLTgtZW5jb2RlZFxuICAgKiByZXByZXNlbnRhdGlvbiBvZiBhIGNvbXBsZXRlbHkgdmFsaWQgSlNPTiBvYmplY3QgY29uZm9ybWluZyB0byBSRkMgNzE1OTtcbiAgICogbGV0IHRoZSBKV1QgQ2xhaW1zIFNldCBiZSB0aGlzIEpTT04gb2JqZWN0LlxuICAgKi9cbiAgaWYgKGlzT2JqZWN0KHBheWxvYWQpKSB7XG4gICAgaWYgKGhhc0ludmFsaWRUaW1pbmdDbGFpbXMocGF5bG9hZC5leHAsIHBheWxvYWQubmJmKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgand0IGhhcyBhbiBpbnZhbGlkICdleHAnIG9yICduYmYnIGNsYWltLmApO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgcGF5bG9hZC5leHAgPT09IFwibnVtYmVyXCIgJiYgaXNFeHBpcmVkKHBheWxvYWQuZXhwLCAxKSkge1xuICAgICAgdGhyb3cgUmFuZ2VFcnJvcihcIlRoZSBqd3QgaXMgZXhwaXJlZC5cIik7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBwYXlsb2FkLm5iZiA9PT0gXCJudW1iZXJcIiAmJiBpc1Rvb0Vhcmx5KHBheWxvYWQubmJmLCAxKSkge1xuICAgICAgdGhyb3cgUmFuZ2VFcnJvcihcIlRoZSBqd3QgaXMgdXNlZCB0b28gZWFybHkuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBoZWFkZXIsXG4gICAgICBwYXlsb2FkLFxuICAgICAgc2lnbmF0dXJlLFxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgand0IGNsYWltcyBzZXQgaXMgbm90IGEgSlNPTiBvYmplY3QuYCk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeShcbiAgand0OiBzdHJpbmcsXG4gIGtleTogQ3J5cHRvS2V5IHwgbnVsbCxcbik6IFByb21pc2U8UGF5bG9hZD4ge1xuICBjb25zdCB7IGhlYWRlciwgcGF5bG9hZCwgc2lnbmF0dXJlIH0gPSB2YWxpZGF0ZShkZWNvZGUoand0KSk7XG4gIGlmICh2ZXJpZnlBbGdvcml0aG0oaGVhZGVyLmFsZywga2V5KSkge1xuICAgIGlmIChcbiAgICAgICEoYXdhaXQgdmVyaWZ5U2lnbmF0dXJlKFxuICAgICAgICBzaWduYXR1cmUsXG4gICAgICAgIGtleSxcbiAgICAgICAgaGVhZGVyLmFsZyxcbiAgICAgICAgand0LnNsaWNlKDAsIGp3dC5sYXN0SW5kZXhPZihcIi5cIikpLFxuICAgICAgKSlcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgXCJUaGUgand0J3Mgc2lnbmF0dXJlIGRvZXMgbm90IG1hdGNoIHRoZSB2ZXJpZmljYXRpb24gc2lnbmF0dXJlLlwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF5bG9hZDtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIGp3dCdzIGFsZyAnJHtoZWFkZXIuYWxnfScgZG9lcyBub3QgbWF0Y2ggdGhlIGtleSdzIGFsZ29yaXRobS5gLFxuICAgICk7XG4gIH1cbn1cblxuLypcbiAqIEpXVCDCpzM6IEpXVHMgcmVwcmVzZW50IGEgc2V0IG9mIGNsYWltcyBhcyBhIEpTT04gb2JqZWN0IHRoYXQgaXMgZW5jb2RlZCBpblxuICogYSBKV1MgYW5kL29yIEpXRSBzdHJ1Y3R1cmUuIFRoaXMgSlNPTiBvYmplY3QgaXMgdGhlIEpXVCBDbGFpbXMgU2V0LlxuICogSlNXIMKnNy4xOiBUaGUgSldTIENvbXBhY3QgU2VyaWFsaXphdGlvbiByZXByZXNlbnRzIGRpZ2l0YWxseSBzaWduZWQgb3IgTUFDZWRcbiAqIGNvbnRlbnQgYXMgYSBjb21wYWN0LCBVUkwtc2FmZSBzdHJpbmcuIFRoaXMgc3RyaW5nIGlzOlxuICogICAgICAgQkFTRTY0VVJMKFVURjgoSldTIFByb3RlY3RlZCBIZWFkZXIpKSB8fCAnLicgfHxcbiAqICAgICAgIEJBU0U2NFVSTChKV1MgUGF5bG9hZCkgfHwgJy4nIHx8XG4gKiAgICAgICBCQVNFNjRVUkwoSldTIFNpZ25hdHVyZSlcbiAqL1xuZnVuY3Rpb24gY3JlYXRlU2lnbmluZ0lucHV0KGhlYWRlcjogSGVhZGVyLCBwYXlsb2FkOiBQYXlsb2FkKTogc3RyaW5nIHtcbiAgcmV0dXJuIGAke2Jhc2U2NHVybC5lbmNvZGUoZW5jb2Rlci5lbmNvZGUoSlNPTi5zdHJpbmdpZnkoaGVhZGVyKSkpfS4ke1xuICAgIGJhc2U2NHVybC5lbmNvZGUoZW5jb2Rlci5lbmNvZGUoSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkpKVxuICB9YDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZShcbiAgaGVhZGVyOiBIZWFkZXIsXG4gIHBheWxvYWQ6IFBheWxvYWQsXG4gIGtleTogQ3J5cHRvS2V5IHwgbnVsbCxcbik6IFByb21pc2U8c3RyaW5nPiB7XG4gIGlmICh2ZXJpZnlBbGdvcml0aG0oaGVhZGVyLmFsZywga2V5KSkge1xuICAgIGNvbnN0IHNpZ25pbmdJbnB1dCA9IGNyZWF0ZVNpZ25pbmdJbnB1dChoZWFkZXIsIHBheWxvYWQpO1xuICAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IGNyZWF0ZVNpZ25hdHVyZShoZWFkZXIuYWxnLCBrZXksIHNpZ25pbmdJbnB1dCk7XG5cbiAgICByZXR1cm4gYCR7c2lnbmluZ0lucHV0fS4ke3NpZ25hdHVyZX1gO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBUaGUgand0J3MgYWxnICcke2hlYWRlci5hbGd9JyBkb2VzIG5vdCBtYXRjaCB0aGUga2V5J3MgYWxnb3JpdGhtLmAsXG4gICAgKTtcbiAgfVxufVxuXG4vKlxuICogSGVscGVyIGZ1bmN0aW9uOiBnZXROdW1lcmljRGF0ZSgpXG4gKiByZXR1cm5zIHRoZSBudW1iZXIgb2Ygc2Vjb25kcyBzaW5jZSBKYW51YXJ5IDEsIDE5NzAsIDAwOjAwOjAwIFVUQ1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TnVtZXJpY0RhdGUoZXhwOiBudW1iZXIgfCBEYXRlKTogbnVtYmVyIHtcbiAgcmV0dXJuIE1hdGgucm91bmQoXG4gICAgKGV4cCBpbnN0YW5jZW9mIERhdGUgPyBleHAuZ2V0VGltZSgpIDogRGF0ZS5ub3coKSArIGV4cCAqIDEwMDApIC8gMTAwMCxcbiAgKTtcbn1cbiJdfQ==