import { getDescription } from "../_utils.ts";
import { FileType } from "../types/file.ts";
export class FishCompletionsGenerator {
    cmd;
    static generate(cmd) {
        return new FishCompletionsGenerator(cmd).generate();
    }
    constructor(cmd) {
        this.cmd = cmd;
    }
    generate() {
        const path = this.cmd.getPath();
        const version = this.cmd.getVersion()
            ? ` v${this.cmd.getVersion()}`
            : "";
        return `#!/usr/bin/env fish
# fish completion support for ${path}${version}

function __fish_${replaceSpecialChars(this.cmd.getName())}_using_command
  set cmds ${getCommandFnNames(this.cmd).join(" ")}
  set words (commandline -opc)
  set cmd "_"
  for word in $words
    switch $word
      case '-*'
        continue
      case '*'
        set word (string replace -r -a '\\W' '_' $word)
        set cmd_tmp $cmd"_$word"
        if contains $cmd_tmp $cmds
          set cmd $cmd_tmp
        end
    end
  end
  if [ "$cmd" = "$argv[1]" ]
    return 0
  end
  return 1
end

${this.generateCompletions(this.cmd).trim()}`;
    }
    generateCompletions(command) {
        const parent = command.getParent();
        let result = ``;
        if (parent) {
            result += "\n" + this.complete(parent, {
                description: command.getShortDescription(),
                arguments: command.getName(),
            });
        }
        const commandArgs = command.getArguments();
        if (commandArgs.length) {
            result += "\n" + this.complete(command, {
                arguments: commandArgs.length
                    ? this.getCompletionCommand(command, commandArgs[0])
                    : undefined,
            });
        }
        for (const option of command.getOptions(false)) {
            result += "\n" + this.completeOption(command, option);
        }
        for (const subCommand of command.getCommands(false)) {
            result += this.generateCompletions(subCommand);
        }
        return result;
    }
    completeOption(command, option) {
        const shortOption = option.flags
            .find((flag) => flag.length === 2)
            ?.replace(/^(-)+/, "");
        const longOption = option.flags
            .find((flag) => flag.length > 2)
            ?.replace(/^(-)+/, "");
        return this.complete(command, {
            description: getDescription(option.description),
            shortOption: shortOption,
            longOption: longOption,
            required: true,
            standalone: option.standalone,
            arguments: option.args.length
                ? this.getCompletionCommand(command, option.args[0])
                : undefined,
        });
    }
    complete(command, options) {
        const cmd = ["complete"];
        cmd.push("-c", this.cmd.getName());
        cmd.push("-n", `'__fish_${replaceSpecialChars(this.cmd.getName())}_using_command __${replaceSpecialChars(command.getPath())}'`);
        options.shortOption && cmd.push("-s", options.shortOption);
        options.longOption && cmd.push("-l", options.longOption);
        options.standalone && cmd.push("-x");
        cmd.push("-k");
        cmd.push("-f");
        if (options.arguments) {
            options.required && cmd.push("-r");
            cmd.push("-a", options.arguments);
        }
        options.description &&
            cmd.push("-d", `'${getDescription(options.description, true)}'`);
        return cmd.join(" ");
    }
    getCompletionCommand(cmd, arg) {
        const type = cmd.getType(arg.type);
        if (type && type.handler instanceof FileType) {
            return `'(__fish_complete_path)'`;
        }
        return `'(${this.cmd.getName()} completions complete ${arg.action + " " + getCompletionsPath(cmd)})'`;
    }
}
function getCommandFnNames(cmd, cmds = []) {
    cmds.push(`__${replaceSpecialChars(cmd.getPath())}`);
    cmd.getCommands(false).forEach((command) => {
        getCommandFnNames(command, cmds);
    });
    return cmds;
}
function getCompletionsPath(command) {
    return command.getPath()
        .split(" ")
        .slice(1)
        .join(" ");
}
function replaceSpecialChars(str) {
    return str.replace(/[^a-zA-Z0-9]/g, "_");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX2Zpc2hfY29tcGxldGlvbnNfZ2VuZXJhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiX2Zpc2hfY29tcGxldGlvbnNfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHOUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBYTVDLE1BQU0sT0FBTyx3QkFBd0I7SUFNTDtJQUp2QixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQVk7UUFDakMsT0FBTyxJQUFJLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3RELENBQUM7SUFFRCxZQUE4QixHQUFZO1FBQVosUUFBRyxHQUFILEdBQUcsQ0FBUztJQUFHLENBQUM7SUFHdEMsUUFBUTtRQUNkLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDaEMsTUFBTSxPQUFPLEdBQXVCLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFO1lBQ3ZELENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDOUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUVQLE9BQU87Z0NBQ3FCLElBQUksR0FBRyxPQUFPOztrQkFFNUIsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUM1QyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0VBcUJoRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7SUFDNUMsQ0FBQztJQUVPLG1CQUFtQixDQUFDLE9BQWdCO1FBQzFDLE1BQU0sTUFBTSxHQUF3QixP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SUFBSSxDQUFDO0lBQ1AsQ0FBQztDQUNGO0FBRUQsU0FBUyxpQkFBaUIsQ0FDeEIsR0FBWSxFQUNaLE9BQXNCLEVBQUU7SUFFeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNyRCxHQUFHLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3pDLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQUMsT0FBZ0I7SUFDMUMsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFO1NBQ3JCLEtBQUssQ0FBQyxHQUFHLENBQUM7U0FDVixLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ1IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsR0FBVztJQUN0QyxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzNDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXREZXNjcmlwdGlvbiB9IGZyb20gXCIuLi9fdXRpbHMudHNcIjtcbmltcG9ydCB0eXBlIHsgQ29tbWFuZCB9IGZyb20gXCIuLi9jb21tYW5kLnRzXCI7XG5pbXBvcnQgdHlwZSB7IElBcmd1bWVudCwgSU9wdGlvbiB9IGZyb20gXCIuLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgRmlsZVR5cGUgfSBmcm9tIFwiLi4vdHlwZXMvZmlsZS50c1wiO1xuXG4vKiogR2VuZXJhdGVzIGZpc2ggY29tcGxldGlvbnMgc2NyaXB0LiAqL1xuaW50ZXJmYWNlIENvbXBsZXRlT3B0aW9ucyB7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBzaG9ydE9wdGlvbj86IHN0cmluZztcbiAgbG9uZ09wdGlvbj86IHN0cmluZztcbiAgcmVxdWlyZWQ/OiBib29sZWFuO1xuICBzdGFuZGFsb25lPzogYm9vbGVhbjtcbiAgYXJndW1lbnRzPzogc3RyaW5nO1xufVxuXG4vKiogRmlzaCBjb21wbGV0aW9ucyBnZW5lcmF0b3IuICovXG5leHBvcnQgY2xhc3MgRmlzaENvbXBsZXRpb25zR2VuZXJhdG9yIHtcbiAgLyoqIEdlbmVyYXRlcyBmaXNoIGNvbXBsZXRpb25zIHNjcmlwdCBmb3IgZ2l2ZW4gY29tbWFuZC4gKi9cbiAgcHVibGljIHN0YXRpYyBnZW5lcmF0ZShjbWQ6IENvbW1hbmQpIHtcbiAgICByZXR1cm4gbmV3IEZpc2hDb21wbGV0aW9uc0dlbmVyYXRvcihjbWQpLmdlbmVyYXRlKCk7XG4gIH1cblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBjbWQ6IENvbW1hbmQpIHt9XG5cbiAgLyoqIEdlbmVyYXRlcyBmaXNoIGNvbXBsZXRpb25zIHNjcmlwdC4gKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhdGggPSB0aGlzLmNtZC5nZXRQYXRoKCk7XG4gICAgY29uc3QgdmVyc2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkID0gdGhpcy5jbWQuZ2V0VmVyc2lvbigpXG4gICAgICA/IGAgdiR7dGhpcy5jbWQuZ2V0VmVyc2lvbigpfWBcbiAgICAgIDogXCJcIjtcblxuICAgIHJldHVybiBgIyEvdXNyL2Jpbi9lbnYgZmlzaFxuIyBmaXNoIGNvbXBsZXRpb24gc3VwcG9ydCBmb3IgJHtwYXRofSR7dmVyc2lvbn1cblxuZnVuY3Rpb24gX19maXNoXyR7cmVwbGFjZVNwZWNpYWxDaGFycyh0aGlzLmNtZC5nZXROYW1lKCkpfV91c2luZ19jb21tYW5kXG4gIHNldCBjbWRzICR7Z2V0Q29tbWFuZEZuTmFtZXModGhpcy5jbWQpLmpvaW4oXCIgXCIpfVxuICBzZXQgd29yZHMgKGNvbW1hbmRsaW5lIC1vcGMpXG4gIHNldCBjbWQgXCJfXCJcbiAgZm9yIHdvcmQgaW4gJHdvcmRzXG4gICAgc3dpdGNoICR3b3JkXG4gICAgICBjYXNlICctKidcbiAgICAgICAgY29udGludWVcbiAgICAgIGNhc2UgJyonXG4gICAgICAgIHNldCB3b3JkIChzdHJpbmcgcmVwbGFjZSAtciAtYSAnXFxcXFcnICdfJyAkd29yZClcbiAgICAgICAgc2V0IGNtZF90bXAgJGNtZFwiXyR3b3JkXCJcbiAgICAgICAgaWYgY29udGFpbnMgJGNtZF90bXAgJGNtZHNcbiAgICAgICAgICBzZXQgY21kICRjbWRfdG1wXG4gICAgICAgIGVuZFxuICAgIGVuZFxuICBlbmRcbiAgaWYgWyBcIiRjbWRcIiA9IFwiJGFyZ3ZbMV1cIiBdXG4gICAgcmV0dXJuIDBcbiAgZW5kXG4gIHJldHVybiAxXG5lbmRcblxuJHt0aGlzLmdlbmVyYXRlQ29tcGxldGlvbnModGhpcy5jbWQpLnRyaW0oKX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZUNvbXBsZXRpb25zKGNvbW1hbmQ6IENvbW1hbmQpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhcmVudDogQ29tbWFuZCB8IHVuZGVmaW5lZCA9IGNvbW1hbmQuZ2V0UGFyZW50KCk7XG4gICAgbGV0IHJlc3VsdCA9IGBgO1xuXG4gICAgaWYgKHBhcmVudCkge1xuICAgICAgLy8gY29tbWFuZFxuICAgICAgcmVzdWx0ICs9IFwiXFxuXCIgKyB0aGlzLmNvbXBsZXRlKHBhcmVudCwge1xuICAgICAgICBkZXNjcmlwdGlvbjogY29tbWFuZC5nZXRTaG9ydERlc2NyaXB0aW9uKCksXG4gICAgICAgIGFyZ3VtZW50czogY29tbWFuZC5nZXROYW1lKCksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBhcmd1bWVudHNcbiAgICBjb25zdCBjb21tYW5kQXJncyA9IGNvbW1hbmQuZ2V0QXJndW1lbnRzKCk7XG4gICAgaWYgKGNvbW1hbmRBcmdzLmxlbmd0aCkge1xuICAgICAgcmVzdWx0ICs9IFwiXFxuXCIgKyB0aGlzLmNvbXBsZXRlKGNvbW1hbmQsIHtcbiAgICAgICAgYXJndW1lbnRzOiBjb21tYW5kQXJncy5sZW5ndGhcbiAgICAgICAgICA/IHRoaXMuZ2V0Q29tcGxldGlvbkNvbW1hbmQoY29tbWFuZCwgY29tbWFuZEFyZ3NbMF0pXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBvcHRpb25zXG4gICAgZm9yIChjb25zdCBvcHRpb24gb2YgY29tbWFuZC5nZXRPcHRpb25zKGZhbHNlKSkge1xuICAgICAgcmVzdWx0ICs9IFwiXFxuXCIgKyB0aGlzLmNvbXBsZXRlT3B0aW9uKGNvbW1hbmQsIG9wdGlvbik7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBzdWJDb21tYW5kIG9mIGNvbW1hbmQuZ2V0Q29tbWFuZHMoZmFsc2UpKSB7XG4gICAgICByZXN1bHQgKz0gdGhpcy5nZW5lcmF0ZUNvbXBsZXRpb25zKHN1YkNvbW1hbmQpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIGNvbXBsZXRlT3B0aW9uKGNvbW1hbmQ6IENvbW1hbmQsIG9wdGlvbjogSU9wdGlvbikge1xuICAgIGNvbnN0IHNob3J0T3B0aW9uOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBvcHRpb24uZmxhZ3NcbiAgICAgIC5maW5kKChmbGFnKSA9PiBmbGFnLmxlbmd0aCA9PT0gMilcbiAgICAgID8ucmVwbGFjZSgvXigtKSsvLCBcIlwiKTtcbiAgICBjb25zdCBsb25nT3B0aW9uOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBvcHRpb24uZmxhZ3NcbiAgICAgIC5maW5kKChmbGFnKSA9PiBmbGFnLmxlbmd0aCA+IDIpXG4gICAgICA/LnJlcGxhY2UoL14oLSkrLywgXCJcIik7XG5cbiAgICByZXR1cm4gdGhpcy5jb21wbGV0ZShjb21tYW5kLCB7XG4gICAgICBkZXNjcmlwdGlvbjogZ2V0RGVzY3JpcHRpb24ob3B0aW9uLmRlc2NyaXB0aW9uKSxcbiAgICAgIHNob3J0T3B0aW9uOiBzaG9ydE9wdGlvbixcbiAgICAgIGxvbmdPcHRpb246IGxvbmdPcHRpb24sXG4gICAgICAvLyByZXF1aXJlZDogb3B0aW9uLnJlcXVpcmVkVmFsdWUsXG4gICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICAgIHN0YW5kYWxvbmU6IG9wdGlvbi5zdGFuZGFsb25lLFxuICAgICAgYXJndW1lbnRzOiBvcHRpb24uYXJncy5sZW5ndGhcbiAgICAgICAgPyB0aGlzLmdldENvbXBsZXRpb25Db21tYW5kKGNvbW1hbmQsIG9wdGlvbi5hcmdzWzBdKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY29tcGxldGUoY29tbWFuZDogQ29tbWFuZCwgb3B0aW9uczogQ29tcGxldGVPcHRpb25zKSB7XG4gICAgY29uc3QgY21kID0gW1wiY29tcGxldGVcIl07XG4gICAgY21kLnB1c2goXCItY1wiLCB0aGlzLmNtZC5nZXROYW1lKCkpO1xuICAgIGNtZC5wdXNoKFxuICAgICAgXCItblwiLFxuICAgICAgYCdfX2Zpc2hfJHtyZXBsYWNlU3BlY2lhbENoYXJzKHRoaXMuY21kLmdldE5hbWUoKSl9X3VzaW5nX2NvbW1hbmQgX18ke1xuICAgICAgICByZXBsYWNlU3BlY2lhbENoYXJzKGNvbW1hbmQuZ2V0UGF0aCgpKVxuICAgICAgfSdgLFxuICAgICk7XG4gICAgb3B0aW9ucy5zaG9ydE9wdGlvbiAmJiBjbWQucHVzaChcIi1zXCIsIG9wdGlvbnMuc2hvcnRPcHRpb24pO1xuICAgIG9wdGlvbnMubG9uZ09wdGlvbiAmJiBjbWQucHVzaChcIi1sXCIsIG9wdGlvbnMubG9uZ09wdGlvbik7XG4gICAgb3B0aW9ucy5zdGFuZGFsb25lICYmIGNtZC5wdXNoKFwiLXhcIik7XG4gICAgY21kLnB1c2goXCIta1wiKTtcbiAgICBjbWQucHVzaChcIi1mXCIpO1xuICAgIGlmIChvcHRpb25zLmFyZ3VtZW50cykge1xuICAgICAgb3B0aW9ucy5yZXF1aXJlZCAmJiBjbWQucHVzaChcIi1yXCIpO1xuICAgICAgY21kLnB1c2goXCItYVwiLCBvcHRpb25zLmFyZ3VtZW50cyk7XG4gICAgfVxuICAgIG9wdGlvbnMuZGVzY3JpcHRpb24gJiZcbiAgICAgIGNtZC5wdXNoKFwiLWRcIiwgYCcke2dldERlc2NyaXB0aW9uKG9wdGlvbnMuZGVzY3JpcHRpb24sIHRydWUpfSdgKTtcbiAgICByZXR1cm4gY21kLmpvaW4oXCIgXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb21wbGV0aW9uQ29tbWFuZChjbWQ6IENvbW1hbmQsIGFyZzogSUFyZ3VtZW50KTogc3RyaW5nIHtcbiAgICBjb25zdCB0eXBlID0gY21kLmdldFR5cGUoYXJnLnR5cGUpO1xuICAgIGlmICh0eXBlICYmIHR5cGUuaGFuZGxlciBpbnN0YW5jZW9mIEZpbGVUeXBlKSB7XG4gICAgICByZXR1cm4gYCcoX19maXNoX2NvbXBsZXRlX3BhdGgpJ2A7XG4gICAgfVxuICAgIHJldHVybiBgJygke3RoaXMuY21kLmdldE5hbWUoKX0gY29tcGxldGlvbnMgY29tcGxldGUgJHtcbiAgICAgIGFyZy5hY3Rpb24gKyBcIiBcIiArIGdldENvbXBsZXRpb25zUGF0aChjbWQpXG4gICAgfSknYDtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRDb21tYW5kRm5OYW1lcyhcbiAgY21kOiBDb21tYW5kLFxuICBjbWRzOiBBcnJheTxzdHJpbmc+ID0gW10sXG4pOiBBcnJheTxzdHJpbmc+IHtcbiAgY21kcy5wdXNoKGBfXyR7cmVwbGFjZVNwZWNpYWxDaGFycyhjbWQuZ2V0UGF0aCgpKX1gKTtcbiAgY21kLmdldENvbW1hbmRzKGZhbHNlKS5mb3JFYWNoKChjb21tYW5kKSA9PiB7XG4gICAgZ2V0Q29tbWFuZEZuTmFtZXMoY29tbWFuZCwgY21kcyk7XG4gIH0pO1xuICByZXR1cm4gY21kcztcbn1cblxuZnVuY3Rpb24gZ2V0Q29tcGxldGlvbnNQYXRoKGNvbW1hbmQ6IENvbW1hbmQpOiBzdHJpbmcge1xuICByZXR1cm4gY29tbWFuZC5nZXRQYXRoKClcbiAgICAuc3BsaXQoXCIgXCIpXG4gICAgLnNsaWNlKDEpXG4gICAgLmpvaW4oXCIgXCIpO1xufVxuXG5mdW5jdGlvbiByZXBsYWNlU3BlY2lhbENoYXJzKHN0cjogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgXCJfXCIpO1xufVxuIl19