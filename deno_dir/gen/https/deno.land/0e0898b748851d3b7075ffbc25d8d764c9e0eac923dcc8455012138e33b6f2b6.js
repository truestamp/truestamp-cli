import { instantiate } from "../build/sqlite.js";
import { setStr } from "./wasm.ts";
import { OpenFlags, Status, Values } from "./constants.ts";
import { SqliteError } from "./error.ts";
import { PreparedQuery } from "./query.ts";
export class DB {
    _wasm;
    _open;
    _statements;
    _transactionDepth;
    constructor(path = ":memory:", options = {}) {
        this._wasm = instantiate().exports;
        this._open = false;
        this._statements = new Set();
        this._transactionDepth = 0;
        let flags = 0;
        switch (options.mode) {
            case "read":
                flags = OpenFlags.ReadOnly;
                break;
            case "write":
                flags = OpenFlags.ReadWrite;
                break;
            case "create":
            default:
                flags = OpenFlags.ReadWrite | OpenFlags.Create;
                break;
        }
        if (options.memory === true) {
            flags |= OpenFlags.Memory;
        }
        if (options.uri === true) {
            flags |= OpenFlags.Uri;
        }
        const status = setStr(this._wasm, path, (ptr) => this._wasm.open(ptr, flags));
        if (status !== Status.SqliteOk) {
            throw new SqliteError(this._wasm, status);
        }
        this._open = true;
    }
    query(sql, params) {
        const query = this.prepareQuery(sql);
        try {
            const rows = query.all(params);
            query.finalize();
            return rows;
        }
        catch (err) {
            query.finalize();
            throw err;
        }
    }
    queryEntries(sql, params) {
        const query = this.prepareQuery(sql);
        try {
            const rows = query.allEntries(params);
            query.finalize();
            return rows;
        }
        catch (err) {
            query.finalize();
            throw err;
        }
    }
    prepareQuery(sql) {
        if (!this._open) {
            throw new SqliteError("Database was closed.");
        }
        const stmt = setStr(this._wasm, sql, (ptr) => this._wasm.prepare(ptr));
        if (stmt === Values.Null) {
            throw new SqliteError(this._wasm);
        }
        this._statements.add(stmt);
        return new PreparedQuery(this._wasm, stmt, this._statements);
    }
    execute(sql) {
        const status = setStr(this._wasm, sql, (ptr) => this._wasm.exec(ptr));
        if (status !== Status.SqliteOk) {
            throw new SqliteError(this._wasm, status);
        }
    }
    transaction(closure) {
        this._transactionDepth += 1;
        this.query(`SAVEPOINT _deno_sqlite_sp_${this._transactionDepth}`);
        let value;
        try {
            value = closure();
        }
        catch (err) {
            this.query(`ROLLBACK TO _deno_sqlite_sp_${this._transactionDepth}`);
            this._transactionDepth -= 1;
            throw err;
        }
        this.query(`RELEASE _deno_sqlite_sp_${this._transactionDepth}`);
        this._transactionDepth -= 1;
        return value;
    }
    close(force = false) {
        if (!this._open) {
            return;
        }
        if (force) {
            for (const stmt of this._statements) {
                if (this._wasm.finalize(stmt) !== Status.SqliteOk) {
                    throw new SqliteError(this._wasm);
                }
            }
        }
        if (this._wasm.close() !== Status.SqliteOk) {
            throw new SqliteError(this._wasm);
        }
        this._open = false;
    }
    get lastInsertRowId() {
        return this._wasm.last_insert_rowid();
    }
    get changes() {
        return this._wasm.changes();
    }
    get totalChanges() {
        return this._wasm.total_changes();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFzQixNQUFNLG9CQUFvQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN6QyxPQUFPLEVBQUUsYUFBYSxFQUFxQyxNQUFNLFlBQVksQ0FBQztBQXVDOUUsTUFBTSxPQUFPLEVBQUU7SUFDTCxLQUFLLENBQU87SUFDWixLQUFLLENBQVU7SUFDZixXQUFXLENBQW9CO0lBQy9CLGlCQUFpQixDQUFTO0lBNkJsQyxZQUFZLE9BQWUsVUFBVSxFQUFFLFVBQXlCLEVBQUU7UUFDaEUsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUM7UUFHM0IsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsUUFBUSxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQ3BCLEtBQUssTUFBTTtnQkFDVCxLQUFLLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQztnQkFDM0IsTUFBTTtZQUNSLEtBQUssT0FBTztnQkFDVixLQUFLLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQztnQkFDNUIsTUFBTTtZQUNSLEtBQUssUUFBUSxDQUFDO1lBQ2Q7Z0JBQ0UsS0FBSyxHQUFHLFNBQVMsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQztnQkFDL0MsTUFBTTtTQUNUO1FB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RCxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBU0QsSUFBSSxlQUFlO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFRRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQVFELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbnN0YW50aWF0ZSwgU3RhdGVtZW50UHRyLCBXYXNtIH0gZnJvbSBcIi4uL2J1aWxkL3NxbGl0ZS5qc1wiO1xuaW1wb3J0IHsgc2V0U3RyIH0gZnJvbSBcIi4vd2FzbS50c1wiO1xuaW1wb3J0IHsgT3BlbkZsYWdzLCBTdGF0dXMsIFZhbHVlcyB9IGZyb20gXCIuL2NvbnN0YW50cy50c1wiO1xuaW1wb3J0IHsgU3FsaXRlRXJyb3IgfSBmcm9tIFwiLi9lcnJvci50c1wiO1xuaW1wb3J0IHsgUHJlcGFyZWRRdWVyeSwgUXVlcnlQYXJhbWV0ZXJTZXQsIFJvdywgUm93T2JqZWN0IH0gZnJvbSBcIi4vcXVlcnkudHNcIjtcblxuLyoqXG4gKiBPcHRpb25zIGZvciBvcGVuaW5nIGEgZGF0YWJhc2UuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3FsaXRlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBNb2RlIGluIHdoaWNoIHRvIG9wZW4gdGhlIGRhdGFiYXNlLlxuICAgKlxuICAgKiAtIGByZWFkYDogcmVhZC1vbmx5LCB0aHJvd3MgYW4gZXJyb3IgaWZcbiAgICogICB0aGUgZGF0YWJhc2UgZmlsZSBkb2VzIG5vdCBleGlzdHNcbiAgICogLSBgd3JpdGVgOiByZWFkLXdyaXRlLCB0aHJvd3MgYW4gZXJyb3JcbiAgICogICBpZiB0aGUgZGF0YWJhc2UgZmlsZSBkb2VzIG5vdCBleGlzdHNcbiAgICogLSBgY3JlYXRlYDogcmVhZC13cml0ZSwgY3JlYXRlIHRoZSBkYXRhYmFzZVxuICAgKiAgIGlmIHRoZSBmaWxlIGRvZXMgbm90IGV4aXN0XG4gICAqXG4gICAqIGBjcmVhdGVgIGlzIHRoZSBkZWZhdWx0IGlmIG5vIG1vZGUgaXNcbiAgICogc3BlY2lmaWVkLlxuICAgKi9cbiAgbW9kZT86IFwicmVhZFwiIHwgXCJ3cml0ZVwiIHwgXCJjcmVhdGVcIjtcbiAgLyoqXG4gICAqIEZvcmNlIHRoZSBkYXRhYmFzZSB0byBiZSBpbi1tZW1vcnkuIFdoZW5cbiAgICogdGhpcyBvcHRpb24gaXMgc2V0LCB0aGUgZGF0YWJhc2UgaXMgb3BlbmVkXG4gICAqIGluIG1lbW9yeSwgcmVnYXJkbGVzcyBvZiB0aGUgc3BlY2lmaWVkXG4gICAqIGZpbGVuYW1lLlxuICAgKi9cbiAgbWVtb3J5PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEludGVycHJldCB0aGUgZmlsZSBuYW1lIGFzIGEgVVJJLlxuICAgKiBTZWUgaHR0cHM6Ly9zcWxpdGUub3JnL3VyaS5odG1sXG4gICAqIGZvciBtb3JlIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgdXJpPzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBBIGRhdGFiYXNlIGhhbmRsZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHJ1blxuICogcXVlcmllcy5cbiAqL1xuZXhwb3J0IGNsYXNzIERCIHtcbiAgcHJpdmF0ZSBfd2FzbTogV2FzbTtcbiAgcHJpdmF0ZSBfb3BlbjogYm9vbGVhbjtcbiAgcHJpdmF0ZSBfc3RhdGVtZW50czogU2V0PFN0YXRlbWVudFB0cj47XG4gIHByaXZhdGUgX3RyYW5zYWN0aW9uRGVwdGg6IG51bWJlcjtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IGRhdGFiYXNlLiBUaGUgZmlsZSBhdCB0aGVcbiAgICogZ2l2ZW4gcGF0aCB3aWxsIGJlIG9wZW5lZCB3aXRoIHRoZVxuICAgKiBtb2RlIHNwZWNpZmllZCBpbiBvcHRpb25zLiBUaGUgZGVmYXVsdFxuICAgKiBtb2RlIGlzIGBjcmVhdGVgLlxuICAgKlxuICAgKiBJZiBubyBwYXRoIGlzIGdpdmVuLCBvciBpZiB0aGUgYG1lbW9yeWBcbiAgICogb3B0aW9uIGlzIHNldCwgdGhlIGRhdGFiYXNlIGlzIG9wZW5lZCBpblxuICAgKiBtZW1vcnkuXG4gICAqXG4gICAqICMgRXhhbXBsZXNcbiAgICpcbiAgICogQ3JlYXRlIGFuIGluLW1lbW9yeSBkYXRhYmFzZS5cbiAgICogYGBgdHlwZXNjcmlwdFxuICAgKiBjb25zdCBkYiA9IG5ldyBEQigpO1xuICAgKiBgYGBcbiAgICpcbiAgICogT3BlbiBhIGRhdGFiYXNlIGJhY2tlZCBieSBhIGZpbGUgb24gZGlzay5cbiAgICogYGBgdHlwZXNjcmlwdFxuICAgKiBjb25zdCBkYiA9IG5ldyBEQihcInBhdGgvdG8vZGF0YWJhc2Uuc3FsaXRlXCIpO1xuICAgKiBgYGBcbiAgICpcbiAgICogUGFzcyBvcHRpb25zIHRvIG9wZW4gYSByZWFkLW9ubHkgZGF0YWJhc2UuXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogY29uc3QgZGIgPSBuZXcgREIoXCJwYXRoL3RvL2RhdGFiYXNlLnNxbGl0ZVwiLCB7IG1vZGU6IFwicmVhZFwiIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIGNvbnN0cnVjdG9yKHBhdGg6IHN0cmluZyA9IFwiOm1lbW9yeTpcIiwgb3B0aW9uczogU3FsaXRlT3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5fd2FzbSA9IGluc3RhbnRpYXRlKCkuZXhwb3J0cztcbiAgICB0aGlzLl9vcGVuID0gZmFsc2U7XG4gICAgdGhpcy5fc3RhdGVtZW50cyA9IG5ldyBTZXQoKTtcbiAgICB0aGlzLl90cmFuc2FjdGlvbkRlcHRoID0gMDtcblxuICAgIC8vIENvbmZpZ3VyZSBmbGFnc1xuICAgIGxldCBmbGFncyA9IDA7XG4gICAgc3dpdGNoIChvcHRpb25zLm1vZGUpIHtcbiAgICAgIGNhc2UgXCJyZWFkXCI6XG4gICAgICAgIGZsYWdzID0gT3BlbkZsYWdzLlJlYWRPbmx5O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJ3cml0ZVwiOlxuICAgICAgICBmbGFncyA9IE9wZW5GbGFncy5SZWFkV3JpdGU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcImNyZWF0ZVwiOiAvLyBmYWxsIHRocm91Z2hcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGZsYWdzID0gT3BlbkZsYWdzLlJlYWRXcml0ZSB8IE9wZW5GbGFncy5DcmVhdGU7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5tZW1vcnkgPT09IHRydWUpIHtcbiAgICAgIGZsYWdzIHw9IE9wZW5GbGFncy5NZW1vcnk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zLnVyaSA9PT0gdHJ1ZSkge1xuICAgICAgZmxhZ3MgfD0gT3BlbkZsYWdzLlVyaTtcbiAgICB9XG5cbiAgICAvLyBUcnkgdG8gb3BlbiB0aGUgZGF0YWJhc2VcbiAgICBjb25zdCBzdGF0dXMgPSBzZXRTdHIoXG4gICAgICB0aGlzLl93YXNtLFxuICAgICAgcGF0aCxcbiAgICAgIChwdHIpID0+IHRoaXMuX3dhc20ub3BlbihwdHIsIGZsYWdzKSxcbiAgICApO1xuICAgIGlmIChzdGF0dXMgIT09IFN0YXR1cy5TcWxpdGVPaykge1xuICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKHRoaXMuX3dhc20sIHN0YXR1cyk7XG4gICAgfVxuICAgIHRoaXMuX29wZW4gPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFF1ZXJ5IHRoZSBkYXRhYmFzZSBhbmQgcmV0dXJuIGFsbCBtYXRjaGluZ1xuICAgKiByb3dzLlxuICAgKlxuICAgKiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8gY2FsbGluZyBgYWxsYCBvblxuICAgKiBhIHByZXBhcmVkIHF1ZXJ5IHdoaWNoIGlzIHRoZW4gaW1tZWRpYXRlbHlcbiAgICogZmluYWxpemVkLlxuICAgKlxuICAgKiBUaGUgdHlwZSBwYXJhbWV0ZXIgYFJgIG1heSBiZSBzdXBwbGllZCBieVxuICAgKiB0aGUgdXNlciB0byBpbmRpY2F0ZWQgdGhlIHR5cGUgZm9yIHRoZSByb3dzIHJldHVybmVkXG4gICAqIGJ5IHRoZSBxdWVyeS4gTm90aWNlIHRoYXQgdGhlIHVzZXIgaXMgcmVzcG9uc2libGVcbiAgICogZm9yIGVuc3VyaW5nIHRoZSBjb3JyZWN0bmVzcyBvZiB0aGUgc3VwcGxpZWQgdHlwZS5cbiAgICpcbiAgICogVG8gYXZvaWQgU1FMIGluamVjdGlvbiwgdXNlci1wcm92aWRlZCB2YWx1ZXNcbiAgICogc2hvdWxkIGFsd2F5cyBiZSBwYXNzZWQgdG8gdGhlIGRhdGFiYXNlIHRocm91Z2hcbiAgICogYSBxdWVyeSBwYXJhbWV0ZXIuXG4gICAqXG4gICAqIFNlZSBgUXVlcnlQYXJhbWV0ZXJTZXRgIGZvciBkb2N1bWVudGF0aW9uIG9uXG4gICAqIGhvdyB2YWx1ZXMgY2FuIGJlIGJvdW5kIHRvIFNRTCBzdGF0ZW1lbnRzLlxuICAgKlxuICAgKiBTZWUgYFF1ZXJ5UGFyYW1ldGVyYCBmb3IgZG9jdW1lbnRhdGlvbiBvbiBob3dcbiAgICogdmFsdWVzIGFyZSByZXR1cm5lZCBmcm9tIHRoZSBkYXRhYmFzZS5cbiAgICpcbiAgICogIyBFeGFtcGxlc1xuICAgKlxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqIGNvbnN0IHJvd3MgPSBkYi5xdWVyeTxbc3RyaW5nLCBudW1iZXJdPihcIlNFTEVDVCBuYW1lLCBhZ2UgRlJPTSBwZW9wbGUgV0hFUkUgY2l0eSA9ID9cIiwgW2NpdHldKTtcbiAgICogLy8gcm93cyA9IFtbXCJQZXRlciBQYXJrZXJcIiwgMjFdLCAuLi5dXG4gICAqIGBgYFxuICAgKi9cbiAgcXVlcnk8UiBleHRlbmRzIFJvdyA9IFJvdz4oXG4gICAgc3FsOiBzdHJpbmcsXG4gICAgcGFyYW1zPzogUXVlcnlQYXJhbWV0ZXJTZXQsXG4gICk6IEFycmF5PFI+IHtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMucHJlcGFyZVF1ZXJ5PFI+KHNxbCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJvd3MgPSBxdWVyeS5hbGwocGFyYW1zKTtcbiAgICAgIHF1ZXJ5LmZpbmFsaXplKCk7XG4gICAgICByZXR1cm4gcm93cztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHF1ZXJ5LmZpbmFsaXplKCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIExpa2UgYHF1ZXJ5YCBleGNlcHQgZWFjaCByb3cgaXMgcmV0dXJuZWRcbiAgICogYXMgYW4gb2JqZWN0IGNvbnRhaW5pbmcga2V5LXZhbHVlIHBhaXJzLlxuICAgKlxuICAgKiAjIEV4YW1wbGVzXG4gICAqXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogY29uc3Qgcm93cyA9IGRiLnF1ZXJ5RW50cmllczx7IG5hbWU6IHN0cmluZywgYWdlOiBudW1iZXIgfT4oXCJTRUxFQ1QgbmFtZSwgYWdlIEZST00gcGVvcGxlXCIpO1xuICAgKiAvLyByb3dzID0gW3sgbmFtZTogXCJQZXRlciBQYXJrZXJcIiwgYWdlOiAyMSB9LCAuLi5dXG4gICAqIGBgYFxuICAgKi9cbiAgcXVlcnlFbnRyaWVzPE8gZXh0ZW5kcyBSb3dPYmplY3QgPSBSb3dPYmplY3Q+KFxuICAgIHNxbDogc3RyaW5nLFxuICAgIHBhcmFtcz86IFF1ZXJ5UGFyYW1ldGVyU2V0LFxuICApOiBBcnJheTxPPiB7XG4gICAgY29uc3QgcXVlcnkgPSB0aGlzLnByZXBhcmVRdWVyeTxSb3csIE8+KHNxbCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJvd3MgPSBxdWVyeS5hbGxFbnRyaWVzKHBhcmFtcyk7XG4gICAgICBxdWVyeS5maW5hbGl6ZSgpO1xuICAgICAgcmV0dXJuIHJvd3M7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBxdWVyeS5maW5hbGl6ZSgpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlcyB0aGUgZ2l2ZW4gU1FMIHF1ZXJ5LCBzbyB0aGF0IGl0XG4gICAqIGNhbiBiZSBydW4gbXVsdGlwbGUgdGltZXMgYW5kIHBvdGVudGlhbGx5XG4gICAqIHdpdGggZGlmZmVyZW50IHBhcmFtZXRlcnMuXG4gICAqXG4gICAqIElmIGEgcXVlcnkgd2lsbCBiZSBpc3N1ZWQgYSBsb3QsIHRoaXMgaXMgbW9yZVxuICAgKiBlZmZpY2llbnQgdGhhbiB1c2luZyBgcXVlcnlgLiBBIHByZXBhcmVkXG4gICAqIHF1ZXJ5IGFsc28gcHJvdmlkZXMgbW9yZSBjb250cm9sIG92ZXIgaG93XG4gICAqIHRoZSBxdWVyeSBpcyBydW4sIGFzIHdlbGwgYXMgYWNjZXNzIHRvIG1ldGEtZGF0YVxuICAgKiBhYm91dCB0aGUgaXNzdWVkIHF1ZXJ5LlxuICAgKlxuICAgKiBUaGUgcmV0dXJuZWQgYFByZXBhcmVkUXVlcnlgIG9iamVjdCBtdXN0IGJlXG4gICAqIGZpbmFsaXplZCBieSBjYWxsaW5nIGl0cyBgZmluYWxpemVgIG1ldGhvZFxuICAgKiBvbmNlIGl0IGlzIG5vIGxvbmdlciBuZWVkZWQuXG4gICAqXG4gICAqICMgVHlwaW5nIFF1ZXJpZXNcbiAgICpcbiAgICogUHJlcGFyZWQgcXVlcnkgb2JqZWN0cyBhY2NlcHQgdGhyZWUgdHlwZSBwYXJhbWV0ZXJzXG4gICAqIHRvIHNwZWNpZnkgcHJlY2lzZSB0eXBlcyBmb3IgcmV0dXJuZWQgZGF0YSBhbmRcbiAgICogcXVlcnkgcGFyYW1ldGVycy5cbiAgICpcbiAgICogVGhlIGZpcnN0IHR5cGUgcGFyYW1ldGVyIGBSYCBpbmRpY2F0ZXMgdGhlIHR1cGxlIHR5cGVcbiAgICogZm9yIHJvd3MgcmV0dXJuZWQgYnkgdGhlIHF1ZXJ5LlxuICAgKlxuICAgKiBUaGUgc2Vjb25kIHR5cGUgcGFyYW1ldGVyIGBPYCBpbmRpY2F0ZXMgdGhlIHJlY29yZCB0eXBlXG4gICAqIGZvciByb3dzIHJldHVybmVkIGFzIGVudHJpZXMgKG1hcHBpbmdzIGZyb20gY29sdW1uIG5hbWVzXG4gICAqIHRvIHZhbHVlcykuXG4gICAqXG4gICAqIFRoZSB0aGlyZCB0eXBlIHBhcmFtZXRlciBgUGAgaW5kaWNhdGVzIHRoZSB0eXBlIHRoaXMgcXVlcnlcbiAgICogYWNjZXB0cyBhcyBwYXJhbWV0ZXJzLlxuICAgKlxuICAgKiBOb3RlLCB0aGF0IHRoZSBjb3JyZWN0bmVzcyBvZiB0aG9zZSB0eXBlcyBtdXN0XG4gICAqIGJlIGd1YXJhbnRlZWQgYnkgdGhlIGNhbGxlciBvZiB0aGlzIGZ1bmN0aW9uLlxuICAgKlxuICAgKiAjIEV4YW1wbGVzXG4gICAqXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogY29uc3QgcXVlcnkgPSBkYi5wcmVwYXJlUXVlcnk8XG4gICAqICAgW3N0cmluZywgbnVtYmVyXSxcbiAgICogICB7IG5hbWU6IHN0cmluZywgYWdlOiBudW1iZXIgfSxcbiAgICogICB7IGNpdHk6IHN0cmluZyB9LFxuICAgKiAgPihcIlNFTEVDVCBuYW1lLCBhZ2UgRlJPTSBwZW9wbGUgV0hFUkUgY2l0eSA9IDpjaXR5XCIpO1xuICAgKiAvLyB1c2UgcXVlcnkgLi4uXG4gICAqIHF1ZXJ5LmZpbmFsaXplKCk7XG4gICAqIGBgYFxuICAgKi9cbiAgcHJlcGFyZVF1ZXJ5PFxuICAgIFIgZXh0ZW5kcyBSb3cgPSBSb3csXG4gICAgTyBleHRlbmRzIFJvd09iamVjdCA9IFJvd09iamVjdCxcbiAgICBQIGV4dGVuZHMgUXVlcnlQYXJhbWV0ZXJTZXQgPSBRdWVyeVBhcmFtZXRlclNldCxcbiAgPihcbiAgICBzcWw6IHN0cmluZyxcbiAgKTogUHJlcGFyZWRRdWVyeTxSLCBPLCBQPiB7XG4gICAgaWYgKCF0aGlzLl9vcGVuKSB7XG4gICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IoXCJEYXRhYmFzZSB3YXMgY2xvc2VkLlwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdG10ID0gc2V0U3RyKFxuICAgICAgdGhpcy5fd2FzbSxcbiAgICAgIHNxbCxcbiAgICAgIChwdHIpID0+IHRoaXMuX3dhc20ucHJlcGFyZShwdHIpLFxuICAgICk7XG4gICAgaWYgKHN0bXQgPT09IFZhbHVlcy5OdWxsKSB7XG4gICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IodGhpcy5fd2FzbSk7XG4gICAgfVxuXG4gICAgdGhpcy5fc3RhdGVtZW50cy5hZGQoc3RtdCk7XG4gICAgcmV0dXJuIG5ldyBQcmVwYXJlZFF1ZXJ5PFIsIE8sIFA+KHRoaXMuX3dhc20sIHN0bXQsIHRoaXMuX3N0YXRlbWVudHMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJ1biBtdWx0aXBsZSBzZW1pY29sb24tc2VwYXJhdGVkIHN0YXRlbWVudHMgZnJvbSBhIHNpbmdsZVxuICAgKiBzdHJpbmcuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIGNhbm5vdCBiaW5kIGFueSBxdWVyeSBwYXJhbWV0ZXJzLCBhbmQgYW55XG4gICAqIHJlc3VsdCByb3dzIGFyZSBkaXNjYXJkZWQuIEl0IGlzIG9ubHkgZm9yIHJ1bm5pbmcgYSBjaHVua1xuICAgKiBvZiByYXcgU1FMOyBmb3IgZXhhbXBsZSwgdG8gaW5pdGlhbGl6ZSBhIGRhdGFiYXNlLlxuICAgKlxuICAgKiAjIEV4YW1wbGVzXG4gICAqXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogZGIuZXhlY3V0ZShgXG4gICAqICAgQ1JFQVRFIFRBQkxFIHBlb3BsZSAoXG4gICAqICAgICBpZCBJTlRFR0VSIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsXG4gICAqICAgICBuYW1lIFRFWFQsXG4gICAqICAgICBhZ2UgUkVBTCxcbiAgICogICAgIGNpdHkgVEVYVFxuICAgKiAgICk7XG4gICAqICAgSU5TRVJUIElOVE8gcGVvcGxlIChuYW1lLCBhZ2UsIGNpdHkpIFZBTFVFUyAoXCJQZXRlciBQYXJrZXJcIiwgMjEsIFwibnljXCIpO1xuICAgKiBgKTtcbiAgICogYGBgXG4gICAqL1xuICBleGVjdXRlKHNxbDogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3RhdHVzID0gc2V0U3RyKFxuICAgICAgdGhpcy5fd2FzbSxcbiAgICAgIHNxbCxcbiAgICAgIChwdHIpID0+IHRoaXMuX3dhc20uZXhlYyhwdHIpLFxuICAgICk7XG5cbiAgICBpZiAoc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlT2spIHtcbiAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcih0aGlzLl93YXNtLCBzdGF0dXMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gYSBmdW5jdGlvbiB3aXRoaW4gdGhlIGNvbnRleHQgb2YgYSBkYXRhYmFzZVxuICAgKiB0cmFuc2FjdGlvbi4gSWYgdGhlIGZ1bmN0aW9uIHRocm93cyBhbiBlcnJvcixcbiAgICogdGhlIHRyYW5zYWN0aW9uIGlzIHJvbGxlZCBiYWNrLiBPdGhlcndpc2UsIHRoZVxuICAgKiB0cmFuc2FjdGlvbiBpcyBjb21taXR0ZWQgd2hlbiB0aGUgZnVuY3Rpb24gcmV0dXJucy5cbiAgICpcbiAgICogQ2FsbHMgdG8gYHRyYW5zYWN0aW9uYCBtYXkgYmUgbmVzdGVkLiBOZXN0ZWQgdHJhbnNhY3Rpb25zXG4gICAqIGJlaGF2ZSBsaWtlIFNRTGl0ZSBzYXZlIHBvaW50cy5cbiAgICovXG4gIHRyYW5zYWN0aW9uPFY+KGNsb3N1cmU6ICgpID0+IFYpOiBWIHtcbiAgICB0aGlzLl90cmFuc2FjdGlvbkRlcHRoICs9IDE7XG4gICAgdGhpcy5xdWVyeShgU0FWRVBPSU5UIF9kZW5vX3NxbGl0ZV9zcF8ke3RoaXMuX3RyYW5zYWN0aW9uRGVwdGh9YCk7XG4gICAgbGV0IHZhbHVlO1xuICAgIHRyeSB7XG4gICAgICB2YWx1ZSA9IGNsb3N1cmUoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMucXVlcnkoYFJPTExCQUNLIFRPIF9kZW5vX3NxbGl0ZV9zcF8ke3RoaXMuX3RyYW5zYWN0aW9uRGVwdGh9YCk7XG4gICAgICB0aGlzLl90cmFuc2FjdGlvbkRlcHRoIC09IDE7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIHRoaXMucXVlcnkoYFJFTEVBU0UgX2Rlbm9fc3FsaXRlX3NwXyR7dGhpcy5fdHJhbnNhY3Rpb25EZXB0aH1gKTtcbiAgICB0aGlzLl90cmFuc2FjdGlvbkRlcHRoIC09IDE7XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlIHRoZSBkYXRhYmFzZS4gVGhpcyBtdXN0IGJlIGNhbGxlZCBpZlxuICAgKiB0aGUgZGF0YWJhc2UgaXMgbm8gbG9uZ2VyIHVzZWQgdG8gYXZvaWQgbGVha2luZ1xuICAgKiBvcGVuIGZpbGUgZGVzY3JpcHRvcnMuXG4gICAqXG4gICAqIElmIGBmb3JjZWAgaXMgc3BlY2lmaWVkLCBhbnkgYWN0aXZlIGBQcmVwYXJlZFF1ZXJ5YFxuICAgKiB3aWxsIGJlIGZpbmFsaXplZC4gT3RoZXJ3aXNlLCB0aGlzIHRocm93cyBpZiB0aGVyZVxuICAgKiBhcmUgYWN0aXZlIHF1ZXJpZXMuXG4gICAqXG4gICAqIGBjbG9zZWAgbWF5IHNhZmVseSBiZSBjYWxsZWQgbXVsdGlwbGVcbiAgICogdGltZXMuXG4gICAqL1xuICBjbG9zZShmb3JjZSA9IGZhbHNlKSB7XG4gICAgaWYgKCF0aGlzLl9vcGVuKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChmb3JjZSkge1xuICAgICAgZm9yIChjb25zdCBzdG10IG9mIHRoaXMuX3N0YXRlbWVudHMpIHtcbiAgICAgICAgaWYgKHRoaXMuX3dhc20uZmluYWxpemUoc3RtdCkgIT09IFN0YXR1cy5TcWxpdGVPaykge1xuICAgICAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcih0aGlzLl93YXNtKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5fd2FzbS5jbG9zZSgpICE9PSBTdGF0dXMuU3FsaXRlT2spIHtcbiAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcih0aGlzLl93YXNtKTtcbiAgICB9XG4gICAgdGhpcy5fb3BlbiA9IGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBsYXN0IGluc2VydGVkIHJvdyBpZC4gVGhpcyBjb3JyZXNwb25kcyB0b1xuICAgKiB0aGUgU1FMaXRlIGZ1bmN0aW9uIGBzcWxpdGUzX2xhc3RfaW5zZXJ0X3Jvd2lkYC5cbiAgICpcbiAgICogQmVmb3JlIGEgcm93IGlzIGluc2VydGVkIGZvciB0aGUgZmlyc3QgdGltZSAoc2luY2VcbiAgICogdGhlIGRhdGFiYXNlIHdhcyBvcGVuZWQpLCB0aGlzIHJldHVybnMgYDBgLlxuICAgKi9cbiAgZ2V0IGxhc3RJbnNlcnRSb3dJZCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl93YXNtLmxhc3RfaW5zZXJ0X3Jvd2lkKCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIHRoZSBudW1iZXIgb2Ygcm93cyBtb2RpZmllZCwgaW5zZXJ0ZWQgb3JcbiAgICogZGVsZXRlZCBieSB0aGUgbW9zdCByZWNlbnRseSBjb21wbGV0ZWQgcXVlcnkuXG4gICAqIFRoaXMgY29ycmVzcG9uZHMgdG8gdGhlIFNRTGl0ZSBmdW5jdGlvblxuICAgKiBgc3FsaXRlM19jaGFuZ2VzYC5cbiAgICovXG4gIGdldCBjaGFuZ2VzKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuX3dhc20uY2hhbmdlcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgbnVtYmVyIG9mIHJvd3MgbW9kaWZpZWQsIGluc2VydGVkIG9yXG4gICAqIGRlbGV0ZWQgc2luY2UgdGhlIGRhdGFiYXNlIHdhcyBvcGVuZWQuXG4gICAqIFRoaXMgY29ycmVzcG9uZHMgdG8gdGhlIFNRTGl0ZSBmdW5jdGlvblxuICAgKiBgc3FsaXRlM190b3RhbF9jaGFuZ2VzYC5cbiAgICovXG4gIGdldCB0b3RhbENoYW5nZXMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fd2FzbS50b3RhbF9jaGFuZ2VzKCk7XG4gIH1cbn1cbiJdfQ==