import { getStr, setArr, setStr } from "./wasm.ts";
import { Status, Types, Values } from "./constants.ts";
import { SqliteError } from "./error.ts";
export class PreparedQuery {
    _wasm;
    _stmt;
    _openStatements;
    _status;
    _iterKv;
    _rowKeys;
    _finalized;
    constructor(wasm, stmt, openStatements) {
        this._wasm = wasm;
        this._stmt = stmt;
        this._openStatements = openStatements;
        this._status = Status.Unknown;
        this._iterKv = false;
        this._finalized = false;
    }
    startQuery(params) {
        if (this._finalized) {
            throw new SqliteError("Query is finalized.");
        }
        this._wasm.reset(this._stmt);
        this._wasm.clear_bindings(this._stmt);
        let parameters = [];
        if (Array.isArray(params)) {
            parameters = params;
        }
        else if (typeof params === "object") {
            for (const key of Object.keys(params)) {
                let name = key;
                if (name[0] !== ":" && name[0] !== "@" && name[0] !== "$") {
                    name = `:${name}`;
                }
                const idx = setStr(this._wasm, name, (ptr) => this._wasm.bind_parameter_index(this._stmt, ptr));
                if (idx === Values.Error) {
                    throw new SqliteError(`No parameter named '${name}'.`);
                }
                parameters[idx - 1] = params[key];
            }
        }
        for (let i = 0; i < parameters.length; i++) {
            let value = parameters[i];
            let status;
            switch (typeof value) {
                case "boolean":
                    value = value ? 1 : 0;
                case "number":
                    if (Number.isSafeInteger(value)) {
                        status = this._wasm.bind_int(this._stmt, i + 1, value);
                    }
                    else {
                        status = this._wasm.bind_double(this._stmt, i + 1, value);
                    }
                    break;
                case "bigint":
                    if (value > 9223372036854775807n || value < -9223372036854775808n) {
                        throw new SqliteError(`BigInt value ${value} overflows 64 bit integer.`);
                    }
                    else {
                        const posVal = value >= 0n ? value : -value;
                        const sign = value >= 0n ? 1 : -1;
                        const upper = Number(BigInt.asUintN(32, posVal >> 32n));
                        const lower = Number(BigInt.asUintN(32, posVal));
                        status = this._wasm.bind_big_int(this._stmt, i + 1, sign, upper, lower);
                    }
                    break;
                case "string":
                    status = setStr(this._wasm, value, (ptr) => this._wasm.bind_text(this._stmt, i + 1, ptr));
                    break;
                default:
                    if (value instanceof Date) {
                        status = setStr(this._wasm, value.toISOString(), (ptr) => this._wasm.bind_text(this._stmt, i + 1, ptr));
                    }
                    else if (value instanceof Uint8Array) {
                        const size = value.length;
                        status = setArr(this._wasm, value, (ptr) => this._wasm.bind_blob(this._stmt, i + 1, ptr, size));
                    }
                    else if (value === null || value === undefined) {
                        status = this._wasm.bind_null(this._stmt, i + 1);
                    }
                    else {
                        throw new SqliteError(`Can not bind ${typeof value}.`);
                    }
                    break;
            }
            if (status !== Status.SqliteOk) {
                throw new SqliteError(this._wasm, status);
            }
        }
    }
    getQueryRow() {
        if (this._finalized) {
            throw new SqliteError("Query is finalized.");
        }
        const columnCount = this._wasm.column_count(this._stmt);
        const row = [];
        for (let i = 0; i < columnCount; i++) {
            switch (this._wasm.column_type(this._stmt, i)) {
                case Types.Integer:
                    row.push(this._wasm.column_int(this._stmt, i));
                    break;
                case Types.Float:
                    row.push(this._wasm.column_double(this._stmt, i));
                    break;
                case Types.Text:
                    row.push(getStr(this._wasm, this._wasm.column_text(this._stmt, i)));
                    break;
                case Types.Blob: {
                    const ptr = this._wasm.column_blob(this._stmt, i);
                    if (ptr === 0) {
                        row.push(null);
                    }
                    else {
                        const length = this._wasm.column_bytes(this._stmt, i);
                        row.push(new Uint8Array(this._wasm.memory.buffer, ptr, length).slice());
                    }
                    break;
                }
                case Types.BigInteger: {
                    const ptr = this._wasm.column_text(this._stmt, i);
                    row.push(BigInt(getStr(this._wasm, ptr)));
                    break;
                }
                default:
                    row.push(null);
                    break;
            }
        }
        return row;
    }
    makeRowObject(row) {
        if (this._rowKeys == null) {
            const rowCount = this._wasm.column_count(this._stmt);
            this._rowKeys = [];
            for (let i = 0; i < rowCount; i++) {
                this._rowKeys.push(getStr(this._wasm, this._wasm.column_name(this._stmt, i)));
            }
        }
        const obj = row.reduce((obj, val, idx) => {
            obj[this._rowKeys[idx]] = val;
            return obj;
        }, {});
        return obj;
    }
    iter(params) {
        this.startQuery(params);
        this._status = this._wasm.step(this._stmt);
        if (this._status !== Status.SqliteRow && this._status !== Status.SqliteDone) {
            throw new SqliteError(this._wasm, this._status);
        }
        this._iterKv = false;
        return this;
    }
    iterEntries(params) {
        this.iter(params);
        this._iterKv = true;
        return this;
    }
    [Symbol.iterator]() {
        return this;
    }
    next() {
        if (this._status === Status.SqliteRow) {
            const value = this.getQueryRow();
            this._status = this._wasm.step(this._stmt);
            if (this._iterKv) {
                return { value: this.makeRowObject(value), done: false };
            }
            else {
                return { value, done: false };
            }
        }
        else if (this._status === Status.SqliteDone) {
            return { value: null, done: true };
        }
        else {
            throw new SqliteError(this._wasm, this._status);
        }
    }
    all(params) {
        this.startQuery(params);
        const rows = [];
        this._status = this._wasm.step(this._stmt);
        while (this._status === Status.SqliteRow) {
            rows.push(this.getQueryRow());
            this._status = this._wasm.step(this._stmt);
        }
        if (this._status !== Status.SqliteDone) {
            throw new SqliteError(this._wasm, this._status);
        }
        return rows;
    }
    allEntries(params) {
        return this.all(params).map((row) => this.makeRowObject(row));
    }
    one(params) {
        this.startQuery(params);
        this._status = this._wasm.step(this._stmt);
        if (this._status !== Status.SqliteRow) {
            if (this._status === Status.SqliteDone) {
                throw new SqliteError("The query did not return any rows.");
            }
            else {
                throw new SqliteError(this._wasm, this._status);
            }
        }
        const row = this.getQueryRow();
        this._status = this._wasm.step(this._stmt);
        if (this._status !== Status.SqliteDone) {
            if (this._status === Status.SqliteRow) {
                throw new SqliteError("The query returned more than one row.");
            }
            else {
                throw new SqliteError(this._wasm, this._status);
            }
        }
        return row;
    }
    oneEntry(params) {
        return this.makeRowObject(this.one(params));
    }
    execute(params) {
        this.startQuery(params);
        this._status = this._wasm.step(this._stmt);
        while (this._status === Status.SqliteRow) {
            this._status = this._wasm.step(this._stmt);
        }
        if (this._status !== Status.SqliteDone) {
            throw new SqliteError(this._wasm, this._status);
        }
    }
    finalize() {
        if (!this._finalized) {
            this._wasm.finalize(this._stmt);
            this._openStatements.delete(this._stmt);
            this._finalized = true;
        }
    }
    columns() {
        if (this._finalized) {
            throw new SqliteError("Unable to retrieve column names from finalized transaction.");
        }
        const columnCount = this._wasm.column_count(this._stmt);
        const columns = [];
        for (let i = 0; i < columnCount; i++) {
            const name = getStr(this._wasm, this._wasm.column_name(this._stmt, i));
            const originName = getStr(this._wasm, this._wasm.column_origin_name(this._stmt, i));
            const tableName = getStr(this._wasm, this._wasm.column_table_name(this._stmt, i));
            columns.push({ name, originName, tableName });
        }
        return columns;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJxdWVyeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFlBQVksQ0FBQztBQXNHekMsTUFBTSxPQUFPLGFBQWE7SUFLaEIsS0FBSyxDQUFPO0lBQ1osS0FBSyxDQUFlO0lBQ3BCLGVBQWUsQ0FBb0I7SUFFbkMsT0FBTyxDQUFTO0lBQ2hCLE9BQU8sQ0FBVTtJQUNqQixRQUFRLENBQWlCO0lBQ3pCLFVBQVUsQ0FBVTtJQVU1QixZQUNFLElBQVUsRUFDVixJQUFrQixFQUNsQixjQUFpQztRQUVqQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsZUFBZSxHQUFHLGNBQWMsQ0FBQztRQUV0QyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFDOUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDMUIsQ0FBQztJQUVPLFVBQVUsQ0FBQyxNQUFVO1FBQzNCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixNQUFNLElBQUksV0FBVyxDQUFDLHFCQUFxQixDQUFDLENBQUM7U0FDOUM7UUFHRCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBR3RDLElBQUks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LENBQzdDLENBQUM7WUFDRixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQ3RCLElBQUksQ0FBQyxLQUFLLEVBQ1YsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUM1QyxDQUFDO1lBQ0YsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztTQUMvQztRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YXRlbWVudFB0ciwgV2FzbSB9IGZyb20gXCIuLi9idWlsZC9zcWxpdGUuanNcIjtcbmltcG9ydCB7IGdldFN0ciwgc2V0QXJyLCBzZXRTdHIgfSBmcm9tIFwiLi93YXNtLnRzXCI7XG5pbXBvcnQgeyBTdGF0dXMsIFR5cGVzLCBWYWx1ZXMgfSBmcm9tIFwiLi9jb25zdGFudHMudHNcIjtcbmltcG9ydCB7IFNxbGl0ZUVycm9yIH0gZnJvbSBcIi4vZXJyb3IudHNcIjtcblxuLyoqXG4gKiBUaGUgZGVmYXVsdCB0eXBlIGZvciByZXR1cm5lZCByb3dzLlxuICovXG5leHBvcnQgdHlwZSBSb3cgPSBBcnJheTx1bmtub3duPjtcblxuLyoqXG4gKiBUaGUgZGVmYXVsdCB0eXBlIGZvciByb3cgcmV0dXJuZWRcbiAqIGFzIG9iamVjdHMuXG4gKi9cbmV4cG9ydCB0eXBlIFJvd09iamVjdCA9IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG4vKipcbiAqIFBvc3NpYmxlIHBhcmFtZXRlciB2YWx1ZXMgdG8gYmUgYm91bmQgdG8gYSBxdWVyeS5cbiAqXG4gKiBXaGVuIHZhbHVlcyBhcmUgYm91bmQgdG8gYSBxdWVyeSwgdGhleSBhcmVcbiAqIGNvbnZlcnRlZCBiZXR3ZWVuIEphdmFTY3JpcHQgYW5kIFNRTGl0ZSB0eXBlc1xuICogaW4gdGhlIGZvbGxvd2luZyB3YXk6XG4gKlxuICogfCBKUyB0eXBlIGluIHwgU1FMIHR5cGUgICAgICAgIHwgSlMgdHlwZSBvdXQgICAgICB8XG4gKiB8LS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLXxcbiAqIHwgbnVtYmVyICAgICB8IElOVEVHRVIgb3IgUkVBTCB8IG51bWJlciBvciBiaWdpbnQgfFxuICogfCBiaWdpbnQgICAgIHwgSU5URUdFUiAgICAgICAgIHwgbnVtYmVyIG9yIGJpZ2ludCB8XG4gKiB8IGJvb2xlYW4gICAgfCBJTlRFR0VSICAgICAgICAgfCBudW1iZXIgICAgICAgICAgIHxcbiAqIHwgc3RyaW5nICAgICB8IFRFWFQgICAgICAgICAgICB8IHN0cmluZyAgICAgICAgICAgfFxuICogfCBEYXRlICAgICAgIHwgVEVYVCAgICAgICAgICAgIHwgc3RyaW5nICAgICAgICAgICB8XG4gKiB8IFVpbnQ4QXJyYXkgfCBCTE9CICAgICAgICAgICAgfCBVaW50OEFycmF5ICAgICAgIHxcbiAqIHwgbnVsbCAgICAgICB8IE5VTEwgICAgICAgICAgICB8IG51bGwgICAgICAgICAgICAgfFxuICogfCB1bmRlZmluZWQgIHwgTlVMTCAgICAgICAgICAgIHwgbnVsbCAgICAgICAgICAgICB8XG4gKlxuICogSWYgbm8gdmFsdWUgaXMgcHJvdmlkZWQgZm9yIGEgZ2l2ZW4gcGFyYW1ldGVyLFxuICogU1FMaXRlIHdpbGwgZGVmYXVsdCB0byBOVUxMLlxuICpcbiAqIElmIGEgYGJpZ2ludGAgaXMgYm91bmQsIGl0IGlzIGNvbnZlcnRlZCB0byBhXG4gKiBzaWduZWQgNjQgYml0IGludGVnZXIsIHdoaWNoIG1heSBvdmVyZmxvdy5cbiAqXG4gKiBJZiBhbiBpbnRlZ2VyIHZhbHVlIGlzIHJlYWQgZnJvbSB0aGUgZGF0YWJhc2UsIHdoaWNoXG4gKiBpcyB0b28gYmlnIHRvIHNhZmVseSBiZSBjb250YWluZWQgaW4gYSBgbnVtYmVyYCwgaXRcbiAqIGlzIGF1dG9tYXRpY2FsbHkgcmV0dXJuZWQgYXMgYSBgYmlnaW50YC5cbiAqXG4gKiBJZiBhIGBEYXRlYCBpcyBib3VuZCwgaXQgd2lsbCBiZSBjb252ZXJ0ZWQgdG9cbiAqIGFuIElTTyA4NjAxIHN0cmluZzogYFlZWVktTU0tRERUSEg6TU06U1MuU1NTWmAuXG4gKiBUaGlzIGZvcm1hdCBpcyB1bmRlcnN0b29kIGJ5IGJ1aWx0LWluIFNRTGl0ZVxuICogZGF0ZS10aW1lIGZ1bmN0aW9ucy4gQWxzbyBzZWUgaHR0cHM6Ly9zcWxpdGUub3JnL2xhbmdfZGF0ZWZ1bmMuaHRtbC5cbiAqL1xuZXhwb3J0IHR5cGUgUXVlcnlQYXJhbWV0ZXIgPVxuICB8IGJvb2xlYW5cbiAgfCBudW1iZXJcbiAgfCBiaWdpbnRcbiAgfCBzdHJpbmdcbiAgfCBudWxsXG4gIHwgdW5kZWZpbmVkXG4gIHwgRGF0ZVxuICB8IFVpbnQ4QXJyYXk7XG5cbi8qKlxuICogQSBzZXQgb2YgcXVlcnkgcGFyYW1ldGVycy5cbiAqXG4gKiBXaGVuIGEgcXVlcnkgaXMgY29uc3RydWN0ZWQsIGl0IGNhbiBjb250YWluXG4gKiBlaXRoZXIgcG9zaXRpb25hbCBvciBuYW1lZCBwYXJhbWV0ZXJzLiBGb3JcbiAqIG1vcmUgaW5mb3JtYXRpb24gc2VlIGh0dHBzOi8vd3d3LnNxbGl0ZS5vcmcvbGFuZ19leHByLmh0bWwjcGFyYW1ldGVycy5cbiAqXG4gKiBBIHNldCBvZiBwYXJhbWV0ZXJzIGNhbiBiZSBwYXNzZWQgdG9cbiAqIGEgcXVlcnkgbWV0aG9kIGVpdGhlciBhcyBhbiBhcnJheSBvZlxuICogcGFyYW1ldGVycyAoaW4gcG9zaXRpb25hbCBvcmRlciksIG9yXG4gKiBhcyBhbiBvYmplY3Qgd2hpY2ggbWFwcyBwYXJhbWV0ZXIgbmFtZXNcbiAqIHRvIHRoZWlyIHZhbHVlczpcbiAqXG4gKiB8IFNRTCBQYXJhbWV0ZXIgfCBRdWVyeVBhcmFtZXRlclNldCAgICAgICB8XG4gKiB8LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18XG4gKiB8IGA/Tk5OYCBvciBgP2AgfCBOTk4tdGggdmFsdWUgaW4gYXJyYXkgICB8XG4gKiB8IGA6QUFBQWAgICAgICAgfCB2YWx1ZSBgQUFBQWAgb3IgYDpBQUFBYCB8XG4gKiB8IGBAQUFBQWAgICAgICAgfCB2YWx1ZSBgQEFBQUFgICAgICAgICAgICB8XG4gKiB8IGAkQUFBQWAgICAgICAgfCB2YWx1ZSBgJEFBQUFgICAgICAgICAgICB8XG4gKlxuICogU2VlIGBRdWVyeVBhcmFtZXRlcmAgZm9yIGRvY3VtZW50YXRpb24gb25cbiAqIGhvdyB2YWx1ZXMgYXJlIGNvbnZlcnRlZCBiZXR3ZWVuIFNRTFxuICogYW5kIEphdmFTY3JpcHQgdHlwZXMuXG4gKi9cbmV4cG9ydCB0eXBlIFF1ZXJ5UGFyYW1ldGVyU2V0ID1cbiAgfCBSZWNvcmQ8c3RyaW5nLCBRdWVyeVBhcmFtZXRlcj5cbiAgfCBBcnJheTxRdWVyeVBhcmFtZXRlcj47XG5cbi8qKlxuICogTmFtZSBvZiBhIGNvbHVtbiBpbiBhIGRhdGFiYXNlIHF1ZXJ5LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbHVtbk5hbWUge1xuICBuYW1lOiBzdHJpbmc7XG4gIG9yaWdpbk5hbWU6IHN0cmluZztcbiAgdGFibGVOYW1lOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBSb3dzSXRlcmF0b3I8Uj4ge1xuICBuZXh0OiAoKSA9PiBJdGVyYXRvclJlc3VsdDxSPjtcbiAgW1N5bWJvbC5pdGVyYXRvcl06ICgpID0+IFJvd3NJdGVyYXRvcjxSPjtcbn1cblxuLyoqXG4gKiBBIHByZXBhcmVkIHF1ZXJ5IHdoaWNoIGNhbiBiZSBleGVjdXRlZCBtYW55XG4gKiB0aW1lcy5cbiAqL1xuZXhwb3J0IGNsYXNzIFByZXBhcmVkUXVlcnk8XG4gIFIgZXh0ZW5kcyBSb3cgPSBSb3csXG4gIE8gZXh0ZW5kcyBSb3dPYmplY3QgPSBSb3dPYmplY3QsXG4gIFAgZXh0ZW5kcyBRdWVyeVBhcmFtZXRlclNldCA9IFF1ZXJ5UGFyYW1ldGVyU2V0LFxuPiB7XG4gIHByaXZhdGUgX3dhc206IFdhc207XG4gIHByaXZhdGUgX3N0bXQ6IFN0YXRlbWVudFB0cjtcbiAgcHJpdmF0ZSBfb3BlblN0YXRlbWVudHM6IFNldDxTdGF0ZW1lbnRQdHI+O1xuXG4gIHByaXZhdGUgX3N0YXR1czogbnVtYmVyO1xuICBwcml2YXRlIF9pdGVyS3Y6IGJvb2xlYW47XG4gIHByaXZhdGUgX3Jvd0tleXM/OiBBcnJheTxzdHJpbmc+O1xuICBwcml2YXRlIF9maW5hbGl6ZWQ6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIEEgcHJlcGFyZWQgcXVlcnkgd2hpY2ggY2FuIGJlIGV4ZWN1dGVkIG1hbnlcbiAgICogdGltZXMuXG4gICAqXG4gICAqIFRoZSBjb25zdHJ1Y3RvciBzaG91bGQgbmV2ZXIgYmUgdXNlZCBkaXJlY3RseS5cbiAgICogSW5zdGVhZCBhIHByZXBhcmVkIHF1ZXJ5IGNhbiBiZSBvYnRhaW5lZCBieVxuICAgKiBjYWxsaW5nIGBEQi5wcmVwYXJlUXVlcnlgLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgd2FzbTogV2FzbSxcbiAgICBzdG10OiBTdGF0ZW1lbnRQdHIsXG4gICAgb3BlblN0YXRlbWVudHM6IFNldDxTdGF0ZW1lbnRQdHI+LFxuICApIHtcbiAgICB0aGlzLl93YXNtID0gd2FzbTtcbiAgICB0aGlzLl9zdG10ID0gc3RtdDtcbiAgICB0aGlzLl9vcGVuU3RhdGVtZW50cyA9IG9wZW5TdGF0ZW1lbnRzO1xuXG4gICAgdGhpcy5fc3RhdHVzID0gU3RhdHVzLlVua25vd247XG4gICAgdGhpcy5faXRlckt2ID0gZmFsc2U7XG4gICAgdGhpcy5fZmluYWxpemVkID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0UXVlcnkocGFyYW1zPzogUCkge1xuICAgIGlmICh0aGlzLl9maW5hbGl6ZWQpIHtcbiAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcihcIlF1ZXJ5IGlzIGZpbmFsaXplZC5cIik7XG4gICAgfVxuXG4gICAgLy8gUmVzZXQgcXVlcnlcbiAgICB0aGlzLl93YXNtLnJlc2V0KHRoaXMuX3N0bXQpO1xuICAgIHRoaXMuX3dhc20uY2xlYXJfYmluZGluZ3ModGhpcy5fc3RtdCk7XG5cbiAgICAvLyBQcmVwYXJlIHBhcmFtZXRlciBhcnJheVxuICAgIGxldCBwYXJhbWV0ZXJzID0gW107XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocGFyYW1zKSkge1xuICAgICAgcGFyYW1ldGVycyA9IHBhcmFtcztcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXJhbXMgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIC8vIFJlc29sdmUgcGFyYW1ldGVyIGluZGV4IGZvciBuYW1lZCBwYXJhbWV0ZXJcbiAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHBhcmFtcykpIHtcbiAgICAgICAgbGV0IG5hbWUgPSBrZXk7XG4gICAgICAgIC8vIGJsYW5rIG5hbWVzIGRlZmF1bHQgdG8gJzonXG4gICAgICAgIGlmIChuYW1lWzBdICE9PSBcIjpcIiAmJiBuYW1lWzBdICE9PSBcIkBcIiAmJiBuYW1lWzBdICE9PSBcIiRcIikge1xuICAgICAgICAgIG5hbWUgPSBgOiR7bmFtZX1gO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGlkeCA9IHNldFN0cihcbiAgICAgICAgICB0aGlzLl93YXNtLFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgKHB0cikgPT4gdGhpcy5fd2FzbS5iaW5kX3BhcmFtZXRlcl9pbmRleCh0aGlzLl9zdG10LCBwdHIpLFxuICAgICAgICApO1xuICAgICAgICBpZiAoaWR4ID09PSBWYWx1ZXMuRXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IoYE5vIHBhcmFtZXRlciBuYW1lZCAnJHtuYW1lfScuYCk7XG4gICAgICAgIH1cbiAgICAgICAgcGFyYW1ldGVyc1tpZHggLSAxXSA9IHBhcmFtc1trZXldO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEJpbmQgcGFyYW1ldGVyc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1ldGVycy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHZhbHVlID0gcGFyYW1ldGVyc1tpXTtcbiAgICAgIGxldCBzdGF0dXM7XG4gICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkge1xuICAgICAgICBjYXNlIFwiYm9vbGVhblwiOlxuICAgICAgICAgIHZhbHVlID0gdmFsdWUgPyAxIDogMDtcbiAgICAgICAgICAvLyBmYWxsIHRocm91Z2hcbiAgICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICAgIGlmIChOdW1iZXIuaXNTYWZlSW50ZWdlcih2YWx1ZSkpIHtcbiAgICAgICAgICAgIHN0YXR1cyA9IHRoaXMuX3dhc20uYmluZF9pbnQodGhpcy5fc3RtdCwgaSArIDEsIHZhbHVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RhdHVzID0gdGhpcy5fd2FzbS5iaW5kX2RvdWJsZSh0aGlzLl9zdG10LCBpICsgMSwgdmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImJpZ2ludFwiOlxuICAgICAgICAgIC8vIGJpZ2ludCBpcyBib3VuZCBhcyB0d28gMzJiaXQgaW50ZWdlcnMgYW5kIHJlYXNzZW1ibGVkIG9uIHRoZSBDIHNpZGVcbiAgICAgICAgICBpZiAodmFsdWUgPiA5MjIzMzcyMDM2ODU0Nzc1ODA3biB8fCB2YWx1ZSA8IC05MjIzMzcyMDM2ODU0Nzc1ODA4bikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKFxuICAgICAgICAgICAgICBgQmlnSW50IHZhbHVlICR7dmFsdWV9IG92ZXJmbG93cyA2NCBiaXQgaW50ZWdlci5gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgcG9zVmFsID0gdmFsdWUgPj0gMG4gPyB2YWx1ZSA6IC12YWx1ZTtcbiAgICAgICAgICAgIGNvbnN0IHNpZ24gPSB2YWx1ZSA+PSAwbiA/IDEgOiAtMTtcbiAgICAgICAgICAgIGNvbnN0IHVwcGVyID0gTnVtYmVyKEJpZ0ludC5hc1VpbnROKDMyLCBwb3NWYWwgPj4gMzJuKSk7XG4gICAgICAgICAgICBjb25zdCBsb3dlciA9IE51bWJlcihCaWdJbnQuYXNVaW50TigzMiwgcG9zVmFsKSk7XG4gICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLmJpbmRfYmlnX2ludChcbiAgICAgICAgICAgICAgdGhpcy5fc3RtdCxcbiAgICAgICAgICAgICAgaSArIDEsXG4gICAgICAgICAgICAgIHNpZ24sXG4gICAgICAgICAgICAgIHVwcGVyLFxuICAgICAgICAgICAgICBsb3dlcixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgICAgc3RhdHVzID0gc2V0U3RyKFxuICAgICAgICAgICAgdGhpcy5fd2FzbSxcbiAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgKHB0cikgPT4gdGhpcy5fd2FzbS5iaW5kX3RleHQodGhpcy5fc3RtdCwgaSArIDEsIHB0ciksXG4gICAgICAgICAgKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7XG4gICAgICAgICAgICAvLyBEYXRlcyBhcmUgYWxsb3dlZCBhbmQgYm91bmQgdG8gVEVYVCwgZm9ybWF0dGVkIGBZWVlZLU1NLUREVEhIOk1NOlNTLlNTU1pgXG4gICAgICAgICAgICBzdGF0dXMgPSBzZXRTdHIoXG4gICAgICAgICAgICAgIHRoaXMuX3dhc20sXG4gICAgICAgICAgICAgIHZhbHVlLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICAgIChwdHIpID0+IHRoaXMuX3dhc20uYmluZF90ZXh0KHRoaXMuX3N0bXQsIGkgKyAxLCBwdHIpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSkge1xuICAgICAgICAgICAgLy8gVWludDhBcnJheXMgYXJlIGFsbG93ZWQgYW5kIGJvdW5kIHRvIEJMT0JcbiAgICAgICAgICAgIGNvbnN0IHNpemUgPSB2YWx1ZS5sZW5ndGg7XG4gICAgICAgICAgICBzdGF0dXMgPSBzZXRBcnIoXG4gICAgICAgICAgICAgIHRoaXMuX3dhc20sXG4gICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICAocHRyKSA9PiB0aGlzLl93YXNtLmJpbmRfYmxvYih0aGlzLl9zdG10LCBpICsgMSwgcHRyLCBzaXplKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyBCb3RoIG51bGwgYW5kIHVuZGVmaW5lZCByZXN1bHQgaW4gYSBOVUxMIGVudHJ5XG4gICAgICAgICAgICBzdGF0dXMgPSB0aGlzLl93YXNtLmJpbmRfbnVsbCh0aGlzLl9zdG10LCBpICsgMSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcihgQ2FuIG5vdCBiaW5kICR7dHlwZW9mIHZhbHVlfS5gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBpZiAoc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlT2spIHtcbiAgICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKHRoaXMuX3dhc20sIHN0YXR1cyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRRdWVyeVJvdygpOiBSIHtcbiAgICBpZiAodGhpcy5fZmluYWxpemVkKSB7XG4gICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IoXCJRdWVyeSBpcyBmaW5hbGl6ZWQuXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbHVtbkNvdW50ID0gdGhpcy5fd2FzbS5jb2x1bW5fY291bnQodGhpcy5fc3RtdCk7XG4gICAgY29uc3Qgcm93OiBSb3cgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbHVtbkNvdW50OyBpKyspIHtcbiAgICAgIHN3aXRjaCAodGhpcy5fd2FzbS5jb2x1bW5fdHlwZSh0aGlzLl9zdG10LCBpKSkge1xuICAgICAgICBjYXNlIFR5cGVzLkludGVnZXI6XG4gICAgICAgICAgcm93LnB1c2godGhpcy5fd2FzbS5jb2x1bW5faW50KHRoaXMuX3N0bXQsIGkpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUeXBlcy5GbG9hdDpcbiAgICAgICAgICByb3cucHVzaCh0aGlzLl93YXNtLmNvbHVtbl9kb3VibGUodGhpcy5fc3RtdCwgaSkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFR5cGVzLlRleHQ6XG4gICAgICAgICAgcm93LnB1c2goXG4gICAgICAgICAgICBnZXRTdHIoXG4gICAgICAgICAgICAgIHRoaXMuX3dhc20sXG4gICAgICAgICAgICAgIHRoaXMuX3dhc20uY29sdW1uX3RleHQodGhpcy5fc3RtdCwgaSksXG4gICAgICAgICAgICApLFxuICAgICAgICAgICk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVHlwZXMuQmxvYjoge1xuICAgICAgICAgIGNvbnN0IHB0ciA9IHRoaXMuX3dhc20uY29sdW1uX2Jsb2IodGhpcy5fc3RtdCwgaSk7XG4gICAgICAgICAgaWYgKHB0ciA9PT0gMCkge1xuICAgICAgICAgICAgLy8gWmVybyBwb2ludGVyIHJlc3VsdHMgaW4gbnVsbFxuICAgICAgICAgICAgcm93LnB1c2gobnVsbCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuX3dhc20uY29sdW1uX2J5dGVzKHRoaXMuX3N0bXQsIGkpO1xuICAgICAgICAgICAgLy8gU2xpY2Ugc2hvdWxkIGNvcHkgdGhlIGJ5dGVzLCBhcyBpdCBtYWtlcyBhIHNoYWxsb3cgY29weVxuICAgICAgICAgICAgcm93LnB1c2goXG4gICAgICAgICAgICAgIG5ldyBVaW50OEFycmF5KHRoaXMuX3dhc20ubWVtb3J5LmJ1ZmZlciwgcHRyLCBsZW5ndGgpLnNsaWNlKCksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFR5cGVzLkJpZ0ludGVnZXI6IHtcbiAgICAgICAgICBjb25zdCBwdHIgPSB0aGlzLl93YXNtLmNvbHVtbl90ZXh0KHRoaXMuX3N0bXQsIGkpO1xuICAgICAgICAgIHJvdy5wdXNoKEJpZ0ludChnZXRTdHIodGhpcy5fd2FzbSwgcHRyKSkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgLy8gVE9ETyhkeWVkZ3JlZW4pOiBEaWZmZXJlbnRpYXRlIGJldHdlZW4gTlVMTCBhbmQgbm90LXJlY29nbml6ZWQ/XG4gICAgICAgICAgcm93LnB1c2gobnVsbCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByb3cgYXMgUjtcbiAgfVxuXG4gIHByaXZhdGUgbWFrZVJvd09iamVjdChyb3c6IFJvdyk6IE8ge1xuICAgIGlmICh0aGlzLl9yb3dLZXlzID09IG51bGwpIHtcbiAgICAgIGNvbnN0IHJvd0NvdW50ID0gdGhpcy5fd2FzbS5jb2x1bW5fY291bnQodGhpcy5fc3RtdCk7XG4gICAgICB0aGlzLl9yb3dLZXlzID0gW107XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJvd0NvdW50OyBpKyspIHtcbiAgICAgICAgdGhpcy5fcm93S2V5cy5wdXNoKFxuICAgICAgICAgIGdldFN0cih0aGlzLl93YXNtLCB0aGlzLl93YXNtLmNvbHVtbl9uYW1lKHRoaXMuX3N0bXQsIGkpKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBvYmogPSByb3cucmVkdWNlPFJvd09iamVjdD4oKG9iaiwgdmFsLCBpZHgpID0+IHtcbiAgICAgIG9ialt0aGlzLl9yb3dLZXlzIVtpZHhdXSA9IHZhbDtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfSwge30pO1xuICAgIHJldHVybiBvYmogYXMgTztcbiAgfVxuXG4gIC8qKlxuICAgKiBCaW5kcyB0aGUgZ2l2ZW4gcGFyYW1ldGVycyB0byB0aGUgcXVlcnlcbiAgICogYW5kIHJldHVybnMgYW4gaXRlcmF0b3Igb3ZlciByb3dzLlxuICAgKlxuICAgKiBVc2luZyBhbiBpdGVyYXRvciBhdm9pZHMgbG9hZGluZyBhbGwgcmV0dXJuZWRcbiAgICogcm93cyBpbnRvIG1lbW9yeSBhbmQgaGVuY2UgYWxsb3dzIHRvIHByb2Nlc3MgYSBsYXJnZVxuICAgKiBudW1iZXIgb2Ygcm93cy5cbiAgICpcbiAgICogIyBFeGFtcGxlOlxuICAgKiBgYGB0eXBlc2NyaXB0XG4gICAqIGNvbnN0IHF1ZXJ5ID0gZGIucHJlcGFyZVF1ZXJ5PFtudW1iZXIsIHN0cmluZ10+KFwiU0VMRUNUIGlkLCBuYW1lIEZST00gcGVvcGxlXCIpO1xuICAgKiBmb3IgKGNvbnN0IFtpZCwgbmFtZV0gb2YgcXVlcnkuaXRlcigpKSB7XG4gICAqICAgLy8gLi4uXG4gICAqIH1cbiAgICogYGBgXG4gICAqXG4gICAqIENhbGxpbmcgYGl0ZXJgIGludmFsaWRhdGVzIGFueSBpdGVyYXRvcnMgcHJldmlvdXNseSByZXR1cm5lZFxuICAgKiBmcm9tIHRoaXMgcHJlcGFyZWQgcXVlcnkuIFVzaW5nIGFuIGludmFsaWRhdGVkIGl0ZXJhdG9yIGlzIGEgYnVnLlxuICAgKlxuICAgKiBUbyBhdm9pZCBTUUwgaW5qZWN0aW9uLCB1c2VyLXByb3ZpZGVkIHZhbHVlc1xuICAgKiBzaG91bGQgYWx3YXlzIGJlIHBhc3NlZCB0byB0aGUgZGF0YWJhc2UgdGhyb3VnaFxuICAgKiBhIHF1ZXJ5IHBhcmFtZXRlci5cbiAgICpcbiAgICogU2VlIGBRdWVyeVBhcmFtZXRlclNldGAgZm9yIGRvY3VtZW50YXRpb24gb25cbiAgICogaG93IHZhbHVlcyBjYW4gYmUgYm91bmQgdG8gU1FMIHN0YXRlbWVudHMuXG4gICAqXG4gICAqIFNlZSBgUXVlcnlQYXJhbWV0ZXJgIGZvciBkb2N1bWVudGF0aW9uIG9uIGhvd1xuICAgKiB2YWx1ZXMgYXJlIHJldHVybmVkIGZyb20gdGhlIGRhdGFiYXNlLlxuICAgKi9cbiAgaXRlcihwYXJhbXM/OiBQKTogUm93c0l0ZXJhdG9yPFI+IHtcbiAgICB0aGlzLnN0YXJ0UXVlcnkocGFyYW1zKTtcbiAgICB0aGlzLl9zdGF0dXMgPSB0aGlzLl93YXNtLnN0ZXAodGhpcy5fc3RtdCk7XG4gICAgaWYgKFxuICAgICAgdGhpcy5fc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlUm93ICYmIHRoaXMuX3N0YXR1cyAhPT0gU3RhdHVzLlNxbGl0ZURvbmVcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcih0aGlzLl93YXNtLCB0aGlzLl9zdGF0dXMpO1xuICAgIH1cbiAgICB0aGlzLl9pdGVyS3YgPSBmYWxzZTtcbiAgICByZXR1cm4gdGhpcyBhcyBSb3dzSXRlcmF0b3I8Uj47XG4gIH1cblxuICAvKipcbiAgICogTGlrZSBgaXRlcmAgZXhjZXB0IGVhY2ggcm93IGlzIHJldHVybmVkXG4gICAqIGFzIGFuIG9iamVjdCBjb250YWluaW5nIGtleS12YWx1ZSBwYWlycy5cbiAgICovXG4gIGl0ZXJFbnRyaWVzKHBhcmFtcz86IFApOiBSb3dzSXRlcmF0b3I8Tz4ge1xuICAgIHRoaXMuaXRlcihwYXJhbXMpO1xuICAgIHRoaXMuX2l0ZXJLdiA9IHRydWU7XG4gICAgcmV0dXJuIHRoaXMgYXMgUm93c0l0ZXJhdG9yPE8+O1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICpcbiAgICogSW1wbGVtZW50cyB0aGUgaXRlcmFibGUgcHJvdG9jb2wuIEl0IGlzXG4gICAqIGEgYnVnIHRvIGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHkuXG4gICAqL1xuICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBSb3dzSXRlcmF0b3I8UiB8IE8+IHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqXG4gICAqIEltcGxlbWVudHMgdGhlIGl0ZXJhdG9yIHByb3RvY29sLiBJdCBpc1xuICAgKiBhIGJ1ZyB0byBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5LlxuICAgKi9cbiAgbmV4dCgpOiBJdGVyYXRvclJlc3VsdDxSIHwgTz4ge1xuICAgIGlmICh0aGlzLl9zdGF0dXMgPT09IFN0YXR1cy5TcWxpdGVSb3cpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRRdWVyeVJvdygpO1xuICAgICAgdGhpcy5fc3RhdHVzID0gdGhpcy5fd2FzbS5zdGVwKHRoaXMuX3N0bXQpO1xuICAgICAgaWYgKHRoaXMuX2l0ZXJLdikge1xuICAgICAgICByZXR1cm4geyB2YWx1ZTogdGhpcy5tYWtlUm93T2JqZWN0KHZhbHVlKSwgZG9uZTogZmFsc2UgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB7IHZhbHVlLCBkb25lOiBmYWxzZSB9O1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGhpcy5fc3RhdHVzID09PSBTdGF0dXMuU3FsaXRlRG9uZSkge1xuICAgICAgcmV0dXJuIHsgdmFsdWU6IG51bGwsIGRvbmU6IHRydWUgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKHRoaXMuX3dhc20sIHRoaXMuX3N0YXR1cyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJpbmRzIHRoZSBnaXZlbiBwYXJhbWV0ZXJzIHRvIHRoZSBxdWVyeVxuICAgKiBhbmQgcmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIGFsbCByZXN1bHRpbmdcbiAgICogcm93cy5cbiAgICpcbiAgICogQ2FsbGluZyBgYWxsYCBpbnZhbGlkYXRlcyBhbnkgaXRlcmF0b3JzXG4gICAqIHByZXZpb3VzbHkgcmV0dXJuZWQgYnkgY2FsbHMgdG8gYGl0ZXJgLlxuICAgKiBVc2luZyBhbiBpbnZhbGlkYXRlZCBpdGVyYXRvciBpcyBhIGJ1Zy5cbiAgICpcbiAgICogVG8gYXZvaWQgU1FMIGluamVjdGlvbiwgdXNlci1wcm92aWRlZCB2YWx1ZXNcbiAgICogc2hvdWxkIGFsd2F5cyBiZSBwYXNzZWQgdG8gdGhlIGRhdGFiYXNlIHRocm91Z2hcbiAgICogYSBxdWVyeSBwYXJhbWV0ZXIuXG4gICAqXG4gICAqIFNlZSBgUXVlcnlQYXJhbWV0ZXJTZXRgIGZvciBkb2N1bWVudGF0aW9uIG9uXG4gICAqIGhvdyB2YWx1ZXMgY2FuIGJlIGJvdW5kIHRvIFNRTCBzdGF0ZW1lbnRzLlxuICAgKlxuICAgKiBTZWUgYFF1ZXJ5UGFyYW1ldGVyYCBmb3IgZG9jdW1lbnRhdGlvbiBvbiBob3dcbiAgICogdmFsdWVzIGFyZSByZXR1cm5lZCBmcm9tIHRoZSBkYXRhYmFzZS5cbiAgICovXG4gIGFsbChwYXJhbXM/OiBQKTogQXJyYXk8Uj4ge1xuICAgIHRoaXMuc3RhcnRRdWVyeShwYXJhbXMpO1xuICAgIGNvbnN0IHJvd3M6IEFycmF5PFI+ID0gW107XG4gICAgdGhpcy5fc3RhdHVzID0gdGhpcy5fd2FzbS5zdGVwKHRoaXMuX3N0bXQpO1xuICAgIHdoaWxlICh0aGlzLl9zdGF0dXMgPT09IFN0YXR1cy5TcWxpdGVSb3cpIHtcbiAgICAgIHJvd3MucHVzaCh0aGlzLmdldFF1ZXJ5Um93KCkpO1xuICAgICAgdGhpcy5fc3RhdHVzID0gdGhpcy5fd2FzbS5zdGVwKHRoaXMuX3N0bXQpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlRG9uZSkge1xuICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKHRoaXMuX3dhc20sIHRoaXMuX3N0YXR1cyk7XG4gICAgfVxuICAgIHJldHVybiByb3dzO1xuICB9XG5cbiAgLyoqXG4gICAqIExpa2UgYGFsbGAgZXhjZXB0IGVhY2ggcm93IGlzIHJldHVybmVkXG4gICAqIGFzIGFuIG9iamVjdCBjb250YWluaW5nIGtleS12YWx1ZSBwYWlycy5cbiAgICovXG4gIGFsbEVudHJpZXMocGFyYW1zPzogUCk6IEFycmF5PE8+IHtcbiAgICByZXR1cm4gdGhpcy5hbGwocGFyYW1zKS5tYXAoKHJvdykgPT4gdGhpcy5tYWtlUm93T2JqZWN0KHJvdykpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJpbmRzIHRoZSBnaXZlbiBwYXJhbWV0ZXJzIHRvIHRoZSBxdWVyeSBhbmRcbiAgICogcmV0dXJucyBleGFjdGx5IG9uZSByb3cuXG4gICAqXG4gICAqIElmIHRoZSBxdWVyeSBkb2VzIG5vdCByZXR1cm4gZXhhY3RseSBvbmUgcm93LFxuICAgKiB0aGlzIHRocm93cyBhbiBlcnJvci5cbiAgICpcbiAgICogQ2FsbGluZyBgb25lYCBpbnZhbGlkYXRlcyBhbnkgaXRlcmF0b3JzXG4gICAqIHByZXZpb3VzbHkgcmV0dXJuZWQgYnkgY2FsbHMgdG8gYGl0ZXJgLlxuICAgKiBVc2luZyBhbiBpbnZhbGlkYXRlZCBpdGVyYXRvciBpcyBhIGJ1Zy5cbiAgICpcbiAgICogVG8gYXZvaWQgU1FMIGluamVjdGlvbiwgdXNlci1wcm92aWRlZCB2YWx1ZXNcbiAgICogc2hvdWxkIGFsd2F5cyBiZSBwYXNzZWQgdG8gdGhlIGRhdGFiYXNlIHRocm91Z2hcbiAgICogYSBxdWVyeSBwYXJhbWV0ZXIuXG4gICAqXG4gICAqIFNlZSBgUXVlcnlQYXJhbWV0ZXJTZXRgIGZvciBkb2N1bWVudGF0aW9uIG9uXG4gICAqIGhvdyB2YWx1ZXMgY2FuIGJlIGJvdW5kIHRvIFNRTCBzdGF0ZW1lbnRzLlxuICAgKlxuICAgKiBTZWUgYFF1ZXJ5UGFyYW1ldGVyYCBmb3IgZG9jdW1lbnRhdGlvbiBvbiBob3dcbiAgICogdmFsdWVzIGFyZSByZXR1cm5lZCBmcm9tIHRoZSBkYXRhYmFzZS5cbiAgICovXG4gIG9uZShwYXJhbXM/OiBQKTogUiB7XG4gICAgdGhpcy5zdGFydFF1ZXJ5KHBhcmFtcyk7XG5cbiAgICAvLyBHZXQgZmlyc3Qgcm93XG4gICAgdGhpcy5fc3RhdHVzID0gdGhpcy5fd2FzbS5zdGVwKHRoaXMuX3N0bXQpO1xuICAgIGlmICh0aGlzLl9zdGF0dXMgIT09IFN0YXR1cy5TcWxpdGVSb3cpIHtcbiAgICAgIGlmICh0aGlzLl9zdGF0dXMgPT09IFN0YXR1cy5TcWxpdGVEb25lKSB7XG4gICAgICAgIHRocm93IG5ldyBTcWxpdGVFcnJvcihcIlRoZSBxdWVyeSBkaWQgbm90IHJldHVybiBhbnkgcm93cy5cIik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IodGhpcy5fd2FzbSwgdGhpcy5fc3RhdHVzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qgcm93ID0gdGhpcy5nZXRRdWVyeVJvdygpO1xuXG4gICAgLy8gRW5zdXJlIHRoZSBxdWVyeSBvbmx5IHJldHVybnMgb25lIHJvd1xuICAgIHRoaXMuX3N0YXR1cyA9IHRoaXMuX3dhc20uc3RlcCh0aGlzLl9zdG10KTtcbiAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlRG9uZSkge1xuICAgICAgaWYgKHRoaXMuX3N0YXR1cyA9PT0gU3RhdHVzLlNxbGl0ZVJvdykge1xuICAgICAgICB0aHJvdyBuZXcgU3FsaXRlRXJyb3IoXCJUaGUgcXVlcnkgcmV0dXJuZWQgbW9yZSB0aGFuIG9uZSByb3cuXCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKHRoaXMuX3dhc20sIHRoaXMuX3N0YXR1cyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJvdztcbiAgfVxuXG4gIC8qKlxuICAgKiBMaWtlIGBvbmVgIGV4Y2VwdCB0aGUgcm93IGlzIHJldHVybmVkXG4gICAqIGFzIGFuIG9iamVjdCBjb250YWluaW5nIGtleS12YWx1ZSBwYWlycy5cbiAgICovXG4gIG9uZUVudHJ5KHBhcmFtcz86IFApOiBPIHtcbiAgICByZXR1cm4gdGhpcy5tYWtlUm93T2JqZWN0KHRoaXMub25lKHBhcmFtcykpO1xuICB9XG5cbiAgLyoqXG4gICAqIEJpbmRzIHRoZSBnaXZlbiBwYXJhbWV0ZXJzIHRvIHRoZSBxdWVyeSBhbmRcbiAgICogZXhlY3V0ZXMgdGhlIHF1ZXJ5LCBpZ25vcmluZyBhbnkgcm93cyB3aGljaFxuICAgKiBtaWdodCBiZSByZXR1cm5lZC5cbiAgICpcbiAgICogVXNpbmcgdGhpcyBtZXRob2QgaXMgbW9yZSBlZmZpY2llbnQgd2hlbiB0aGVcbiAgICogcm93cyByZXR1cm5lZCBieSBhIHF1ZXJ5IGFyZSBub3QgbmVlZGVkIG9yXG4gICAqIHRoZSBxdWVyeSBkb2VzIG5vdCByZXR1cm4gYW55IHJvd3MuXG4gICAqXG4gICAqIENhbGxpbmcgYGV4ZWN1dGVgIGludmFsaWRhdGVzIGFueSBpdGVyYXRvcnNcbiAgICogcHJldmlvdXNseSByZXR1cm5lZCBieSBjYWxscyB0byBgaXRlcmAuXG4gICAqIFVzaW5nIGFuIGludmFsaWRhdGVkIGl0ZXJhdG9yIGlzIGEgYnVnLlxuICAgKlxuICAgKiBUbyBhdm9pZCBTUUwgaW5qZWN0aW9uLCB1c2VyLXByb3ZpZGVkIHZhbHVlc1xuICAgKiBzaG91bGQgYWx3YXlzIGJlIHBhc3NlZCB0byB0aGUgZGF0YWJhc2UgdGhyb3VnaFxuICAgKiBhIHF1ZXJ5IHBhcmFtZXRlci5cbiAgICpcbiAgICogU2VlIGBRdWVyeVBhcmFtZXRlclNldGAgZm9yIGRvY3VtZW50YXRpb24gb25cbiAgICogaG93IHZhbHVlcyBjYW4gYmUgYm91bmQgdG8gU1FMIHN0YXRlbWVudHMuXG4gICAqL1xuICBleGVjdXRlKHBhcmFtcz86IFApIHtcbiAgICB0aGlzLnN0YXJ0UXVlcnkocGFyYW1zKTtcbiAgICB0aGlzLl9zdGF0dXMgPSB0aGlzLl93YXNtLnN0ZXAodGhpcy5fc3RtdCk7XG4gICAgd2hpbGUgKHRoaXMuX3N0YXR1cyA9PT0gU3RhdHVzLlNxbGl0ZVJvdykge1xuICAgICAgdGhpcy5fc3RhdHVzID0gdGhpcy5fd2FzbS5zdGVwKHRoaXMuX3N0bXQpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBTdGF0dXMuU3FsaXRlRG9uZSkge1xuICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKHRoaXMuX3dhc20sIHRoaXMuX3N0YXR1cyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsb3NlcyB0aGUgcHJlcGFyZWQgcXVlcnkuIFRoaXMgbXVzdCBiZVxuICAgKiBjYWxsZWQgb25jZSB0aGUgcXVlcnkgaXMgbm8gbG9uZ2VyIG5lZWRlZFxuICAgKiB0byBhdm9pZCBsZWFraW5nIHJlc291cmNlcy5cbiAgICpcbiAgICogQWZ0ZXIgYSBwcmVwYXJlZCBxdWVyeSBoYXMgYmVlbiBmaW5hbGl6ZWQsXG4gICAqIHRyeWluZyB0byBjYWxsIGBpdGVyYCwgYGFsbGAsIGBvbmVgLFxuICAgKiBgZXhlY3V0ZWAsIG9yIGBjb2x1bW5zYCwgb3IgdXNpbmcgaXRlcmF0b3JzIHdoaWNoIHdoZXJlXG4gICAqIHByZXZpb3VzbHkgb2J0YWluZWQgZnJvbSB0aGUgZmluYWxpemVkIHF1ZXJ5XG4gICAqIGlzIGEgYnVnLlxuICAgKlxuICAgKiBgZmluYWxpemVgIG1heSBzYWZlbHkgYmUgY2FsbGVkIG11bHRpcGxlXG4gICAqIHRpbWVzLlxuICAgKi9cbiAgZmluYWxpemUoKSB7XG4gICAgaWYgKCF0aGlzLl9maW5hbGl6ZWQpIHtcbiAgICAgIHRoaXMuX3dhc20uZmluYWxpemUodGhpcy5fc3RtdCk7XG4gICAgICB0aGlzLl9vcGVuU3RhdGVtZW50cy5kZWxldGUodGhpcy5fc3RtdCk7XG4gICAgICB0aGlzLl9maW5hbGl6ZWQgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBjb2x1bW4gbmFtZXMgZm9yIHRoZSBxdWVyeVxuICAgKiByZXN1bHRzLlxuICAgKlxuICAgKiBUaGlzIG1ldGhvZCByZXR1cm5zIGFuIGFycmF5IG9mIG9iamVjdHMsXG4gICAqIHdoZXJlIGVhY2ggb2JqZWN0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6XG4gICAqXG4gICAqIHwgUHJvcGVydHkgICAgIHwgVmFsdWUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHxcbiAgICogfC0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfFxuICAgKiB8IGBuYW1lYCAgICAgICB8IHRoZSByZXN1bHQgb2YgYHNxbGl0ZTNfY29sdW1uX25hbWVgICAgICAgICB8XG4gICAqIHwgYG9yaWdpbk5hbWVgIHwgdGhlIHJlc3VsdCBvZiBgc3FsaXRlM19jb2x1bW5fb3JpZ2luX25hbWVgIHxcbiAgICogfCBgdGFibGVOYW1lYCAgfCB0aGUgcmVzdWx0IG9mIGBzcWxpdGUzX2NvbHVtbl90YWJsZV9uYW1lYCAgfFxuICAgKi9cbiAgY29sdW1ucygpOiBBcnJheTxDb2x1bW5OYW1lPiB7XG4gICAgaWYgKHRoaXMuX2ZpbmFsaXplZCkge1xuICAgICAgdGhyb3cgbmV3IFNxbGl0ZUVycm9yKFxuICAgICAgICBcIlVuYWJsZSB0byByZXRyaWV2ZSBjb2x1bW4gbmFtZXMgZnJvbSBmaW5hbGl6ZWQgdHJhbnNhY3Rpb24uXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbHVtbkNvdW50ID0gdGhpcy5fd2FzbS5jb2x1bW5fY291bnQodGhpcy5fc3RtdCk7XG4gICAgY29uc3QgY29sdW1uczogQXJyYXk8Q29sdW1uTmFtZT4gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbHVtbkNvdW50OyBpKyspIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBnZXRTdHIoXG4gICAgICAgIHRoaXMuX3dhc20sXG4gICAgICAgIHRoaXMuX3dhc20uY29sdW1uX25hbWUodGhpcy5fc3RtdCwgaSksXG4gICAgICApO1xuICAgICAgY29uc3Qgb3JpZ2luTmFtZSA9IGdldFN0cihcbiAgICAgICAgdGhpcy5fd2FzbSxcbiAgICAgICAgdGhpcy5fd2FzbS5jb2x1bW5fb3JpZ2luX25hbWUodGhpcy5fc3RtdCwgaSksXG4gICAgICApO1xuICAgICAgY29uc3QgdGFibGVOYW1lID0gZ2V0U3RyKFxuICAgICAgICB0aGlzLl93YXNtLFxuICAgICAgICB0aGlzLl93YXNtLmNvbHVtbl90YWJsZV9uYW1lKHRoaXMuX3N0bXQsIGkpLFxuICAgICAgKTtcbiAgICAgIGNvbHVtbnMucHVzaCh7IG5hbWUsIG9yaWdpbk5hbWUsIHRhYmxlTmFtZSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbHVtbnM7XG4gIH1cbn1cbiJdfQ==