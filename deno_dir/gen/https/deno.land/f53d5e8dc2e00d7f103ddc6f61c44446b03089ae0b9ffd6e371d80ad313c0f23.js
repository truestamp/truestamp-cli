import { getDescription } from "../_utils.ts";
import { FileType } from "../types/file.ts";
/** Generates zsh completions script. */ export class ZshCompletionsGenerator {
    actions;
    /** Generates zsh completions script for given command. */ static generate(cmd) {
        return new ZshCompletionsGenerator(cmd).generate();
    }
    constructor(cmd){
        this.cmd = cmd;
        this.actions = new Map();
    }
    /** Generates zsh completions code. */ generate() {
        const path = this.cmd.getPath();
        const name = this.cmd.getName();
        const version = this.cmd.getVersion() ? ` v${this.cmd.getVersion()}` : "";
        return `#!/usr/bin/env zsh
# zsh completion support for ${path}${version}

autoload -U is-at-least

# shellcheck disable=SC2154
(( $+functions[__${replaceSpecialChars(name)}_complete] )) ||
function __${replaceSpecialChars(name)}_complete {
  local name="$1"; shift
  local action="$1"; shift
  integer ret=1
  local -a values
  local expl lines
  _tags "$name"
  while _tags; do
    if _requested "$name"; then
      # shellcheck disable=SC2034
      lines="$(${name} completions complete "\${action}" "\${@}")"
      values=("\${(ps:\\n:)lines}")
      if (( \${#values[@]} )); then
        while _next_label "$name" expl "$action"; do
          compadd -S '' "\${expl[@]}" "\${values[@]}"
        done
      fi
    fi
  done
}

${this.generateCompletions(this.cmd).trim()}

# _${replaceSpecialChars(path)} "\${@}"

compdef _${replaceSpecialChars(path)} ${path}`;
    }
    /** Generates zsh completions method for given command and child commands. */ generateCompletions(command, path = "") {
        if (!command.hasCommands(false) && !command.hasOptions(false) && !command.hasArguments()) {
            return "";
        }
        path = (path ? path + " " : "") + command.getName();
        return `# shellcheck disable=SC2154
(( $+functions[_${replaceSpecialChars(path)}] )) ||
function _${replaceSpecialChars(path)}() {` + (!command.getParent() ? `
  local state` : "") + this.generateCommandCompletions(command, path) + this.generateSubCommandCompletions(command, path) + this.generateArgumentCompletions(command, path) + this.generateActions(command) + `\n}\n\n` + command.getCommands(false).filter((subCommand)=>subCommand !== command).map((subCommand)=>this.generateCompletions(subCommand, path)).join("");
    }
    generateCommandCompletions(command, path) {
        const commands = command.getCommands(false);
        let completions = commands.map((subCommand)=>`'${subCommand.getName()}:${subCommand.getShortDescription()}'`).join("\n      ");
        if (completions) {
            completions = `
    local -a commands
    # shellcheck disable=SC2034
    commands=(
      ${completions}
    )
    _describe 'command' commands`;
        }
        // only complete first argument, rest arguments are completed with _arguments.
        if (command.hasArguments()) {
            const completionsPath = path.split(" ").slice(1).join(" ");
            const arg = command.getArguments()[0];
            const action = this.addAction(arg, completionsPath);
            if (action && command.getCompletion(arg.action)) {
                completions += `\n    __${replaceSpecialChars(this.cmd.getName())}_complete ${action.arg.name} ${action.arg.action} ${action.cmd}`;
            }
        }
        if (completions) {
            completions = `\n\n  function _commands() {${completions}\n  }`;
        }
        return completions;
    }
    generateSubCommandCompletions(command1, path) {
        if (command1.hasCommands(false)) {
            const actions = command1.getCommands(false).map((command)=>`${command.getName()}) _${replaceSpecialChars(path + " " + command.getName())} ;;`).join("\n      ");
            return `\n
  function _command_args() {
    case "\${words[1]}" in\n      ${actions}\n    esac
  }`;
        }
        return "";
    }
    generateArgumentCompletions(command, path) {
        /* clear actions from previously parsed command. */ this.actions.clear();
        const options = this.generateOptions(command, path);
        let argIndex = 0;
        // @TODO: add stop early option: -A "-*"
        // http://zsh.sourceforge.net/Doc/Release/Completion-System.html
        let argsCommand = "\n\n  _arguments -w -s -S -C";
        if (command.hasOptions()) {
            argsCommand += ` \\\n    ${options.join(" \\\n    ")}`;
        }
        if (command.hasCommands(false) || command.getArguments().filter((arg)=>command.getCompletion(arg.action)).length) {
            argsCommand += ` \\\n    '${++argIndex}:command:_commands'`;
        }
        if (command.hasArguments() || command.hasCommands(false)) {
            const args = [];
            // first argument is completed together with commands.
            for (const arg1 of command.getArguments().slice(1)){
                const type = command.getType(arg1.type);
                if (type && type.handler instanceof FileType) {
                    const fileCompletions = this.getFileCompletions(type);
                    if (arg1.variadic) {
                        argIndex++;
                        for(let i = 0; i < 5; i++){
                            args.push(`${argIndex + i}${arg1.optionalValue ? "::" : ":"}${arg1.name}:${fileCompletions}`);
                        }
                    } else {
                        args.push(`${++argIndex}${arg1.optionalValue ? "::" : ":"}${arg1.name}:${fileCompletions}`);
                    }
                } else {
                    const completionsPath = path.split(" ").slice(1).join(" ");
                    const action = this.addAction(arg1, completionsPath);
                    args.push(`${++argIndex}${arg1.optionalValue ? "::" : ":"}${arg1.name}:->${action.name}`);
                }
            }
            argsCommand += args.map((arg)=>`\\\n    '${arg}'`).join("");
            if (command.hasCommands(false)) {
                argsCommand += ` \\\n    '*::sub command:->command_args'`;
            }
        }
        return argsCommand;
    }
    generateOptions(command, path) {
        const options = [];
        const cmdArgs = path.split(" ");
        const _baseName = cmdArgs.shift();
        const completionsPath = cmdArgs.join(" ");
        const excludedFlags = command.getOptions(false).map((option)=>option.standalone ? option.flags : false).flat().filter((flag)=>typeof flag === "string");
        for (const option1 of command.getOptions(false)){
            options.push(this.generateOption(command, option1, completionsPath, excludedFlags));
        }
        return options;
    }
    generateOption(command, option, completionsPath, excludedOptions) {
        let excludedFlags = option.conflicts?.length ? [
            ...excludedOptions,
            ...option.conflicts.map((opt)=>"--" + opt.replace(/^--/, "")), 
        ] : excludedOptions;
        excludedFlags = option.collect ? excludedFlags : [
            ...excludedFlags,
            ...option.flags, 
        ];
        let args = "";
        for (const arg of option.args){
            const type = command.getType(arg.type);
            if (type && type.handler instanceof FileType) {
                const fileCompletions = this.getFileCompletions(type);
                args += `${arg.optionalValue ? "::" : ":"}${arg.name}:${fileCompletions}`;
            } else {
                const action = this.addAction(arg, completionsPath);
                args += `${arg.optionalValue ? "::" : ":"}${arg.name}:->${action.name}`;
            }
        }
        const description = getDescription(option.description, true)// escape brackets and quotes
        .replace(/\[/g, "\\[").replace(/]/g, "\\]").replace(/"/g, '\\"').replace(/'/g, "'\"'\"'");
        const collect = option.collect ? "*" : "";
        const equalsSign = option.equalsSign ? "=" : "";
        const flags = option.flags.map((flag)=>`${flag}${equalsSign}`).join(",");
        if (option.standalone) {
            return `'(- *)'{${collect}${flags}}'[${description}]${args}'`;
        } else {
            const excluded = excludedFlags.length ? `'(${excludedFlags.join(" ")})'` : "";
            if (collect || flags.length > 1) {
                return `${excluded}{${collect}${flags}}'[${description}]${args}'`;
            } else {
                return `${excluded}${flags}'[${description}]${args}'`;
            }
        }
    }
    getFileCompletions(type) {
        if (!(type.handler instanceof FileType)) {
            return "";
        }
        return "_files";
    // const fileOpts = type.handler.getOptions();
    // let fileCompletions = "_files";
    // if (fileOpts.dirsOnly) {
    //   fileCompletions += " -/";
    // }
    // if (fileOpts.pattern) {
    //   fileCompletions += ' -g "' + fileOpts.pattern + '"';
    // }
    // if (fileOpts.ignore) {
    //   fileCompletions += " -F " + fileOpts.ignore;
    // }
    // return fileCompletions;
    }
    addAction(arg, cmd) {
        const action = `${arg.name}-${arg.action}`;
        if (!this.actions.has(action)) {
            this.actions.set(action, {
                arg: arg,
                label: `${arg.name}: ${arg.action}`,
                name: action,
                cmd
            });
        }
        return this.actions.get(action);
    }
    generateActions(command) {
        let actions = [];
        if (this.actions.size) {
            actions = Array.from(this.actions).map(([name, action])=>`${name}) __${replaceSpecialChars(this.cmd.getName())}_complete ${action.arg.name} ${action.arg.action} ${action.cmd} ;;`);
        }
        if (command.hasCommands(false)) {
            actions.unshift(`command_args) _command_args ;;`);
        }
        if (actions.length) {
            return `\n\n  case "$state" in\n    ${actions.join("\n    ")}\n  esac`;
        }
        return "";
    }
    cmd;
}
function replaceSpecialChars(str) {
    return str.replace(/[^a-zA-Z0-9]/g, "_");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvY2xpZmZ5QHYwLjI0LjIvY29tbWFuZC9jb21wbGV0aW9ucy9fenNoX2NvbXBsZXRpb25zX2dlbmVyYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXREZXNjcmlwdGlvbiB9IGZyb20gXCIuLi9fdXRpbHMudHNcIjtcbmltcG9ydCB0eXBlIHsgQ29tbWFuZCB9IGZyb20gXCIuLi9jb21tYW5kLnRzXCI7XG5pbXBvcnQgdHlwZSB7IElBcmd1bWVudCwgSU9wdGlvbiwgSVR5cGUgfSBmcm9tIFwiLi4vdHlwZXMudHNcIjtcbmltcG9ydCB7IEZpbGVUeXBlIH0gZnJvbSBcIi4uL3R5cGVzL2ZpbGUudHNcIjtcblxuaW50ZXJmYWNlIElDb21wbGV0aW9uQWN0aW9uIHtcbiAgYXJnOiBJQXJndW1lbnQ7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgY21kOiBzdHJpbmc7XG59XG5cbi8qKiBHZW5lcmF0ZXMgenNoIGNvbXBsZXRpb25zIHNjcmlwdC4gKi9cbmV4cG9ydCBjbGFzcyBac2hDb21wbGV0aW9uc0dlbmVyYXRvciB7XG4gIHByaXZhdGUgYWN0aW9uczogTWFwPHN0cmluZywgSUNvbXBsZXRpb25BY3Rpb24+ID0gbmV3IE1hcCgpO1xuXG4gIC8qKiBHZW5lcmF0ZXMgenNoIGNvbXBsZXRpb25zIHNjcmlwdCBmb3IgZ2l2ZW4gY29tbWFuZC4gKi9cbiAgcHVibGljIHN0YXRpYyBnZW5lcmF0ZShjbWQ6IENvbW1hbmQpIHtcbiAgICByZXR1cm4gbmV3IFpzaENvbXBsZXRpb25zR2VuZXJhdG9yKGNtZCkuZ2VuZXJhdGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgY29uc3RydWN0b3IocHJvdGVjdGVkIGNtZDogQ29tbWFuZCkge31cblxuICAvKiogR2VuZXJhdGVzIHpzaCBjb21wbGV0aW9ucyBjb2RlLiAqL1xuICBwcml2YXRlIGdlbmVyYXRlKCk6IHN0cmluZyB7XG4gICAgY29uc3QgcGF0aCA9IHRoaXMuY21kLmdldFBhdGgoKTtcbiAgICBjb25zdCBuYW1lID0gdGhpcy5jbWQuZ2V0TmFtZSgpO1xuICAgIGNvbnN0IHZlcnNpb246IHN0cmluZyB8IHVuZGVmaW5lZCA9IHRoaXMuY21kLmdldFZlcnNpb24oKVxuICAgICAgPyBgIHYke3RoaXMuY21kLmdldFZlcnNpb24oKX1gXG4gICAgICA6IFwiXCI7XG5cbiAgICByZXR1cm4gYCMhL3Vzci9iaW4vZW52IHpzaFxuIyB6c2ggY29tcGxldGlvbiBzdXBwb3J0IGZvciAke3BhdGh9JHt2ZXJzaW9ufVxuXG5hdXRvbG9hZCAtVSBpcy1hdC1sZWFzdFxuXG4jIHNoZWxsY2hlY2sgZGlzYWJsZT1TQzIxNTRcbigoICQrZnVuY3Rpb25zW19fJHtyZXBsYWNlU3BlY2lhbENoYXJzKG5hbWUpfV9jb21wbGV0ZV0gKSkgfHxcbmZ1bmN0aW9uIF9fJHtyZXBsYWNlU3BlY2lhbENoYXJzKG5hbWUpfV9jb21wbGV0ZSB7XG4gIGxvY2FsIG5hbWU9XCIkMVwiOyBzaGlmdFxuICBsb2NhbCBhY3Rpb249XCIkMVwiOyBzaGlmdFxuICBpbnRlZ2VyIHJldD0xXG4gIGxvY2FsIC1hIHZhbHVlc1xuICBsb2NhbCBleHBsIGxpbmVzXG4gIF90YWdzIFwiJG5hbWVcIlxuICB3aGlsZSBfdGFnczsgZG9cbiAgICBpZiBfcmVxdWVzdGVkIFwiJG5hbWVcIjsgdGhlblxuICAgICAgIyBzaGVsbGNoZWNrIGRpc2FibGU9U0MyMDM0XG4gICAgICBsaW5lcz1cIiQoJHtuYW1lfSBjb21wbGV0aW9ucyBjb21wbGV0ZSBcIlxcJHthY3Rpb259XCIgXCJcXCR7QH1cIilcIlxuICAgICAgdmFsdWVzPShcIlxcJHsocHM6XFxcXG46KWxpbmVzfVwiKVxuICAgICAgaWYgKCggXFwkeyN2YWx1ZXNbQF19ICkpOyB0aGVuXG4gICAgICAgIHdoaWxlIF9uZXh0X2xhYmVsIFwiJG5hbWVcIiBleHBsIFwiJGFjdGlvblwiOyBkb1xuICAgICAgICAgIGNvbXBhZGQgLVMgJycgXCJcXCR7ZXhwbFtAXX1cIiBcIlxcJHt2YWx1ZXNbQF19XCJcbiAgICAgICAgZG9uZVxuICAgICAgZmlcbiAgICBmaVxuICBkb25lXG59XG5cbiR7dGhpcy5nZW5lcmF0ZUNvbXBsZXRpb25zKHRoaXMuY21kKS50cmltKCl9XG5cbiMgXyR7cmVwbGFjZVNwZWNpYWxDaGFycyhwYXRoKX0gXCJcXCR7QH1cIlxuXG5jb21wZGVmIF8ke3JlcGxhY2VTcGVjaWFsQ2hhcnMocGF0aCl9ICR7cGF0aH1gO1xuICB9XG5cbiAgLyoqIEdlbmVyYXRlcyB6c2ggY29tcGxldGlvbnMgbWV0aG9kIGZvciBnaXZlbiBjb21tYW5kIGFuZCBjaGlsZCBjb21tYW5kcy4gKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZUNvbXBsZXRpb25zKGNvbW1hbmQ6IENvbW1hbmQsIHBhdGggPSBcIlwiKTogc3RyaW5nIHtcbiAgICBpZiAoXG4gICAgICAhY29tbWFuZC5oYXNDb21tYW5kcyhmYWxzZSkgJiYgIWNvbW1hbmQuaGFzT3B0aW9ucyhmYWxzZSkgJiZcbiAgICAgICFjb21tYW5kLmhhc0FyZ3VtZW50cygpXG4gICAgKSB7XG4gICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG5cbiAgICBwYXRoID0gKHBhdGggPyBwYXRoICsgXCIgXCIgOiBcIlwiKSArIGNvbW1hbmQuZ2V0TmFtZSgpO1xuXG4gICAgcmV0dXJuIGAjIHNoZWxsY2hlY2sgZGlzYWJsZT1TQzIxNTRcbigoICQrZnVuY3Rpb25zW18ke3JlcGxhY2VTcGVjaWFsQ2hhcnMocGF0aCl9XSApKSB8fFxuZnVuY3Rpb24gXyR7cmVwbGFjZVNwZWNpYWxDaGFycyhwYXRoKX0oKSB7YCArXG4gICAgICAoIWNvbW1hbmQuZ2V0UGFyZW50KClcbiAgICAgICAgPyBgXG4gIGxvY2FsIHN0YXRlYFxuICAgICAgICA6IFwiXCIpICtcbiAgICAgIHRoaXMuZ2VuZXJhdGVDb21tYW5kQ29tcGxldGlvbnMoY29tbWFuZCwgcGF0aCkgK1xuICAgICAgdGhpcy5nZW5lcmF0ZVN1YkNvbW1hbmRDb21wbGV0aW9ucyhjb21tYW5kLCBwYXRoKSArXG4gICAgICB0aGlzLmdlbmVyYXRlQXJndW1lbnRDb21wbGV0aW9ucyhjb21tYW5kLCBwYXRoKSArXG4gICAgICB0aGlzLmdlbmVyYXRlQWN0aW9ucyhjb21tYW5kKSArXG4gICAgICBgXFxufVxcblxcbmAgK1xuICAgICAgY29tbWFuZC5nZXRDb21tYW5kcyhmYWxzZSlcbiAgICAgICAgLmZpbHRlcigoc3ViQ29tbWFuZDogQ29tbWFuZCkgPT4gc3ViQ29tbWFuZCAhPT0gY29tbWFuZClcbiAgICAgICAgLm1hcCgoc3ViQ29tbWFuZDogQ29tbWFuZCkgPT5cbiAgICAgICAgICB0aGlzLmdlbmVyYXRlQ29tcGxldGlvbnMoc3ViQ29tbWFuZCwgcGF0aClcbiAgICAgICAgKVxuICAgICAgICAuam9pbihcIlwiKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVDb21tYW5kQ29tcGxldGlvbnMoY29tbWFuZDogQ29tbWFuZCwgcGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBjb21tYW5kcyA9IGNvbW1hbmQuZ2V0Q29tbWFuZHMoZmFsc2UpO1xuXG4gICAgbGV0IGNvbXBsZXRpb25zOiBzdHJpbmcgPSBjb21tYW5kc1xuICAgICAgLm1hcCgoc3ViQ29tbWFuZDogQ29tbWFuZCkgPT5cbiAgICAgICAgYCcke3N1YkNvbW1hbmQuZ2V0TmFtZSgpfToke3N1YkNvbW1hbmQuZ2V0U2hvcnREZXNjcmlwdGlvbigpfSdgXG4gICAgICApXG4gICAgICAuam9pbihcIlxcbiAgICAgIFwiKTtcblxuICAgIGlmIChjb21wbGV0aW9ucykge1xuICAgICAgY29tcGxldGlvbnMgPSBgXG4gICAgbG9jYWwgLWEgY29tbWFuZHNcbiAgICAjIHNoZWxsY2hlY2sgZGlzYWJsZT1TQzIwMzRcbiAgICBjb21tYW5kcz0oXG4gICAgICAke2NvbXBsZXRpb25zfVxuICAgIClcbiAgICBfZGVzY3JpYmUgJ2NvbW1hbmQnIGNvbW1hbmRzYDtcbiAgICB9XG5cbiAgICAvLyBvbmx5IGNvbXBsZXRlIGZpcnN0IGFyZ3VtZW50LCByZXN0IGFyZ3VtZW50cyBhcmUgY29tcGxldGVkIHdpdGggX2FyZ3VtZW50cy5cbiAgICBpZiAoY29tbWFuZC5oYXNBcmd1bWVudHMoKSkge1xuICAgICAgY29uc3QgY29tcGxldGlvbnNQYXRoOiBzdHJpbmcgPSBwYXRoLnNwbGl0KFwiIFwiKS5zbGljZSgxKS5qb2luKFwiIFwiKTtcbiAgICAgIGNvbnN0IGFyZzogSUFyZ3VtZW50ID0gY29tbWFuZC5nZXRBcmd1bWVudHMoKVswXTtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuYWRkQWN0aW9uKGFyZywgY29tcGxldGlvbnNQYXRoKTtcbiAgICAgIGlmIChhY3Rpb24gJiYgY29tbWFuZC5nZXRDb21wbGV0aW9uKGFyZy5hY3Rpb24pKSB7XG4gICAgICAgIGNvbXBsZXRpb25zICs9IGBcXG4gICAgX18ke1xuICAgICAgICAgIHJlcGxhY2VTcGVjaWFsQ2hhcnModGhpcy5jbWQuZ2V0TmFtZSgpKVxuICAgICAgICB9X2NvbXBsZXRlICR7YWN0aW9uLmFyZy5uYW1lfSAke2FjdGlvbi5hcmcuYWN0aW9ufSAke2FjdGlvbi5jbWR9YDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY29tcGxldGlvbnMpIHtcbiAgICAgIGNvbXBsZXRpb25zID0gYFxcblxcbiAgZnVuY3Rpb24gX2NvbW1hbmRzKCkgeyR7Y29tcGxldGlvbnN9XFxuICB9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tcGxldGlvbnM7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlU3ViQ29tbWFuZENvbXBsZXRpb25zKFxuICAgIGNvbW1hbmQ6IENvbW1hbmQsXG4gICAgcGF0aDogc3RyaW5nLFxuICApOiBzdHJpbmcge1xuICAgIGlmIChjb21tYW5kLmhhc0NvbW1hbmRzKGZhbHNlKSkge1xuICAgICAgY29uc3QgYWN0aW9uczogc3RyaW5nID0gY29tbWFuZFxuICAgICAgICAuZ2V0Q29tbWFuZHMoZmFsc2UpXG4gICAgICAgIC5tYXAoKGNvbW1hbmQ6IENvbW1hbmQpID0+XG4gICAgICAgICAgYCR7Y29tbWFuZC5nZXROYW1lKCl9KSBfJHtcbiAgICAgICAgICAgIHJlcGxhY2VTcGVjaWFsQ2hhcnMocGF0aCArIFwiIFwiICsgY29tbWFuZC5nZXROYW1lKCkpXG4gICAgICAgICAgfSA7O2BcbiAgICAgICAgKVxuICAgICAgICAuam9pbihcIlxcbiAgICAgIFwiKTtcblxuICAgICAgcmV0dXJuIGBcXG5cbiAgZnVuY3Rpb24gX2NvbW1hbmRfYXJncygpIHtcbiAgICBjYXNlIFwiXFwke3dvcmRzWzFdfVwiIGluXFxuICAgICAgJHthY3Rpb25zfVxcbiAgICBlc2FjXG4gIH1gO1xuICAgIH1cblxuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZUFyZ3VtZW50Q29tcGxldGlvbnMoY29tbWFuZDogQ29tbWFuZCwgcGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvKiBjbGVhciBhY3Rpb25zIGZyb20gcHJldmlvdXNseSBwYXJzZWQgY29tbWFuZC4gKi9cbiAgICB0aGlzLmFjdGlvbnMuY2xlYXIoKTtcblxuICAgIGNvbnN0IG9wdGlvbnM6IHN0cmluZ1tdID0gdGhpcy5nZW5lcmF0ZU9wdGlvbnMoY29tbWFuZCwgcGF0aCk7XG5cbiAgICBsZXQgYXJnSW5kZXggPSAwO1xuICAgIC8vIEBUT0RPOiBhZGQgc3RvcCBlYXJseSBvcHRpb246IC1BIFwiLSpcIlxuICAgIC8vIGh0dHA6Ly96c2guc291cmNlZm9yZ2UubmV0L0RvYy9SZWxlYXNlL0NvbXBsZXRpb24tU3lzdGVtLmh0bWxcbiAgICBsZXQgYXJnc0NvbW1hbmQgPSBcIlxcblxcbiAgX2FyZ3VtZW50cyAtdyAtcyAtUyAtQ1wiO1xuXG4gICAgaWYgKGNvbW1hbmQuaGFzT3B0aW9ucygpKSB7XG4gICAgICBhcmdzQ29tbWFuZCArPSBgIFxcXFxcXG4gICAgJHtvcHRpb25zLmpvaW4oXCIgXFxcXFxcbiAgICBcIil9YDtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBjb21tYW5kLmhhc0NvbW1hbmRzKGZhbHNlKSB8fCAoXG4gICAgICAgIGNvbW1hbmQuZ2V0QXJndW1lbnRzKClcbiAgICAgICAgICAuZmlsdGVyKChhcmcpID0+IGNvbW1hbmQuZ2V0Q29tcGxldGlvbihhcmcuYWN0aW9uKSkubGVuZ3RoXG4gICAgICApXG4gICAgKSB7XG4gICAgICBhcmdzQ29tbWFuZCArPSBgIFxcXFxcXG4gICAgJyR7KythcmdJbmRleH06Y29tbWFuZDpfY29tbWFuZHMnYDtcbiAgICB9XG5cbiAgICBpZiAoY29tbWFuZC5oYXNBcmd1bWVudHMoKSB8fCBjb21tYW5kLmhhc0NvbW1hbmRzKGZhbHNlKSkge1xuICAgICAgY29uc3QgYXJnczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgLy8gZmlyc3QgYXJndW1lbnQgaXMgY29tcGxldGVkIHRvZ2V0aGVyIHdpdGggY29tbWFuZHMuXG4gICAgICBmb3IgKGNvbnN0IGFyZyBvZiBjb21tYW5kLmdldEFyZ3VtZW50cygpLnNsaWNlKDEpKSB7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBjb21tYW5kLmdldFR5cGUoYXJnLnR5cGUpO1xuICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmhhbmRsZXIgaW5zdGFuY2VvZiBGaWxlVHlwZSkge1xuICAgICAgICAgIGNvbnN0IGZpbGVDb21wbGV0aW9ucyA9IHRoaXMuZ2V0RmlsZUNvbXBsZXRpb25zKHR5cGUpO1xuICAgICAgICAgIGlmIChhcmcudmFyaWFkaWMpIHtcbiAgICAgICAgICAgIGFyZ0luZGV4Kys7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykge1xuICAgICAgICAgICAgICBhcmdzLnB1c2goXG4gICAgICAgICAgICAgICAgYCR7YXJnSW5kZXggKyBpfSR7XG4gICAgICAgICAgICAgICAgICBhcmcub3B0aW9uYWxWYWx1ZSA/IFwiOjpcIiA6IFwiOlwiXG4gICAgICAgICAgICAgICAgfSR7YXJnLm5hbWV9OiR7ZmlsZUNvbXBsZXRpb25zfWAsXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFyZ3MucHVzaChcbiAgICAgICAgICAgICAgYCR7KythcmdJbmRleH0ke1xuICAgICAgICAgICAgICAgIGFyZy5vcHRpb25hbFZhbHVlID8gXCI6OlwiIDogXCI6XCJcbiAgICAgICAgICAgICAgfSR7YXJnLm5hbWV9OiR7ZmlsZUNvbXBsZXRpb25zfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBjb21wbGV0aW9uc1BhdGg6IHN0cmluZyA9IHBhdGguc3BsaXQoXCIgXCIpLnNsaWNlKDEpLmpvaW4oXCIgXCIpO1xuICAgICAgICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuYWRkQWN0aW9uKGFyZywgY29tcGxldGlvbnNQYXRoKTtcbiAgICAgICAgICBhcmdzLnB1c2goXG4gICAgICAgICAgICBgJHsrK2FyZ0luZGV4fSR7XG4gICAgICAgICAgICAgIGFyZy5vcHRpb25hbFZhbHVlID8gXCI6OlwiIDogXCI6XCJcbiAgICAgICAgICAgIH0ke2FyZy5uYW1lfTotPiR7YWN0aW9uLm5hbWV9YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGFyZ3NDb21tYW5kICs9IGFyZ3MubWFwKChhcmc6IHN0cmluZykgPT4gYFxcXFxcXG4gICAgJyR7YXJnfSdgKS5qb2luKFwiXCIpO1xuXG4gICAgICBpZiAoY29tbWFuZC5oYXNDb21tYW5kcyhmYWxzZSkpIHtcbiAgICAgICAgYXJnc0NvbW1hbmQgKz0gYCBcXFxcXFxuICAgICcqOjpzdWIgY29tbWFuZDotPmNvbW1hbmRfYXJncydgO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhcmdzQ29tbWFuZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVPcHRpb25zKGNvbW1hbmQ6IENvbW1hbmQsIHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IG9wdGlvbnM6IHN0cmluZ1tdID0gW107XG4gICAgY29uc3QgY21kQXJnczogc3RyaW5nW10gPSBwYXRoLnNwbGl0KFwiIFwiKTtcbiAgICBjb25zdCBfYmFzZU5hbWU6IHN0cmluZyA9IGNtZEFyZ3Muc2hpZnQoKSBhcyBzdHJpbmc7XG4gICAgY29uc3QgY29tcGxldGlvbnNQYXRoOiBzdHJpbmcgPSBjbWRBcmdzLmpvaW4oXCIgXCIpO1xuXG4gICAgY29uc3QgZXhjbHVkZWRGbGFnczogc3RyaW5nW10gPSBjb21tYW5kLmdldE9wdGlvbnMoZmFsc2UpXG4gICAgICAubWFwKChvcHRpb24pID0+IG9wdGlvbi5zdGFuZGFsb25lID8gb3B0aW9uLmZsYWdzIDogZmFsc2UpXG4gICAgICAuZmxhdCgpXG4gICAgICAuZmlsdGVyKChmbGFnKSA9PiB0eXBlb2YgZmxhZyA9PT0gXCJzdHJpbmdcIikgYXMgc3RyaW5nW107XG5cbiAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiBjb21tYW5kLmdldE9wdGlvbnMoZmFsc2UpKSB7XG4gICAgICBvcHRpb25zLnB1c2goXG4gICAgICAgIHRoaXMuZ2VuZXJhdGVPcHRpb24oY29tbWFuZCwgb3B0aW9uLCBjb21wbGV0aW9uc1BhdGgsIGV4Y2x1ZGVkRmxhZ3MpLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVPcHRpb24oXG4gICAgY29tbWFuZDogQ29tbWFuZCxcbiAgICBvcHRpb246IElPcHRpb24sXG4gICAgY29tcGxldGlvbnNQYXRoOiBzdHJpbmcsXG4gICAgZXhjbHVkZWRPcHRpb25zOiBzdHJpbmdbXSxcbiAgKTogc3RyaW5nIHtcbiAgICBsZXQgZXhjbHVkZWRGbGFncyA9IG9wdGlvbi5jb25mbGljdHM/Lmxlbmd0aFxuICAgICAgPyBbXG4gICAgICAgIC4uLmV4Y2x1ZGVkT3B0aW9ucyxcbiAgICAgICAgLi4ub3B0aW9uLmNvbmZsaWN0cy5tYXAoKG9wdCkgPT4gXCItLVwiICsgb3B0LnJlcGxhY2UoL14tLS8sIFwiXCIpKSxcbiAgICAgIF1cbiAgICAgIDogZXhjbHVkZWRPcHRpb25zO1xuICAgIGV4Y2x1ZGVkRmxhZ3MgPSBvcHRpb24uY29sbGVjdCA/IGV4Y2x1ZGVkRmxhZ3MgOiBbXG4gICAgICAuLi5leGNsdWRlZEZsYWdzLFxuICAgICAgLi4ub3B0aW9uLmZsYWdzLFxuICAgIF07XG5cbiAgICBsZXQgYXJncyA9IFwiXCI7XG4gICAgZm9yIChjb25zdCBhcmcgb2Ygb3B0aW9uLmFyZ3MpIHtcbiAgICAgIGNvbnN0IHR5cGUgPSBjb21tYW5kLmdldFR5cGUoYXJnLnR5cGUpO1xuICAgICAgaWYgKHR5cGUgJiYgdHlwZS5oYW5kbGVyIGluc3RhbmNlb2YgRmlsZVR5cGUpIHtcbiAgICAgICAgY29uc3QgZmlsZUNvbXBsZXRpb25zID0gdGhpcy5nZXRGaWxlQ29tcGxldGlvbnModHlwZSk7XG4gICAgICAgIGFyZ3MgKz0gYCR7XG4gICAgICAgICAgYXJnLm9wdGlvbmFsVmFsdWUgPyBcIjo6XCIgOiBcIjpcIlxuICAgICAgICB9JHthcmcubmFtZX06JHtmaWxlQ29tcGxldGlvbnN9YDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuYWRkQWN0aW9uKGFyZywgY29tcGxldGlvbnNQYXRoKTtcbiAgICAgICAgYXJncyArPSBgJHthcmcub3B0aW9uYWxWYWx1ZSA/IFwiOjpcIiA6IFwiOlwifSR7YXJnLm5hbWV9Oi0+JHthY3Rpb24ubmFtZX1gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRlc2NyaXB0aW9uOiBzdHJpbmcgPSBnZXREZXNjcmlwdGlvbihvcHRpb24uZGVzY3JpcHRpb24sIHRydWUpXG4gICAgICAvLyBlc2NhcGUgYnJhY2tldHMgYW5kIHF1b3Rlc1xuICAgICAgLnJlcGxhY2UoL1xcWy9nLCBcIlxcXFxbXCIpXG4gICAgICAucmVwbGFjZSgvXS9nLCBcIlxcXFxdXCIpXG4gICAgICAucmVwbGFjZSgvXCIvZywgJ1xcXFxcIicpXG4gICAgICAucmVwbGFjZSgvJy9nLCBcIidcXFwiJ1xcXCInXCIpO1xuXG4gICAgY29uc3QgY29sbGVjdDogc3RyaW5nID0gb3B0aW9uLmNvbGxlY3QgPyBcIipcIiA6IFwiXCI7XG4gICAgY29uc3QgZXF1YWxzU2lnbiA9IG9wdGlvbi5lcXVhbHNTaWduID8gXCI9XCIgOiBcIlwiO1xuICAgIGNvbnN0IGZsYWdzID0gb3B0aW9uLmZsYWdzLm1hcCgoZmxhZykgPT4gYCR7ZmxhZ30ke2VxdWFsc1NpZ259YCkuam9pbihcIixcIik7XG5cbiAgICBpZiAob3B0aW9uLnN0YW5kYWxvbmUpIHtcbiAgICAgIHJldHVybiBgJygtICopJ3ske2NvbGxlY3R9JHtmbGFnc319J1ske2Rlc2NyaXB0aW9ufV0ke2FyZ3N9J2A7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGV4Y2x1ZGVkOiBzdHJpbmcgPSBleGNsdWRlZEZsYWdzLmxlbmd0aFxuICAgICAgICA/IGAnKCR7ZXhjbHVkZWRGbGFncy5qb2luKFwiIFwiKX0pJ2BcbiAgICAgICAgOiBcIlwiO1xuICAgICAgaWYgKGNvbGxlY3QgfHwgZmxhZ3MubGVuZ3RoID4gMSkge1xuICAgICAgICByZXR1cm4gYCR7ZXhjbHVkZWR9eyR7Y29sbGVjdH0ke2ZsYWdzfX0nWyR7ZGVzY3JpcHRpb259XSR7YXJnc30nYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBgJHtleGNsdWRlZH0ke2ZsYWdzfSdbJHtkZXNjcmlwdGlvbn1dJHthcmdzfSdgO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RmlsZUNvbXBsZXRpb25zKHR5cGU6IElUeXBlKSB7XG4gICAgaWYgKCEodHlwZS5oYW5kbGVyIGluc3RhbmNlb2YgRmlsZVR5cGUpKSB7XG4gICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgcmV0dXJuIFwiX2ZpbGVzXCI7XG4gICAgLy8gY29uc3QgZmlsZU9wdHMgPSB0eXBlLmhhbmRsZXIuZ2V0T3B0aW9ucygpO1xuICAgIC8vIGxldCBmaWxlQ29tcGxldGlvbnMgPSBcIl9maWxlc1wiO1xuICAgIC8vIGlmIChmaWxlT3B0cy5kaXJzT25seSkge1xuICAgIC8vICAgZmlsZUNvbXBsZXRpb25zICs9IFwiIC0vXCI7XG4gICAgLy8gfVxuICAgIC8vIGlmIChmaWxlT3B0cy5wYXR0ZXJuKSB7XG4gICAgLy8gICBmaWxlQ29tcGxldGlvbnMgKz0gJyAtZyBcIicgKyBmaWxlT3B0cy5wYXR0ZXJuICsgJ1wiJztcbiAgICAvLyB9XG4gICAgLy8gaWYgKGZpbGVPcHRzLmlnbm9yZSkge1xuICAgIC8vICAgZmlsZUNvbXBsZXRpb25zICs9IFwiIC1GIFwiICsgZmlsZU9wdHMuaWdub3JlO1xuICAgIC8vIH1cbiAgICAvLyByZXR1cm4gZmlsZUNvbXBsZXRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRBY3Rpb24oYXJnOiBJQXJndW1lbnQsIGNtZDogc3RyaW5nKTogSUNvbXBsZXRpb25BY3Rpb24ge1xuICAgIGNvbnN0IGFjdGlvbiA9IGAke2FyZy5uYW1lfS0ke2FyZy5hY3Rpb259YDtcblxuICAgIGlmICghdGhpcy5hY3Rpb25zLmhhcyhhY3Rpb24pKSB7XG4gICAgICB0aGlzLmFjdGlvbnMuc2V0KGFjdGlvbiwge1xuICAgICAgICBhcmc6IGFyZyxcbiAgICAgICAgbGFiZWw6IGAke2FyZy5uYW1lfTogJHthcmcuYWN0aW9ufWAsXG4gICAgICAgIG5hbWU6IGFjdGlvbixcbiAgICAgICAgY21kLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYWN0aW9ucy5nZXQoYWN0aW9uKSBhcyBJQ29tcGxldGlvbkFjdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVBY3Rpb25zKGNvbW1hbmQ6IENvbW1hbmQpOiBzdHJpbmcge1xuICAgIGxldCBhY3Rpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgaWYgKHRoaXMuYWN0aW9ucy5zaXplKSB7XG4gICAgICBhY3Rpb25zID0gQXJyYXlcbiAgICAgICAgLmZyb20odGhpcy5hY3Rpb25zKVxuICAgICAgICAubWFwKChbbmFtZSwgYWN0aW9uXSkgPT5cbiAgICAgICAgICBgJHtuYW1lfSkgX18ke1xuICAgICAgICAgICAgcmVwbGFjZVNwZWNpYWxDaGFycyh0aGlzLmNtZC5nZXROYW1lKCkpXG4gICAgICAgICAgfV9jb21wbGV0ZSAke2FjdGlvbi5hcmcubmFtZX0gJHthY3Rpb24uYXJnLmFjdGlvbn0gJHthY3Rpb24uY21kfSA7O2BcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoY29tbWFuZC5oYXNDb21tYW5kcyhmYWxzZSkpIHtcbiAgICAgIGFjdGlvbnMudW5zaGlmdChgY29tbWFuZF9hcmdzKSBfY29tbWFuZF9hcmdzIDs7YCk7XG4gICAgfVxuXG4gICAgaWYgKGFjdGlvbnMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gYFxcblxcbiAgY2FzZSBcIiRzdGF0ZVwiIGluXFxuICAgICR7YWN0aW9ucy5qb2luKFwiXFxuICAgIFwiKX1cXG4gIGVzYWNgO1xuICAgIH1cblxuICAgIHJldHVybiBcIlwiO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VTcGVjaWFsQ2hhcnMoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCBcIl9cIik7XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUyxjQUFjLFFBQVEsY0FBYyxDQUFDO0FBRzlDLFNBQVMsUUFBUSxRQUFRLGtCQUFrQixDQUFDO0FBUzVDLHdDQUF3QyxDQUN4QyxPQUFPLE1BQU0sdUJBQXVCO0lBQ2xDLEFBQVEsT0FBTyxDQUE2QztJQUU1RCwwREFBMEQsQ0FDMUQsT0FBYyxRQUFRLENBQUMsR0FBWSxFQUFFO1FBQ25DLE9BQU8sSUFBSSx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztLQUNwRDtJQUVELFlBQThCLEdBQVksQ0FBRTthQUFkLEdBQVksR0FBWixH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