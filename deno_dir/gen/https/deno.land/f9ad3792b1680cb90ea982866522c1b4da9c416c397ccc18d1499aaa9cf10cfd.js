import { getDefaultValue, getOption, paramCaseToCamelCase } from "./_utils.ts";
import { ConflictingOption, DependingOption, MissingOptionValue, MissingRequiredOption, NoArguments, OptionNotCombinable, UnknownOption, } from "./_errors.ts";
export function validateFlags(flags, values, _knownFlaks, allowEmpty, optionNames = {}) {
    const defaultValues = {};
    for (const option of flags) {
        let name;
        let defaultValue = undefined;
        if (option.name.startsWith("no-")) {
            const propName = option.name.replace(/^no-/, "");
            if (propName in values) {
                continue;
            }
            const positiveOption = getOption(flags, propName);
            if (positiveOption) {
                continue;
            }
            name = paramCaseToCamelCase(propName);
            defaultValue = true;
        }
        if (!name) {
            name = paramCaseToCamelCase(option.name);
        }
        if (!(name in optionNames)) {
            optionNames[name] = option.name;
        }
        const hasDefaultValue = typeof values[name] === "undefined" && (typeof option.default !== "undefined" ||
            typeof defaultValue !== "undefined");
        if (hasDefaultValue) {
            values[name] = getDefaultValue(option) ?? defaultValue;
            defaultValues[option.name] = true;
            if (typeof option.value === "function") {
                values[name] = option.value(values[name]);
            }
        }
    }
    const keys = Object.keys(values);
    if (keys.length === 0 && allowEmpty) {
        return;
    }
    const options = keys.map((name) => ({
        name,
        option: getOption(flags, optionNames[name]),
    }));
    for (const { name, option } of options) {
        if (!option) {
            throw new UnknownOption(name, flags);
        }
        if (option.standalone) {
            if (keys.length > 1) {
                if (options.every(({ option: opt }) => opt &&
                    (option === opt || defaultValues[opt.name]))) {
                    return;
                }
                throw new OptionNotCombinable(option.name);
            }
            return;
        }
        option.conflicts?.forEach((flag) => {
            if (isset(flag, values)) {
                throw new ConflictingOption(option.name, flag);
            }
        });
        option.depends?.forEach((flag) => {
            if (!isset(flag, values) && !defaultValues[option.name]) {
                throw new DependingOption(option.name, flag);
            }
        });
        const isArray = (option.args?.length || 0) > 1;
        option.args?.forEach((arg, i) => {
            if (arg.requiredValue &&
                (typeof values[name] === "undefined" ||
                    (isArray &&
                        typeof values[name][i] === "undefined"))) {
                throw new MissingOptionValue(option.name);
            }
        });
    }
    for (const option of flags) {
        if (option.required && !(paramCaseToCamelCase(option.name) in values)) {
            if ((!option.conflicts ||
                !option.conflicts.find((flag) => !!values[flag])) &&
                !options.find((opt) => opt.option?.conflicts?.find((flag) => flag === option.name))) {
                throw new MissingRequiredOption(option.name);
            }
        }
    }
    if (keys.length === 0 && !allowEmpty) {
        throw new NoArguments();
    }
}
function isset(flag, values) {
    const name = paramCaseToCamelCase(flag);
    return typeof values[name] !== "undefined";
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGVfZmxhZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2YWxpZGF0ZV9mbGFncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvRSxPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLGVBQWUsRUFDZixrQkFBa0IsRUFDbEIscUJBQXFCLEVBQ3JCLFdBQVcsRUFDWCxtQkFBbUIsRUFDbkIsYUFBYSxHQUNkLE1BQU0sY0FBYyxDQUFDO0FBb0J0QixNQUFNLFVBQVUsYUFBYSxDQUMzQixLQUFxQixFQUNyQixNQUErQixFQUMvQixXQUFxQyxFQUNyQyxVQUFvQixFQUNwQixjQUFzQyxFQUFFO0lBRXhDLE1BQU0sYUFBYSxHQUE0QixFQUFFLENBQUM7SUFHbEQsS0FBSyxNQUFNLE1BQU0sSUFBSSxLQUFLLEVBQUU7UUFDMUIsSUFBSSxJQUF3QixDQUFDO1FBQzdCLElBQUksWUFBWSxHQUFZLFNBQVMsQ0FBQztRQUd0QyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ2pDLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNqRCxJQUFJLFFBQVEsSUFBSSxNQUFNLEVBQUU7Z0JBQ3RCLFNBQVM7YUFDVjtZQUNELE1BQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDbEQsSUFBSSxjQUFjLEVBQUU7Z0JBQ2xCLFNBQVM7YUFDVjtZQUNELElBQUksR0FBRyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN0QyxZQUFZLEdBQUcsSUFBSSxDQUFDO1NBQ3JCO1FBRUQsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULElBQUksR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLENB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QUNILENBQUM7QUFPRCxTQUFTLEtBQUssQ0FBQyxJQUFZLEVBQUUsTUFBK0I7SUFDMUQsTUFBTSxJQUFJLEdBQUcsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFeEMsT0FBTyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxXQUFXLENBQUM7QUFDN0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldERlZmF1bHRWYWx1ZSwgZ2V0T3B0aW9uLCBwYXJhbUNhc2VUb0NhbWVsQ2FzZSB9IGZyb20gXCIuL191dGlscy50c1wiO1xuaW1wb3J0IHtcbiAgQ29uZmxpY3RpbmdPcHRpb24sXG4gIERlcGVuZGluZ09wdGlvbixcbiAgTWlzc2luZ09wdGlvblZhbHVlLFxuICBNaXNzaW5nUmVxdWlyZWRPcHRpb24sXG4gIE5vQXJndW1lbnRzLFxuICBPcHRpb25Ob3RDb21iaW5hYmxlLFxuICBVbmtub3duT3B0aW9uLFxufSBmcm9tIFwiLi9fZXJyb3JzLnRzXCI7XG5pbXBvcnQgdHlwZSB7IElGbGFnQXJndW1lbnQsIElGbGFnT3B0aW9ucyB9IGZyb20gXCIuL3R5cGVzLnRzXCI7XG5cbi8vIEBUT0RPOiBhZGQgc3VwcG9ydCBmb3Iga25vd25GbGFrc1xuXG4vKiogRmxhZyBvcHRpb24gbWFwLiAqL1xuaW50ZXJmYWNlIElGbGFnT3B0aW9uc01hcCB7XG4gIG5hbWU6IHN0cmluZztcbiAgb3B0aW9uPzogSUZsYWdPcHRpb25zO1xufVxuXG4vKipcbiAqIEZsYWdzIHBvc3QgdmFsaWRhdGlvbi4gVmFsaWRhdGlvbnMgdGhhdCBhcmUgbm90IGFscmVhZHkgZG9uZSBieSB0aGUgcGFyc2VyLlxuICpcbiAqIEBwYXJhbSBmbGFncyAgICAgICAgIEF2YWlsYWJsZSBmbGFnIG9wdGlvbnMuXG4gKiBAcGFyYW0gdmFsdWVzICAgICAgICBGbGFnIHRvIHZhbGlkYXRlLlxuICogQHBhcmFtIF9rbm93bkZsYWtzICAgIERvbid0IHRocm93IGFuIGVycm9yIGlmIGEgbWlzc2luZyBmbGFnIGlzIGRlZmluZWQgaW4ga25vd25GbGFncyAoY3VycmVudGx5IG5vdCBpbXBsZW1lbnRlZCkuXG4gKiBAcGFyYW0gYWxsb3dFbXB0eSAgICBEb24ndCB0aHJvdyBhbiBlcnJvciBpZiB2YWx1ZXMgaXMgZW1wdHkuXG4gKiBAcGFyYW0gb3B0aW9uTmFtZXMgICBNYXBwZWQgb3B0aW9uIG5hbWVzIG9mIG5lZ2F0YWJsZSBvcHRpb25zLlxuICovXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVGbGFncyhcbiAgZmxhZ3M6IElGbGFnT3B0aW9uc1tdLFxuICB2YWx1ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICBfa25vd25GbGFrcz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICBhbGxvd0VtcHR5PzogYm9vbGVhbixcbiAgb3B0aW9uTmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fSxcbik6IHZvaWQge1xuICBjb25zdCBkZWZhdWx0VmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBib29sZWFuPiA9IHt9O1xuXG4gIC8vIFNldCBkZWZhdWx0IHZhbHVlJ3NcbiAgZm9yIChjb25zdCBvcHRpb24gb2YgZmxhZ3MpIHtcbiAgICBsZXQgbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCBkZWZhdWx0VmFsdWU6IHVua25vd24gPSB1bmRlZmluZWQ7XG5cbiAgICAvLyBpZiAtLW5vLVtmbGFnXSBpcyBwcmVzZW50IHNldCAtLVtmbGFnXSBkZWZhdWx0IHZhbHVlIHRvIHRydWVcbiAgICBpZiAob3B0aW9uLm5hbWUuc3RhcnRzV2l0aChcIm5vLVwiKSkge1xuICAgICAgY29uc3QgcHJvcE5hbWUgPSBvcHRpb24ubmFtZS5yZXBsYWNlKC9ebm8tLywgXCJcIik7XG4gICAgICBpZiAocHJvcE5hbWUgaW4gdmFsdWVzKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgcG9zaXRpdmVPcHRpb24gPSBnZXRPcHRpb24oZmxhZ3MsIHByb3BOYW1lKTtcbiAgICAgIGlmIChwb3NpdGl2ZU9wdGlvbikge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIG5hbWUgPSBwYXJhbUNhc2VUb0NhbWVsQ2FzZShwcm9wTmFtZSk7XG4gICAgICBkZWZhdWx0VmFsdWUgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmICghbmFtZSkge1xuICAgICAgbmFtZSA9IHBhcmFtQ2FzZVRvQ2FtZWxDYXNlKG9wdGlvbi5uYW1lKTtcbiAgICB9XG5cbiAgICBpZiAoIShuYW1lIGluIG9wdGlvbk5hbWVzKSkge1xuICAgICAgb3B0aW9uTmFtZXNbbmFtZV0gPSBvcHRpb24ubmFtZTtcbiAgICB9XG5cbiAgICBjb25zdCBoYXNEZWZhdWx0VmFsdWU6IGJvb2xlYW4gPSB0eXBlb2YgdmFsdWVzW25hbWVdID09PSBcInVuZGVmaW5lZFwiICYmIChcbiAgICAgIHR5cGVvZiBvcHRpb24uZGVmYXVsdCAhPT0gXCJ1bmRlZmluZWRcIiB8fFxuICAgICAgdHlwZW9mIGRlZmF1bHRWYWx1ZSAhPT0gXCJ1bmRlZmluZWRcIlxuICAgICk7XG5cbiAgICBpZiAoaGFzRGVmYXVsdFZhbHVlKSB7XG4gICAgICB2YWx1ZXNbbmFtZV0gPSBnZXREZWZhdWx0VmFsdWUob3B0aW9uKSA/PyBkZWZhdWx0VmFsdWU7XG4gICAgICBkZWZhdWx0VmFsdWVzW29wdGlvbi5uYW1lXSA9IHRydWU7XG4gICAgICBpZiAodHlwZW9mIG9wdGlvbi52YWx1ZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIHZhbHVlc1tuYW1lXSA9IG9wdGlvbi52YWx1ZSh2YWx1ZXNbbmFtZV0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZXMpO1xuXG4gIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiBhbGxvd0VtcHR5KSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qgb3B0aW9uczogSUZsYWdPcHRpb25zTWFwW10gPSBrZXlzLm1hcCgobmFtZSkgPT4gKHtcbiAgICBuYW1lLFxuICAgIG9wdGlvbjogZ2V0T3B0aW9uKGZsYWdzLCBvcHRpb25OYW1lc1tuYW1lXSksXG4gIH0pKTtcblxuICBmb3IgKGNvbnN0IHsgbmFtZSwgb3B0aW9uIH0gb2Ygb3B0aW9ucykge1xuICAgIGlmICghb3B0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgVW5rbm93bk9wdGlvbihuYW1lLCBmbGFncyk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbi5zdGFuZGFsb25lKSB7XG4gICAgICBpZiAoa2V5cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIC8vIGRvbid0IHRocm93IGFuIGVycm9yIGlmIGFsbCB2YWx1ZXMgYXJlIGNvbWluZyBmcm9tIHRoZSBkZWZhdWx0IG9wdGlvbi5cbiAgICAgICAgaWYgKFxuICAgICAgICAgIG9wdGlvbnMuZXZlcnkoKHsgb3B0aW9uOiBvcHQgfSkgPT5cbiAgICAgICAgICAgIG9wdCAmJlxuICAgICAgICAgICAgKG9wdGlvbiA9PT0gb3B0IHx8IGRlZmF1bHRWYWx1ZXNbb3B0Lm5hbWVdKVxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhyb3cgbmV3IE9wdGlvbk5vdENvbWJpbmFibGUob3B0aW9uLm5hbWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIG9wdGlvbi5jb25mbGljdHM/LmZvckVhY2goKGZsYWc6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKGlzc2V0KGZsYWcsIHZhbHVlcykpIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0aW5nT3B0aW9uKG9wdGlvbi5uYW1lLCBmbGFnKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIG9wdGlvbi5kZXBlbmRzPy5mb3JFYWNoKChmbGFnOiBzdHJpbmcpID0+IHtcbiAgICAgIC8vIGRvbid0IHRocm93IGFuIGVycm9yIGlmIHRoZSB2YWx1ZSBpcyBjb21pbmcgZnJvbSB0aGUgZGVmYXVsdCBvcHRpb24uXG4gICAgICBpZiAoIWlzc2V0KGZsYWcsIHZhbHVlcykgJiYgIWRlZmF1bHRWYWx1ZXNbb3B0aW9uLm5hbWVdKSB7XG4gICAgICAgIHRocm93IG5ldyBEZXBlbmRpbmdPcHRpb24ob3B0aW9uLm5hbWUsIGZsYWcpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgaXNBcnJheSA9IChvcHRpb24uYXJncz8ubGVuZ3RoIHx8IDApID4gMTtcblxuICAgIG9wdGlvbi5hcmdzPy5mb3JFYWNoKChhcmc6IElGbGFnQXJndW1lbnQsIGk6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBhcmcucmVxdWlyZWRWYWx1ZSAmJlxuICAgICAgICAoXG4gICAgICAgICAgdHlwZW9mIHZhbHVlc1tuYW1lXSA9PT0gXCJ1bmRlZmluZWRcIiB8fFxuICAgICAgICAgIChpc0FycmF5ICYmXG4gICAgICAgICAgICB0eXBlb2YgKHZhbHVlc1tuYW1lXSBhcyBBcnJheTx1bmtub3duPilbaV0gPT09IFwidW5kZWZpbmVkXCIpXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgTWlzc2luZ09wdGlvblZhbHVlKG9wdGlvbi5uYW1lKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGZvciAoY29uc3Qgb3B0aW9uIG9mIGZsYWdzKSB7XG4gICAgaWYgKG9wdGlvbi5yZXF1aXJlZCAmJiAhKHBhcmFtQ2FzZVRvQ2FtZWxDYXNlKG9wdGlvbi5uYW1lKSBpbiB2YWx1ZXMpKSB7XG4gICAgICBpZiAoXG4gICAgICAgIChcbiAgICAgICAgICAhb3B0aW9uLmNvbmZsaWN0cyB8fFxuICAgICAgICAgICFvcHRpb24uY29uZmxpY3RzLmZpbmQoKGZsYWc6IHN0cmluZykgPT4gISF2YWx1ZXNbZmxhZ10pXG4gICAgICAgICkgJiZcbiAgICAgICAgIW9wdGlvbnMuZmluZCgob3B0KSA9PlxuICAgICAgICAgIG9wdC5vcHRpb24/LmNvbmZsaWN0cz8uZmluZCgoZmxhZzogc3RyaW5nKSA9PiBmbGFnID09PSBvcHRpb24ubmFtZSlcbiAgICAgICAgKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBNaXNzaW5nUmVxdWlyZWRPcHRpb24ob3B0aW9uLm5hbWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiAhYWxsb3dFbXB0eSkge1xuICAgIHRocm93IG5ldyBOb0FyZ3VtZW50cygpO1xuICB9XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgdmFsdWUgZXhpc3RzIGZvciBmbGFnLlxuICogQHBhcmFtIGZsYWcgICAgRmxhZyBuYW1lLlxuICogQHBhcmFtIHZhbHVlcyAgUGFyc2VkIHZhbHVlcy5cbiAqL1xuZnVuY3Rpb24gaXNzZXQoZmxhZzogc3RyaW5nLCB2YWx1ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KTogYm9vbGVhbiB7XG4gIGNvbnN0IG5hbWUgPSBwYXJhbUNhc2VUb0NhbWVsQ2FzZShmbGFnKTtcbiAgLy8gcmV0dXJuIHR5cGVvZiB2YWx1ZXNbIG5hbWUgXSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWVzWyBuYW1lIF0gIT09IGZhbHNlO1xuICByZXR1cm4gdHlwZW9mIHZhbHVlc1tuYW1lXSAhPT0gXCJ1bmRlZmluZWRcIjtcbn1cbiJdfQ==