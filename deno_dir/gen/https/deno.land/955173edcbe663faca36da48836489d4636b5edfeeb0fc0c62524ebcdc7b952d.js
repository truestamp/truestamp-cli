export class ZshCompletionsGenerator {
    cmd;
    actions = new Map();
    static generate(cmd) {
        return new ZshCompletionsGenerator(cmd).generate();
    }
    constructor(cmd) {
        this.cmd = cmd;
    }
    generate() {
        const path = this.cmd.getPath();
        const name = this.cmd.getName();
        const version = this.cmd.getVersion()
            ? ` v${this.cmd.getVersion()}`
            : "";
        return `#!/usr/bin/env zsh
# zsh completion support for ${path}${version}

autoload -U is-at-least

# shellcheck disable=SC2154
(( $+functions[__${replaceSpecialChars(name)}_complete] )) ||
function __${replaceSpecialChars(name)}_complete {
  local name="$1"; shift
  local action="$1"; shift
  integer ret=1
  local -a values
  local expl lines
  _tags "$name"
  while _tags; do
    if _requested "$name"; then
      # shellcheck disable=SC2034
      lines="$(${name} completions complete "\${action}" "\${@}")"
      values=("\${(ps:\\n:)lines}")
      if (( \${#values[@]} )); then
        while _next_label "$name" expl "$action"; do
          compadd -S '' "\${expl[@]}" "\${values[@]}"
        done
      fi
    fi
  done
}

${this.generateCompletions(this.cmd).trim()}

# _${replaceSpecialChars(path)} "\${@}"

compdef _${replaceSpecialChars(path)} ${path}`;
    }
    generateCompletions(command, path = "") {
        if (!command.hasCommands(false) && !command.hasOptions(false) &&
            !command.hasArguments()) {
            return "";
        }
        path = (path ? path + " " : "") + command.getName();
        return `# shellcheck disable=SC2154
(( $+functions[_${replaceSpecialChars(path)}] )) ||
function _${replaceSpecialChars(path)}() {` +
            (!command.getParent()
                ? `
  local state`
                : "") +
            this.generateCommandCompletions(command, path) +
            this.generateSubCommandCompletions(command, path) +
            this.generateArgumentCompletions(command, path) +
            this.generateActions(command) +
            `\n}\n\n` +
            command.getCommands(false)
                .filter((subCommand) => subCommand !== command)
                .map((subCommand) => this.generateCompletions(subCommand, path))
                .join("");
    }
    generateCommandCompletions(command, path) {
        const commands = command.getCommands(false);
        let completions = commands
            .map((subCommand) => `'${subCommand.getName()}:${subCommand.getShortDescription()}'`)
            .join("\n      ");
        if (completions) {
            completions = `
    local -a commands
    # shellcheck disable=SC2034
    commands=(
      ${completions}
    )
    _describe 'command' commands`;
        }
        if (command.hasArguments()) {
            const completionsPath = path.split(" ").slice(1).join(" ");
            const arg = command.getArguments()[0];
            const action = this.addAction(arg, completionsPath);
            if (action && command.getCompletion(arg.action)) {
                completions += `\n    __${replaceSpecialChars(this.cmd.getName())}_complete ${action.arg.name} ${action.arg.action} ${action.cmd}`;
            }
        }
        if (completions) {
            completions = `\n\n  function _commands() {${completions}\n  }`;
        }
        return completions;
    }
    generateSubCommandCompletions(command, path) {
        if (command.hasCommands(false)) {
            const actions = command
                .getCommands(false)
                .map((command) => `${command.getName()}) _${replaceSpecialChars(path + " " + command.getName())} ;;`)
                .join("\n      ");
            return `\n
  function _command_args() {
    case "\${words[1]}" in\n      ${actions}\n    esac
  }`;
        }
        return "";
    }
    generateArgumentCompletions(command, path) {
        this.actions.clear();
        const options = this.generateOptions(command, path);
        let argIndex = 0;
        let argsCommand = "\n\n  _arguments -w -s -S -C";
        if (command.hasOptions()) {
            argsCommand += ` \\\n    ${options.join(" \\\n    ")}`;
        }
        if (command.hasCommands(false) || (command.getArguments()
            .filter((arg) => command.getCompletion(arg.action)).length)) {
            argsCommand += ` \\\n    '${++argIndex}: :_commands'`;
        }
        if (command.hasArguments() || command.hasCommands(false)) {
            const args = [];
            for (const arg of command.getArguments().slice(1)) {
                const completionsPath = path.split(" ").slice(1).join(" ");
                const action = this.addAction(arg, completionsPath);
                args.push(`${++argIndex}${arg.optionalValue ? "::" : ":"}${action.name}`);
            }
            argsCommand += args.map((arg) => `\\\n    '${arg}'`).join("");
            if (command.hasCommands(false)) {
                argsCommand += ` \\\n    '*:: :->command_args'`;
            }
        }
        return argsCommand;
    }
    generateOptions(command, path) {
        const options = [];
        const cmdArgs = path.split(" ");
        const _baseName = cmdArgs.shift();
        const completionsPath = cmdArgs.join(" ");
        const excludedFlags = command.getOptions(false)
            .map((option) => option.standalone ? option.flags : false)
            .flat()
            .filter((flag) => typeof flag === "string");
        for (const option of command.getOptions(false)) {
            options.push(this.generateOption(option, completionsPath, excludedFlags));
        }
        return options;
    }
    generateOption(option, completionsPath, excludedOptions) {
        const flags = option.flags;
        let excludedFlags = option.conflicts?.length
            ? [
                ...excludedOptions,
                ...option.conflicts.map((opt) => "--" + opt.replace(/^--/, "")),
            ]
            : excludedOptions;
        excludedFlags = option.collect ? excludedFlags : [
            ...excludedFlags,
            ...flags,
        ];
        let args = "";
        for (const arg of option.args) {
            const action = this.addAction(arg, completionsPath);
            if (arg.variadic) {
                args += `${arg.optionalValue ? "::" : ":"}${arg.name}:->${action.name}`;
            }
            else {
                args += `${arg.optionalValue ? "::" : ":"}${arg.name}:->${action.name}`;
            }
        }
        let description = option.description
            .trim()
            .split("\n")
            .shift();
        description = description
            .replace(/\[/g, "\\[")
            .replace(/]/g, "\\]")
            .replace(/"/g, '\\"')
            .replace(/'/g, "'\"'\"'");
        const collect = option.collect ? "*" : "";
        if (option.standalone) {
            return `'(- *)'{${collect}${flags}}'[${description}]${args}'`;
        }
        else {
            const excluded = excludedFlags.length
                ? `'(${excludedFlags.join(" ")})'`
                : "";
            if (collect || flags.length > 1) {
                return `${excluded}{${collect}${flags}}'[${description}]${args}'`;
            }
            else {
                return `${excluded}${flags}'[${description}]${args}'`;
            }
        }
    }
    addAction(arg, cmd) {
        const action = `${arg.name}-${arg.action}`;
        if (!this.actions.has(action)) {
            this.actions.set(action, {
                arg: arg,
                label: `${arg.name}: ${arg.action}`,
                name: action,
                cmd,
            });
        }
        return this.actions.get(action);
    }
    generateActions(command) {
        let actions = [];
        if (this.actions.size) {
            actions = Array
                .from(this.actions)
                .map(([name, action]) => `${name}) __${replaceSpecialChars(this.cmd.getName())}_complete ${action.arg.name} ${action.arg.action} ${action.cmd} ;;`);
        }
        if (command.hasCommands(false)) {
            actions.unshift(`command_args) _command_args ;;`);
        }
        if (actions.length) {
            return `\n\n  case "$state" in\n    ${actions.join("\n    ")}\n  esac`;
        }
        return "";
    }
}
function replaceSpecialChars(str) {
    return str.replace(/[^a-zA-Z0-9]/g, "_");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX3pzaF9jb21wbGV0aW9uc19nZW5lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJfenNoX2NvbXBsZXRpb25zX2dlbmVyYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFXQSxNQUFNLE9BQU8sdUJBQXVCO0lBUUo7SUFQdEIsT0FBTyxHQUFtQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBR3JELE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBWTtRQUNqQyxPQUFPLElBQUksdUJBQXVCLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDckQsQ0FBQztJQUVELFlBQThCLEdBQVk7UUFBWixRQUFHLEdBQUgsR0FBRyxDQUFTO0lBQUcsQ0FBQztJQUd0QyxRQUFRO1FBQ2QsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNoQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2hDLE1BQU0sT0FBTyxHQUF1QixJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRTtZQUN2RCxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQzlCLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFFUCxPQUFPOytCQUNvQixJQUFJLEdBQUcsT0FBTzs7Ozs7bUJBSzFCLG1CQUFtQixDQUFDLElBQUksQ0FBQzthQUMvQixtQkFBbUIsQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7Ozs7aUJBVXJCLElBQUk7Ozs7Ozs7Ozs7O0VBV25CLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFOztLQUV0QyxtQkFBbUIsQ0FBQyxJQUFJLENBQUM7O1dBRW5CLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFHTyxtQkFBbUIsQ0FBQyxP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QUFDLElBQUksRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFFLENBQ3RCLEdBQUcsSUFBSSxPQUNMLG1CQUFtQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQ3hDLGFBQWEsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUNyRSxDQUFDO1NBQ0w7UUFFRCxJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDOUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1NBQ25EO1FBRUQsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2xCLE9BQU8sK0JBQStCLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztTQUN4RTtRQUVELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztDQUNGO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxHQUFXO0lBQ3RDLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDM0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQ29tbWFuZCB9IGZyb20gXCIuLi9jb21tYW5kLnRzXCI7XG5pbXBvcnQgdHlwZSB7IElBcmd1bWVudCwgSU9wdGlvbiB9IGZyb20gXCIuLi90eXBlcy50c1wiO1xuXG5pbnRlcmZhY2UgSUNvbXBsZXRpb25BY3Rpb24ge1xuICBhcmc6IElBcmd1bWVudDtcbiAgbGFiZWw6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xuICBjbWQ6IHN0cmluZztcbn1cblxuLyoqIEdlbmVyYXRlcyB6c2ggY29tcGxldGlvbnMgc2NyaXB0LiAqL1xuZXhwb3J0IGNsYXNzIFpzaENvbXBsZXRpb25zR2VuZXJhdG9yIHtcbiAgcHJpdmF0ZSBhY3Rpb25zOiBNYXA8c3RyaW5nLCBJQ29tcGxldGlvbkFjdGlvbj4gPSBuZXcgTWFwKCk7XG5cbiAgLyoqIEdlbmVyYXRlcyB6c2ggY29tcGxldGlvbnMgc2NyaXB0IGZvciBnaXZlbiBjb21tYW5kLiAqL1xuICBwdWJsaWMgc3RhdGljIGdlbmVyYXRlKGNtZDogQ29tbWFuZCkge1xuICAgIHJldHVybiBuZXcgWnNoQ29tcGxldGlvbnNHZW5lcmF0b3IoY21kKS5nZW5lcmF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgY21kOiBDb21tYW5kKSB7fVxuXG4gIC8qKiBHZW5lcmF0ZXMgenNoIGNvbXBsZXRpb25zIGNvZGUuICovXG4gIHByaXZhdGUgZ2VuZXJhdGUoKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYXRoID0gdGhpcy5jbWQuZ2V0UGF0aCgpO1xuICAgIGNvbnN0IG5hbWUgPSB0aGlzLmNtZC5nZXROYW1lKCk7XG4gICAgY29uc3QgdmVyc2lvbjogc3RyaW5nIHwgdW5kZWZpbmVkID0gdGhpcy5jbWQuZ2V0VmVyc2lvbigpXG4gICAgICA/IGAgdiR7dGhpcy5jbWQuZ2V0VmVyc2lvbigpfWBcbiAgICAgIDogXCJcIjtcblxuICAgIHJldHVybiBgIyEvdXNyL2Jpbi9lbnYgenNoXG4jIHpzaCBjb21wbGV0aW9uIHN1cHBvcnQgZm9yICR7cGF0aH0ke3ZlcnNpb259XG5cbmF1dG9sb2FkIC1VIGlzLWF0LWxlYXN0XG5cbiMgc2hlbGxjaGVjayBkaXNhYmxlPVNDMjE1NFxuKCggJCtmdW5jdGlvbnNbX18ke3JlcGxhY2VTcGVjaWFsQ2hhcnMobmFtZSl9X2NvbXBsZXRlXSApKSB8fFxuZnVuY3Rpb24gX18ke3JlcGxhY2VTcGVjaWFsQ2hhcnMobmFtZSl9X2NvbXBsZXRlIHtcbiAgbG9jYWwgbmFtZT1cIiQxXCI7IHNoaWZ0XG4gIGxvY2FsIGFjdGlvbj1cIiQxXCI7IHNoaWZ0XG4gIGludGVnZXIgcmV0PTFcbiAgbG9jYWwgLWEgdmFsdWVzXG4gIGxvY2FsIGV4cGwgbGluZXNcbiAgX3RhZ3MgXCIkbmFtZVwiXG4gIHdoaWxlIF90YWdzOyBkb1xuICAgIGlmIF9yZXF1ZXN0ZWQgXCIkbmFtZVwiOyB0aGVuXG4gICAgICAjIHNoZWxsY2hlY2sgZGlzYWJsZT1TQzIwMzRcbiAgICAgIGxpbmVzPVwiJCgke25hbWV9IGNvbXBsZXRpb25zIGNvbXBsZXRlIFwiXFwke2FjdGlvbn1cIiBcIlxcJHtAfVwiKVwiXG4gICAgICB2YWx1ZXM9KFwiXFwkeyhwczpcXFxcbjopbGluZXN9XCIpXG4gICAgICBpZiAoKCBcXCR7I3ZhbHVlc1tAXX0gKSk7IHRoZW5cbiAgICAgICAgd2hpbGUgX25leHRfbGFiZWwgXCIkbmFtZVwiIGV4cGwgXCIkYWN0aW9uXCI7IGRvXG4gICAgICAgICAgY29tcGFkZCAtUyAnJyBcIlxcJHtleHBsW0BdfVwiIFwiXFwke3ZhbHVlc1tAXX1cIlxuICAgICAgICBkb25lXG4gICAgICBmaVxuICAgIGZpXG4gIGRvbmVcbn1cblxuJHt0aGlzLmdlbmVyYXRlQ29tcGxldGlvbnModGhpcy5jbWQpLnRyaW0oKX1cblxuIyBfJHtyZXBsYWNlU3BlY2lhbENoYXJzKHBhdGgpfSBcIlxcJHtAfVwiXG5cbmNvbXBkZWYgXyR7cmVwbGFjZVNwZWNpYWxDaGFycyhwYXRoKX0gJHtwYXRofWA7XG4gIH1cblxuICAvKiogR2VuZXJhdGVzIHpzaCBjb21wbGV0aW9ucyBtZXRob2QgZm9yIGdpdmVuIGNvbW1hbmQgYW5kIGNoaWxkIGNvbW1hbmRzLiAqL1xuICBwcml2YXRlIGdlbmVyYXRlQ29tcGxldGlvbnMoY29tbWFuZDogQ29tbWFuZCwgcGF0aCA9IFwiXCIpOiBzdHJpbmcge1xuICAgIGlmIChcbiAgICAgICFjb21tYW5kLmhhc0NvbW1hbmRzKGZhbHNlKSAmJiAhY29tbWFuZC5oYXNPcHRpb25zKGZhbHNlKSAmJlxuICAgICAgIWNvbW1hbmQuaGFzQXJndW1lbnRzKClcbiAgICApIHtcbiAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIHBhdGggPSAocGF0aCA/IHBhdGggKyBcIiBcIiA6IFwiXCIpICsgY29tbWFuZC5nZXROYW1lKCk7XG5cbiAgICByZXR1cm4gYCMgc2hlbGxjaGVjayBkaXNhYmxlPVNDMjE1NFxuKCggJCtmdW5jdGlvbnNbXyR7cmVwbGFjZVNwZWNpYWxDaGFycyhwYXRoKX1dICkpIHx8XG5mdW5jdGlvbiBfJHtyZXBsYWNlU3BlY2lhbENoYXJzKHBhdGgpfSgpIHtgICtcbiAgICAgICghY29tbWFuZC5nZXRQYXJlbnQoKVxuICAgICAgICA/IGBcbiAgbG9jYWwgc3RhdGVgXG4gICAgICAgIDogXCJcIikgK1xuICAgICAgdGhpcy5nZW5lcmF0ZUNvbW1hbmRDb21wbGV0aW9ucyhjb21tYW5kLCBwYXRoKSArXG4gICAgICB0aGlzLmdlbmVyYXRlU3ViQ29tbWFuZENvbXBsZXRpb25zKGNvbW1hbmQsIHBhdGgpICtcbiAgICAgIHRoaXMuZ2VuZXJhdGVBcmd1bWVudENvbXBsZXRpb25zKGNvbW1hbmQsIHBhdGgpICtcbiAgICAgIHRoaXMuZ2VuZXJhdGVBY3Rpb25zKGNvbW1hbmQpICtcbiAgICAgIGBcXG59XFxuXFxuYCArXG4gICAgICBjb21tYW5kLmdldENvbW1hbmRzKGZhbHNlKVxuICAgICAgICAuZmlsdGVyKChzdWJDb21tYW5kOiBDb21tYW5kKSA9PiBzdWJDb21tYW5kICE9PSBjb21tYW5kKVxuICAgICAgICAubWFwKChzdWJDb21tYW5kOiBDb21tYW5kKSA9PlxuICAgICAgICAgIHRoaXMuZ2VuZXJhdGVDb21wbGV0aW9ucyhzdWJDb21tYW5kLCBwYXRoKVxuICAgICAgICApXG4gICAgICAgIC5qb2luKFwiXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZUNvbW1hbmRDb21wbGV0aW9ucyhjb21tYW5kOiBDb21tYW5kLCBwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGNvbW1hbmRzID0gY29tbWFuZC5nZXRDb21tYW5kcyhmYWxzZSk7XG5cbiAgICBsZXQgY29tcGxldGlvbnM6IHN0cmluZyA9IGNvbW1hbmRzXG4gICAgICAubWFwKChzdWJDb21tYW5kOiBDb21tYW5kKSA9PlxuICAgICAgICBgJyR7c3ViQ29tbWFuZC5nZXROYW1lKCl9OiR7c3ViQ29tbWFuZC5nZXRTaG9ydERlc2NyaXB0aW9uKCl9J2BcbiAgICAgIClcbiAgICAgIC5qb2luKFwiXFxuICAgICAgXCIpO1xuXG4gICAgaWYgKGNvbXBsZXRpb25zKSB7XG4gICAgICBjb21wbGV0aW9ucyA9IGBcbiAgICBsb2NhbCAtYSBjb21tYW5kc1xuICAgICMgc2hlbGxjaGVjayBkaXNhYmxlPVNDMjAzNFxuICAgIGNvbW1hbmRzPShcbiAgICAgICR7Y29tcGxldGlvbnN9XG4gICAgKVxuICAgIF9kZXNjcmliZSAnY29tbWFuZCcgY29tbWFuZHNgO1xuICAgIH1cblxuICAgIGlmIChjb21tYW5kLmhhc0FyZ3VtZW50cygpKSB7XG4gICAgICBjb25zdCBjb21wbGV0aW9uc1BhdGg6IHN0cmluZyA9IHBhdGguc3BsaXQoXCIgXCIpLnNsaWNlKDEpLmpvaW4oXCIgXCIpO1xuICAgICAgLy8gQFRPRE86IHN1cHBvcnQgbXVsdGlwbGUgYXJndW1lbnRzIHpzaCBjb21wbGV0aW9uc1xuICAgICAgY29uc3QgYXJnOiBJQXJndW1lbnQgPSBjb21tYW5kLmdldEFyZ3VtZW50cygpWzBdO1xuICAgICAgY29uc3QgYWN0aW9uID0gdGhpcy5hZGRBY3Rpb24oYXJnLCBjb21wbGV0aW9uc1BhdGgpO1xuICAgICAgaWYgKGFjdGlvbiAmJiBjb21tYW5kLmdldENvbXBsZXRpb24oYXJnLmFjdGlvbikpIHtcbiAgICAgICAgY29tcGxldGlvbnMgKz0gYFxcbiAgICBfXyR7XG4gICAgICAgICAgcmVwbGFjZVNwZWNpYWxDaGFycyh0aGlzLmNtZC5nZXROYW1lKCkpXG4gICAgICAgIH1fY29tcGxldGUgJHthY3Rpb24uYXJnLm5hbWV9ICR7YWN0aW9uLmFyZy5hY3Rpb259ICR7YWN0aW9uLmNtZH1gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjb21wbGV0aW9ucykge1xuICAgICAgY29tcGxldGlvbnMgPSBgXFxuXFxuICBmdW5jdGlvbiBfY29tbWFuZHMoKSB7JHtjb21wbGV0aW9uc31cXG4gIH1gO1xuICAgIH1cblxuICAgIHJldHVybiBjb21wbGV0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVTdWJDb21tYW5kQ29tcGxldGlvbnMoXG4gICAgY29tbWFuZDogQ29tbWFuZCxcbiAgICBwYXRoOiBzdHJpbmcsXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKGNvbW1hbmQuaGFzQ29tbWFuZHMoZmFsc2UpKSB7XG4gICAgICBjb25zdCBhY3Rpb25zOiBzdHJpbmcgPSBjb21tYW5kXG4gICAgICAgIC5nZXRDb21tYW5kcyhmYWxzZSlcbiAgICAgICAgLm1hcCgoY29tbWFuZDogQ29tbWFuZCkgPT5cbiAgICAgICAgICBgJHtjb21tYW5kLmdldE5hbWUoKX0pIF8ke1xuICAgICAgICAgICAgcmVwbGFjZVNwZWNpYWxDaGFycyhwYXRoICsgXCIgXCIgKyBjb21tYW5kLmdldE5hbWUoKSlcbiAgICAgICAgICB9IDs7YFxuICAgICAgICApXG4gICAgICAgIC5qb2luKFwiXFxuICAgICAgXCIpO1xuXG4gICAgICByZXR1cm4gYFxcblxuICBmdW5jdGlvbiBfY29tbWFuZF9hcmdzKCkge1xuICAgIGNhc2UgXCJcXCR7d29yZHNbMV19XCIgaW5cXG4gICAgICAke2FjdGlvbnN9XFxuICAgIGVzYWNcbiAgfWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlQXJndW1lbnRDb21wbGV0aW9ucyhjb21tYW5kOiBDb21tYW5kLCBwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8qIGNsZWFyIGFjdGlvbnMgZnJvbSBwcmV2aW91c2x5IHBhcnNlZCBjb21tYW5kLiAqL1xuICAgIHRoaXMuYWN0aW9ucy5jbGVhcigpO1xuXG4gICAgY29uc3Qgb3B0aW9uczogc3RyaW5nW10gPSB0aGlzLmdlbmVyYXRlT3B0aW9ucyhjb21tYW5kLCBwYXRoKTtcblxuICAgIGxldCBhcmdJbmRleCA9IDA7XG4gICAgLy8gQFRPRE86IGFkZCBzdG9wIGVhcmx5IG9wdGlvbjogLUEgXCItKlwiXG4gICAgLy8gaHR0cDovL3pzaC5zb3VyY2Vmb3JnZS5uZXQvRG9jL1JlbGVhc2UvQ29tcGxldGlvbi1TeXN0ZW0uaHRtbFxuICAgIGxldCBhcmdzQ29tbWFuZCA9IFwiXFxuXFxuICBfYXJndW1lbnRzIC13IC1zIC1TIC1DXCI7XG5cbiAgICBpZiAoY29tbWFuZC5oYXNPcHRpb25zKCkpIHtcbiAgICAgIGFyZ3NDb21tYW5kICs9IGAgXFxcXFxcbiAgICAke29wdGlvbnMuam9pbihcIiBcXFxcXFxuICAgIFwiKX1gO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIGNvbW1hbmQuaGFzQ29tbWFuZHMoZmFsc2UpIHx8IChcbiAgICAgICAgY29tbWFuZC5nZXRBcmd1bWVudHMoKVxuICAgICAgICAgIC5maWx0ZXIoKGFyZykgPT4gY29tbWFuZC5nZXRDb21wbGV0aW9uKGFyZy5hY3Rpb24pKS5sZW5ndGhcbiAgICAgIClcbiAgICApIHtcbiAgICAgIGFyZ3NDb21tYW5kICs9IGAgXFxcXFxcbiAgICAnJHsrK2FyZ0luZGV4fTogOl9jb21tYW5kcydgO1xuICAgIH1cblxuICAgIGlmIChjb21tYW5kLmhhc0FyZ3VtZW50cygpIHx8IGNvbW1hbmQuaGFzQ29tbWFuZHMoZmFsc2UpKSB7XG4gICAgICBjb25zdCBhcmdzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICBmb3IgKGNvbnN0IGFyZyBvZiBjb21tYW5kLmdldEFyZ3VtZW50cygpLnNsaWNlKDEpKSB7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRpb25zUGF0aDogc3RyaW5nID0gcGF0aC5zcGxpdChcIiBcIikuc2xpY2UoMSkuam9pbihcIiBcIik7XG5cbiAgICAgICAgY29uc3QgYWN0aW9uID0gdGhpcy5hZGRBY3Rpb24oYXJnLCBjb21wbGV0aW9uc1BhdGgpO1xuXG4gICAgICAgIGFyZ3MucHVzaChcbiAgICAgICAgICBgJHsrK2FyZ0luZGV4fSR7YXJnLm9wdGlvbmFsVmFsdWUgPyBcIjo6XCIgOiBcIjpcIn0ke2FjdGlvbi5uYW1lfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGFyZ3NDb21tYW5kICs9IGFyZ3MubWFwKChhcmc6IHN0cmluZykgPT4gYFxcXFxcXG4gICAgJyR7YXJnfSdgKS5qb2luKFwiXCIpO1xuXG4gICAgICBpZiAoY29tbWFuZC5oYXNDb21tYW5kcyhmYWxzZSkpIHtcbiAgICAgICAgYXJnc0NvbW1hbmQgKz0gYCBcXFxcXFxuICAgICcqOjogOi0+Y29tbWFuZF9hcmdzJ2A7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGFyZ3NDb21tYW5kO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU9wdGlvbnMoY29tbWFuZDogQ29tbWFuZCwgcGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3B0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBjbWRBcmdzOiBzdHJpbmdbXSA9IHBhdGguc3BsaXQoXCIgXCIpO1xuICAgIGNvbnN0IF9iYXNlTmFtZTogc3RyaW5nID0gY21kQXJncy5zaGlmdCgpIGFzIHN0cmluZztcbiAgICBjb25zdCBjb21wbGV0aW9uc1BhdGg6IHN0cmluZyA9IGNtZEFyZ3Muam9pbihcIiBcIik7XG5cbiAgICBjb25zdCBleGNsdWRlZEZsYWdzOiBzdHJpbmdbXSA9IGNvbW1hbmQuZ2V0T3B0aW9ucyhmYWxzZSlcbiAgICAgIC5tYXAoKG9wdGlvbikgPT4gb3B0aW9uLnN0YW5kYWxvbmUgPyBvcHRpb24uZmxhZ3MgOiBmYWxzZSlcbiAgICAgIC5mbGF0KClcbiAgICAgIC5maWx0ZXIoKGZsYWcpID0+IHR5cGVvZiBmbGFnID09PSBcInN0cmluZ1wiKSBhcyBzdHJpbmdbXTtcblxuICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIGNvbW1hbmQuZ2V0T3B0aW9ucyhmYWxzZSkpIHtcbiAgICAgIG9wdGlvbnMucHVzaCh0aGlzLmdlbmVyYXRlT3B0aW9uKG9wdGlvbiwgY29tcGxldGlvbnNQYXRoLCBleGNsdWRlZEZsYWdzKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9wdGlvbnM7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlT3B0aW9uKFxuICAgIG9wdGlvbjogSU9wdGlvbixcbiAgICBjb21wbGV0aW9uc1BhdGg6IHN0cmluZyxcbiAgICBleGNsdWRlZE9wdGlvbnM6IHN0cmluZ1tdLFxuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IGZsYWdzID0gb3B0aW9uLmZsYWdzO1xuICAgIGxldCBleGNsdWRlZEZsYWdzID0gb3B0aW9uLmNvbmZsaWN0cz8ubGVuZ3RoXG4gICAgICA/IFtcbiAgICAgICAgLi4uZXhjbHVkZWRPcHRpb25zLFxuICAgICAgICAuLi5vcHRpb24uY29uZmxpY3RzLm1hcCgob3B0KSA9PiBcIi0tXCIgKyBvcHQucmVwbGFjZSgvXi0tLywgXCJcIikpLFxuICAgICAgXVxuICAgICAgOiBleGNsdWRlZE9wdGlvbnM7XG4gICAgZXhjbHVkZWRGbGFncyA9IG9wdGlvbi5jb2xsZWN0ID8gZXhjbHVkZWRGbGFncyA6IFtcbiAgICAgIC4uLmV4Y2x1ZGVkRmxhZ3MsXG4gICAgICAuLi5mbGFncyxcbiAgICBdO1xuXG4gICAgbGV0IGFyZ3MgPSBcIlwiO1xuICAgIGZvciAoY29uc3QgYXJnIG9mIG9wdGlvbi5hcmdzKSB7XG4gICAgICBjb25zdCBhY3Rpb24gPSB0aGlzLmFkZEFjdGlvbihhcmcsIGNvbXBsZXRpb25zUGF0aCk7XG5cbiAgICAgIGlmIChhcmcudmFyaWFkaWMpIHtcbiAgICAgICAgYXJncyArPSBgJHthcmcub3B0aW9uYWxWYWx1ZSA/IFwiOjpcIiA6IFwiOlwifSR7YXJnLm5hbWV9Oi0+JHthY3Rpb24ubmFtZX1gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXJncyArPSBgJHthcmcub3B0aW9uYWxWYWx1ZSA/IFwiOjpcIiA6IFwiOlwifSR7YXJnLm5hbWV9Oi0+JHthY3Rpb24ubmFtZX1gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCBkZXNjcmlwdGlvbjogc3RyaW5nID0gb3B0aW9uLmRlc2NyaXB0aW9uXG4gICAgICAudHJpbSgpXG4gICAgICAuc3BsaXQoXCJcXG5cIilcbiAgICAgIC5zaGlmdCgpIGFzIHN0cmluZztcblxuICAgIC8vIGVzY2FwZSBicmFja2V0cyBhbmQgcXVvdGVzXG4gICAgZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvblxuICAgICAgLnJlcGxhY2UoL1xcWy9nLCBcIlxcXFxbXCIpXG4gICAgICAucmVwbGFjZSgvXS9nLCBcIlxcXFxdXCIpXG4gICAgICAucmVwbGFjZSgvXCIvZywgJ1xcXFxcIicpXG4gICAgICAucmVwbGFjZSgvJy9nLCBcIidcXFwiJ1xcXCInXCIpO1xuXG4gICAgY29uc3QgY29sbGVjdDogc3RyaW5nID0gb3B0aW9uLmNvbGxlY3QgPyBcIipcIiA6IFwiXCI7XG5cbiAgICBpZiAob3B0aW9uLnN0YW5kYWxvbmUpIHtcbiAgICAgIHJldHVybiBgJygtICopJ3ske2NvbGxlY3R9JHtmbGFnc319J1ske2Rlc2NyaXB0aW9ufV0ke2FyZ3N9J2A7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGV4Y2x1ZGVkOiBzdHJpbmcgPSBleGNsdWRlZEZsYWdzLmxlbmd0aFxuICAgICAgICA/IGAnKCR7ZXhjbHVkZWRGbGFncy5qb2luKFwiIFwiKX0pJ2BcbiAgICAgICAgOiBcIlwiO1xuICAgICAgaWYgKGNvbGxlY3QgfHwgZmxhZ3MubGVuZ3RoID4gMSkge1xuICAgICAgICByZXR1cm4gYCR7ZXhjbHVkZWR9eyR7Y29sbGVjdH0ke2ZsYWdzfX0nWyR7ZGVzY3JpcHRpb259XSR7YXJnc30nYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBgJHtleGNsdWRlZH0ke2ZsYWdzfSdbJHtkZXNjcmlwdGlvbn1dJHthcmdzfSdgO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkQWN0aW9uKGFyZzogSUFyZ3VtZW50LCBjbWQ6IHN0cmluZyk6IElDb21wbGV0aW9uQWN0aW9uIHtcbiAgICBjb25zdCBhY3Rpb24gPSBgJHthcmcubmFtZX0tJHthcmcuYWN0aW9ufWA7XG5cbiAgICBpZiAoIXRoaXMuYWN0aW9ucy5oYXMoYWN0aW9uKSkge1xuICAgICAgdGhpcy5hY3Rpb25zLnNldChhY3Rpb24sIHtcbiAgICAgICAgYXJnOiBhcmcsXG4gICAgICAgIGxhYmVsOiBgJHthcmcubmFtZX06ICR7YXJnLmFjdGlvbn1gLFxuICAgICAgICBuYW1lOiBhY3Rpb24sXG4gICAgICAgIGNtZCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmFjdGlvbnMuZ2V0KGFjdGlvbikgYXMgSUNvbXBsZXRpb25BY3Rpb247XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlQWN0aW9ucyhjb21tYW5kOiBDb21tYW5kKTogc3RyaW5nIHtcbiAgICBsZXQgYWN0aW9uczogc3RyaW5nW10gPSBbXTtcblxuICAgIGlmICh0aGlzLmFjdGlvbnMuc2l6ZSkge1xuICAgICAgYWN0aW9ucyA9IEFycmF5XG4gICAgICAgIC5mcm9tKHRoaXMuYWN0aW9ucylcbiAgICAgICAgLm1hcCgoW25hbWUsIGFjdGlvbl0pID0+XG4gICAgICAgICAgYCR7bmFtZX0pIF9fJHtcbiAgICAgICAgICAgIHJlcGxhY2VTcGVjaWFsQ2hhcnModGhpcy5jbWQuZ2V0TmFtZSgpKVxuICAgICAgICAgIH1fY29tcGxldGUgJHthY3Rpb24uYXJnLm5hbWV9ICR7YWN0aW9uLmFyZy5hY3Rpb259ICR7YWN0aW9uLmNtZH0gOztgXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGNvbW1hbmQuaGFzQ29tbWFuZHMoZmFsc2UpKSB7XG4gICAgICBhY3Rpb25zLnVuc2hpZnQoYGNvbW1hbmRfYXJncykgX2NvbW1hbmRfYXJncyA7O2ApO1xuICAgIH1cblxuICAgIGlmIChhY3Rpb25zLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGBcXG5cXG4gIGNhc2UgXCIkc3RhdGVcIiBpblxcbiAgICAke2FjdGlvbnMuam9pbihcIlxcbiAgICBcIil9XFxuICBlc2FjYDtcbiAgICB9XG5cbiAgICByZXR1cm4gXCJcIjtcbiAgfVxufVxuXG5mdW5jdGlvbiByZXBsYWNlU3BlY2lhbENoYXJzKHN0cjogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXmEtekEtWjAtOV0vZywgXCJfXCIpO1xufVxuIl19